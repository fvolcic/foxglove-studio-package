"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5534],{31953:(Ns,Xe,v)=>{v.d(Xe,{HL:()=>B,km:()=>Qe,Rh:()=>Re,TD:()=>et,eQ:()=>$e,cS:()=>Ee,wk:()=>qe,CA:()=>je,v$:()=>ot,GT:()=>at,$C:()=>mt,X:()=>Je,ai:()=>S,gl:()=>Te});function y(F,w,z,I,x,m){m[x]=F+1.402*I,m[x+1]=F-.34414*w-.71414*I,m[x+2]=F+1.772*w,m[x+3]=255,m[x+4]=z+1.402*I,m[x+5]=z-.34414*w-.71414*I,m[x+6]=z+1.772*w,m[x+7]=255}function S(F,w,z,I){let x=0,m=0;const M=z*w;for(let D=0;D<=M;D+=2){const k=F[m]-128,G=F[m+1],X=F[m+2]-128,H=F[m+3];y(G,k,H,X,x,I),x+=8,m+=4}}function Te(F,w,z,I){let x=0,m=0;const M=z*w;for(let D=0;D<=M;D+=2){const k=F[m],G=F[m+1]-128,X=F[m+2],H=F[m+3]-128;y(k,G,X,H,x,I),x+=8,m+=4}}function mt(F,w,z,I){let x=0,m=0;for(let M=0;M<w*z;M++){const D=F[x++],k=F[x++],G=F[x++];I[m++]=D,I[m++]=k,I[m++]=G,I[m++]=255}}function Je(F,w,z,I){let x=0,m=0;for(let M=0;M<w*z;M++){const D=F[x++],k=F[x++],G=F[x++],X=F[x++];I[m++]=D,I[m++]=k,I[m++]=G,I[m++]=X}}function Re(F,w,z,I){let x=0,m=0;for(let M=0;M<w*z;M++){const D=F[x++],k=F[x++],G=F[x++],X=F[x++];I[m++]=G,I[m++]=k,I[m++]=D,I[m++]=X}}function Qe(F,w,z,I){let x=0,m=0;for(let M=0;M<w*z;M++){const D=F[x++],k=F[x++],G=F[x++];I[m++]=G,I[m++]=k,I[m++]=D,I[m++]=255}}function je(F,w,z,I,x){const m=new DataView(F.buffer,F.byteOffset);let M=0;for(let D=0;D<w*z*4;D+=4){const k=m.getFloat32(D,!I)*255;x[M++]=k,x[M++]=k,x[M++]=k,x[M++]=255}}function at(F,w,z,I){let x=0,m=0;for(let M=0;M<w*z;M++){const D=F[x++];I[m++]=D,I[m++]=D,I[m++]=D,I[m++]=255}}function ot(F,w,z,I,x,m){const M=new DataView(F.buffer,F.byteOffset),D=m?.minValue??0;let k=m?.maxValue??1e4;k===D&&(k=D+1);let G=0;for(let X=0;X<w*z*2;X+=2){let H=M.getUint16(X,!I);H=(H-D)/(k-D)*255,x[G++]=H,x[G++]=H,x[G++]=H,x[G++]=255}}function Ne(F,w,z,I){return new Function("data","width","height","output",`
  for (let i = 0; i < height / 2; i++) {
    let inIdx = i * 2 * width;
    let outTopIdx = i * 2 * width * 4; // Addresses top row
    let outBottomIdx = (i * 2 + 1) * width * 4; // Addresses bottom row
    for (let j = 0; j < width / 2; j++) {
      const tl = data[inIdx++];
      const tr = data[inIdx++];
      const bl = data[inIdx + width - 2];
      const br = data[inIdx + width - 1];

      const ${F} = tl;
      const ${w} = tr;
      const ${z} = bl;
      const ${I} = br;

      // Top row
      output[outTopIdx++] = r;
      output[outTopIdx++] = g0;
      output[outTopIdx++] = b;
      output[outTopIdx++] = 255;

      output[outTopIdx++] = r;
      output[outTopIdx++] = g0;
      output[outTopIdx++] = b;
      output[outTopIdx++] = 255;

      // Bottom row
      output[outBottomIdx++] = r;
      output[outBottomIdx++] = g1;
      output[outBottomIdx++] = b;
      output[outBottomIdx++] = 255;

      output[outBottomIdx++] = r;
      output[outBottomIdx++] = g1;
      output[outBottomIdx++] = b;
      output[outBottomIdx++] = 255;
    }
  }`)}const qe=Ne("r","g0","g1","b"),et=Ne("b","g0","g1","r"),$e=Ne("g0","b","r","g1"),Ee=Ne("g0","r","b","g1");class B{constructor(w){const{binning_x:z,binning_y:I,roi:x,distortion_model:m,D:M,K:D,P:k,R:G,width:X,height:H}=w,le=k[0],we=k[5];if(X<=0||H<=0)throw new Error(`Invalid image size ${X}x${H}`);if(m.length>0&&m!=="plumb_bob"&&m!=="rational_polynomial")throw new Error(`Unrecognized distortion_model "${m}"`);if(D.length!==0&&D.length!==9)throw new Error(`K.length=${D.length}, expected 9`);if(k.length!==0&&k.length!==12)throw new Error(`P.length=${D.length}, expected 12`);if(G.length!==0&&G.length!==9)throw new Error(`R.length=${G.length}, expected 9`);if(le===0||we===0)throw new Error(`Invalid focal length (fx=${le}, fy=${we})`);const Se=[...M];for(;Se.length<8;)Se.push(0);this.D=Se,this.K=D.length===9?D:[1,0,0,0,1,0,0,0,1],this.P=k.length===12?k:void 0,this.R=G.length===9?G:[1,0,0,0,1,0,0,0,1],this.width=X,this.height=H;const re=z!==0?z:1,ne=I!==0?I:1,gt=re>1||ne>1,Oe=x.x_offset!==0||x.y_offset!==0;if(gt||Oe)throw new Error("Failed to initialize camera model: unable to handle adjusted binning and adjusted roi camera models.")}projectPixelTo3dPlane(w,z){const I=this.P;if(!I)return!1;const x=I[0],m=I[5],M=I[2],D=I[6],k=I[3],G=I[7];return w.x=(z.x-M-k)/x,w.y=(z.y-D-G)/m,w.z=1,!0}projectPixelTo3dRay(w,z){if(!this.projectPixelTo3dPlane(w,z))return!1;const I=1/Math.sqrt(w.x*w.x+w.y*w.y+w.z*w.z);return w.x*=I,w.y*=I,w.z*=I,!0}rectifyPixel(w,z,I=5){if(!this.P)return w.x=z.x,w.y=z.y,w;const{P:x,D:m}=this,[M,D,k,G,X]=m,H=x[0],le=x[5],we=x[2],Se=x[6];let re=(z.x-we)/H,ne=(z.y-Se)/le;const gt=re,Oe=ne,tt=M!==0||D!==0||k!==0||G!==0||X!==0?I:1;for(let Ae=0;Ae<tt;Ae++){const ue=re*re+ne*ne,yt=1/(1+M*ue+D*ue*ue+X*ue*ue*ue),bt=2*k*re*ne+G*(ue+2*re*re),rs=k*(ue+2*ne*ne)+2*G*re*ne;re=(gt-bt)*yt,ne=(Oe-rs)*yt}return w.x=re*H+we,w.y=ne*le+Se,w}unrectifyPixel(w,z){if(!this.P)return w.x=z.x,w.y=z.y,w;const{P:I,R:x,D:m,K:M}=this,D=I[0],k=I[5],G=I[2],X=I[6],H=I[3],le=I[7],we=(z.x-G-H)/D,Se=(z.y-X-le)/k,re=x[0]*we+x[1]*Se+x[2],ne=x[3]*we+x[4]*Se+x[5],gt=x[6]*we+x[7]*Se+x[8],Oe=re/gt,tt=ne/gt,Ae=Oe*Oe+tt*tt,ue=Ae*Ae,yt=ue*Ae,bt=2*Oe*tt,rs=m[0],Li=m[1],Gt=m[2],Os=m[3],Fs=m[4];let as=1+rs*Ae+Li*ue+Fs*yt;as/=1+m[5]*Ae+m[6]*ue+m[7]*yt;const Ri=Oe*as+Gt*bt+Os*(Ae+2*(Oe*Oe)),Ni=tt*as+Gt*(Ae+2*(tt*tt))+Os*bt;return w.x=Ri*M[0]+M[2],w.y=Ni*M[4]+M[5],w}}},14571:(Ns,Xe,v)=>{v.d(Xe,{o:()=>Te});var y=v(52322),S=v(2784);class Te extends S.Component{constructor(){super(...arguments),this.state={hadError:!1}}componentDidCatch(Je){this.setState({hadError:!0}),this.props.onError(Je)}render(){return this.state.hadError?(0,y.jsx)(y.Fragment,{}):this.props.children}}},89820:(Ns,Xe,v)=>{v.d(Xe,{CW:()=>B,KV:()=>Ee,ZP:()=>F});var y=v(52322),S=v(71092),Te=v(65992),mt=v(66198),Je=v(70943),Re=v(45434),Qe=v(72283),je=v(93812),at=v(2784);const ot=240,Ne=(0,Te.ZP)(mt.Z)({fontSize:"1rem !important","& svg:not(.MuiSvgIcon-root)":{fontSize:"1rem !important"}}),qe=(0,Te.ZP)(Je.Z)(({theme:w})=>({minHeight:"auto",minWidth:"auto",padding:w.spacing(1,1.5,1.125),color:w.palette.text.secondary,"&.Mui-selected":{color:w.palette.text.primary}})),et=(0,Te.ZP)(Re.Z)({minHeight:"auto",".MuiTabs-indicator":{transform:"scaleX(0.75)",height:2}}),$e=(0,Te.ZP)("div")(({theme:w})=>({position:"relative",backgroundColor:w.palette.background.default,width:280}));function Ee({children:w}){return w}function B({children:w}){return(0,y.jsx)(je.Z,{padding:1,overflowX:"hidden",overflowY:"auto",style:{maxHeight:ot},children:w})}function F({children:w,checked:z,icon:I,onSelectTab:x,selectedTab:m,tooltip:M,dataTest:D}){if(!(m!=null)){let H=m;return at.Children.forEach(w,le=>{H==null&&(H=le.props.name)}),(0,y.jsx)(Qe.Z,{square:!1,elevation:4,style:{pointerEvents:"auto"},children:(0,y.jsx)(Ne,{color:z===!0?"info":"default",title:M,"data-testid":`ExpandingToolbar-${M}`,onClick:()=>x(H),children:I})})}let G;at.Children.forEach(w,H=>{(!G||H.props.name===m)&&(G=H)});const X=(H,le)=>{le!=null&&x(le)};return(0,y.jsxs)(Qe.Z,{"data-testid":D,square:!1,elevation:4,style:{pointerEvents:"auto"},children:[(0,y.jsx)(Qe.Z,{children:(0,y.jsxs)(je.Z,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[(0,y.jsx)(et,{textColor:"inherit",value:m,onChange:X,children:at.Children.map(w,H=>(0,y.jsx)(qe,{label:H.props.name,value:H.props.name}))}),(0,y.jsx)(Ne,{onClick:()=>x(void 0),children:(0,y.jsx)(S.iRs,{})})]})}),(0,y.jsx)($e,{children:G})]})}},75534:(Ns,Xe,v)=>{v.r(Xe),v.d(Xe,{ImagePanel:()=>xg,ThreeDeePanel:()=>_g});var y=v(52322),S=v(2784),Te=v(28316),mt=v(57051),Je=v(14571),Re=v(14075),Qe=v(591),je=v(69521),at=v(47746),ot=v(66198),Ne=v(77210),qe=v(80078),et=v(83993),$e=v(82056),Ee=v(72283),B=v(76635),F=v(10047),w=v(16003),z=v(8740),I=v(94225),x=v(23503),m=v(44668),M=v(93455),D=v(64380);function k(s){return(0,y.jsx)(D.Z,{...s,children:(0,y.jsxs)("g",{children:[(0,y.jsx)("circle",{cx:"12.03",cy:"18.5",r:"2"}),(0,y.jsx)("path",{d:"M13.28,13.15V5H17L12,0,7.08,5h3.7v8.2a5.5,5.5,0,1,0,2.5,0ZM12,22a3.5,3.5,0,1,1,3.5-3.5A3.5,3.5,0,0,1,12,22Z"})]})})}function G(s){return(0,y.jsx)(D.Z,{...s,children:(0,y.jsxs)("g",{children:[(0,y.jsx)("circle",{cx:"12",cy:"12",r:"2"}),(0,y.jsx)("path",{d:"M12,17.5A5.5,5.5,0,1,1,17.5,12,5.51,5.51,0,0,1,12,17.5Zm0-9A3.5,3.5,0,1,0,15.5,12,3.5,3.5,0,0,0,12,8.5Z"})]})})}function X(s){return(0,y.jsx)(D.Z,{...s,children:(0,y.jsxs)("g",{children:[(0,y.jsx)("path",{d:"M.23,8.71l7.85,7.41L12,13.29l4,2.83,7.85-7.41S20.8,4,12,4,.23,8.71.23,8.71Z",opacity:"0.2"}),(0,y.jsx)("circle",{cx:"12.03",cy:"18.5",r:"2"}),(0,y.jsx)("path",{d:"M13.28,13.15V5H17L12,0,7.08,5h3.7v8.2a5.5,5.5,0,1,0,2.5,0ZM12,22a3.5,3.5,0,1,1,3.5-3.5A3.5,3.5,0,0,1,12,22Z"}),(0,y.jsx)("path",{d:"M16,16.12,14.6,14.67l1.46-1.37,1.37,1.45Zm2.18-2.06-1.37-1.45,1.45-1.37,1.37,1.45ZM20.34,12,19,10.55l1.45-1.37,1.38,1.45ZM22.52,10,21.15,8.49l1.31-1.24,1.37,1.46Z"}),(0,y.jsx)("path",{d:"M8.08,16.12,6.63,14.75,8,13.3l1.46,1.37ZM5.9,14.06,4.45,12.69l1.37-1.45,1.45,1.37ZM3.72,12,2.27,10.63,3.64,9.18l1.45,1.37ZM1.54,10,.23,8.71,1.6,7.25,2.91,8.49Z"})]})})}var H=v(88724),le=v(77075),we=v(43860);const Se=(0,S.createContext)(void 0);function re(){return(0,S.useContext)(Se)??void 0}function ne(s,e,t){const i=re(),n=t??i;(0,S.useEffect)(()=>(n?.addListener(s,e),()=>void n?.removeListener(s,e)),[e,s,n])}function gt(){const[s,e]=(0,S.useState)(null),t=re();return(0,S.useEffect)(()=>{if(!t||!s)return;const i=Oe(t,s);return()=>void s.removeChild(i.domElement)},[s,t]),(0,y.jsx)("div",{ref:e})}function Oe(s,e){const t=new we.XS({autoPlace:!1,width:300});e.appendChild(t.domElement);const i=t.addFolder("Renderer");return i.add(s.gl,"toneMappingExposure",0,2,.01),i.add(s.gl,"physicallyCorrectLights",!1),t}var tt=v(93004),Ae=v(68434),ue=v(89820),yt=v(30650),bt=v(93812),rs=v(84803),Li=v(11701);function Gt(s){return typeof s=="object"&&s&&"toJSON"in s?s.toJSON():s}function Os({interactionData:s,selectedObject:e,timezone:t}){const i=(0,Li.lk)(),n=s?.topic??"",r=Gt(e),a=(0,B.omit)(r,"interactionData");return n.length===0?(0,y.jsx)(bt.Z,{paddingY:1,children:(0,y.jsx)(yt.ZP,{data:e,shouldExpandNode:(o,l,c)=>c<2,invertTheme:!1,postprocessValue:Gt,theme:{...i,tree:{margin:0}},hideRoot:!0})}):(0,y.jsx)(bt.Z,{paddingY:1,children:(0,y.jsx)(yt.ZP,{data:a,shouldExpandNode:()=>!1,invertTheme:!1,theme:{...i,tree:{margin:0,whiteSpace:"pre-line"}},hideRoot:!0,getItemString:(o,l,c,h,f)=>(0,rs.D)(o,l,c,h,f,t),postprocessValue:Gt,labelRenderer:(o,l,c,h)=>{const f=(0,B.first)(o);return(0,y.jsx)("span",{style:{padding:"0 4px 0 0"},children:f})},valueRenderer:o=>(0,y.jsx)("span",{children:o})})})}const Fs=Os;var as=v(69526),Ri=v(35109),Ni=v(2784);function Yl({addPanel:s,topic:e}){const t=Ni.useCallback(()=>{s({position:"sibling",type:"RawMessages",updateIfExists:!0,getState:i=>({...i,topicPath:e})})},[s,e]);return(0,y.jsx)(Ri.Z,{onClick:t,title:"Open in Raw Message panel",children:(0,y.jsxs)(bt.Z,{direction:"row",alignItems:"center",justifyContent:"space-between",padding:1,children:[(0,y.jsx)(Ae.Z,{variant:"body2",children:e}),(0,y.jsx)(as.Z,{fontSize:"small",color:"primary"})]})})}var Zl=v(2784);const Kl="Selected object",Xl=Zl.memo(function({addPanel:e,selectedObject:t,interactionsTabType:i,setInteractionsTabType:n,timezone:r}){const a=t?.object.interactionData,o=a?.originalMessage,l=a?.instanceDetails;return(0,y.jsx)(ue.ZP,{tooltip:"Inspect objects",icon:(0,y.jsx)(tt.BaF,{}),selectedTab:i,onSelectTab:c=>n(c),children:(0,y.jsx)(ue.KV,{name:Kl,children:(0,y.jsx)(ue.CW,{children:o?(0,y.jsxs)(y.Fragment,{children:[a.topic&&(0,y.jsx)(Yl,{addPanel:e,topic:a.topic}),l?(0,y.jsx)(Fs,{selectedObject:l,timezone:r}):(0,y.jsx)(y.Fragment,{}),(0,y.jsx)(Fs,{selectedObject:o,interactionData:a,timezone:r})]}):(0,y.jsx)(Ae.Z,{variant:"body2",color:"text.disabled",gutterBottom:!0,children:"Click an object in the 3D view to select it."})})})})});function Jl(s){return(0,y.jsx)(Xl,{...s})}const Ql=(s,e)=>{if(s!=null)return s.metadataByIndex?.[e]},ql=s=>s?.instanceIndex!=null&&s.object.metadataByIndex!=null&&Ql(s.object,s.instanceIndex)!=null||s?.object;function ec({interactiveObject:s,selectObject:e}){const t=ql(s),i=(0,S.useCallback)(()=>e(s),[s,e]);return(0,y.jsx)(qe.Z,{"data-test":"InteractionContextMenuItem",onClick:i,children:t.interactionData?.topic})}function tc({clickedObjects:s=[],clickedPosition:e={clientX:0,clientY:0},onClose:t,selectObject:i}){return(0,y.jsx)(Ne.Z,{open:!0,onClose:t,anchorReference:"anchorPosition",anchorPosition:{top:e.clientY,left:e.clientX},MenuListProps:{dense:!0},children:s.map((n,r)=>(0,y.jsx)(ec,{interactiveObject:n,selectObject:i},r))})}var d=v(96995);const Oi="selected_id";class fe extends d.Tme{constructor(e,t,i){super(),this.isRenderable=!0,this.pickable=!0,this.pickableInstances=!1,this.name=e,this.renderer=t,this.userData=i}dispose(){this.children.length=0}idFromMessage(){}selectedIdVariable(){}details(){return{}}get topic(){return this.userData.topic}get pose(){return this.userData.pose}instanceDetails(e){}}var Us=v(30686),E=v(70416),os=v(76665),sc=v(22041),ic=v(91004),L=v(55708);const Pr=new Set;Ve(Pr,"foxglove.FrameTransform");const Lr=new Set;Ve(Lr,"foxglove.FrameTransforms");const ks=new Set;Ve(ks,"foxglove.PointCloud");const Fi=new Set;Ve(Fi,"foxglove.LaserScan");const zs=new Set;Ve(zs,"foxglove.RawImage");const Gs=new Set;Ve(Gs,"foxglove.CompressedImage");const Bt=new Set;Ve(Bt,"foxglove.CameraCalibration");const Ui=new Set;Ve(Ui,"foxglove.SceneUpdate");const ki=new Set;Ve(ki,"foxglove.PoseInFrame");const zi=new Set;Ve(zi,"foxglove.PosesInFrame");const Gi=new Set;Ve(Gi,"foxglove.Grid");function Ve(s,e){s.add(e);const t=e.split(".");if(t.length<2)throw new Error(`Invalid Foxglove schema: ${e}`);const i=t.slice(1).join("/");return s.add(`foxglove_msgs/${i}`),s.add(`foxglove_msgs/msg/${i}`),s}var Rr=v(1547);const nc=new d.Pa4(1,0,0),rc=new d.Pa4(0,1,0),Bi=new d.Pa4,ji=new d.Pa4,jt=new d.Pa4;function ac(s,e){const t=new d._fP(0,0,0,1);Bi.copy(s).normalize(),ji.copy(e).normalize();const i=Bi.dot(ji);if(i>=1)return t;if(i<1e-6-1){let n=jt.copy(nc).cross(s);oc(n)&&(n=jt.copy(rc).cross(s)),n.normalize(),t.setFromAxisAngle(n,Math.PI)}else{const n=Math.sqrt((1+i)*2),r=1/n;jt.copy(Bi).cross(ji),t.x=jt.x*r,t.y=jt.y*r,t.z=jt.z*r,t.w=n*.5,t.normalize()}return t}function oc(s){return s.lengthSq()<1e-6*1e-6}function $i(s,e,t=1e-5){return Math.abs(s-e)<t}function Vi(s,e){for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}function Nr(s,e,t=1e-5){return $i(s[0],e[0],t)&&$i(s[1],e[1],t)&&$i(s[2],e[2],t)}function ls(s,e,t){return Math.max(e,Math.min(t,s))}function Bs(s,e,t){return s+(e-s)*t}const Hi=new d.Ilk(0).convertSRGBToLinear(),Wi=new d.Ilk(16777215).convertSRGBToLinear();function te(s){return s<.04045?s*.0773993808:Math.pow(s*.9478672986+.0521327014,2.4)}function $(s,e){const t=(0,Rr.Z)(e);if(!t.isValid())return s.r=s.g=s.b=s.a=1,s;const i=t.toRgb();return s.r=i.r/255,s.g=i.g/255,s.b=i.b/255,s.a=i.a,s}function de(){return{r:0,g:0,b:0,a:0}}function Yi(s,e){const t=(0,Rr.Z)(e);if(!t.isValid())return s.r=s.g=s.b=1,s;const i=t.toRgb();return s.r=i.r/255,s.g=i.g/255,s.b=i.b/255,s}function _e(s,e){return s.setRGB(e.r,e.g,e.b).convertSRGBToLinear()}function zg(s){return("00000000"+(THREE.MathUtils.clamp(s.r*255,0,255)<<24^THREE.MathUtils.clamp(s.g*255,0,255)<<16^THREE.MathUtils.clamp(s.b*255,0,255)<<8^THREE.MathUtils.clamp(s.a*255,0,255)<<0).toString(16)).slice(-8)}function pe(s){const e=Math.trunc(s.r*255),t=Math.trunc(s.g*255),i=Math.trunc(s.b*255);return`rgba(${e}, ${t}, ${i}, ${s.a})`}function $t(s,e){return s.r=te(e.r),s.g=te(e.g),s.b=te(e.b),s.a=e.a,s}function Zi(s,e,t){return Math.hypot(.5468*s,.7662*e,.3376*t)}function Ki(s,e,t,i){const n=e.r*e.a,r=e.g*e.a,a=e.b*e.a,o=t.r*t.a,l=t.g*t.a,c=t.b*t.a;return s.r=Bs(n,o,i),s.g=Bs(r,l,i),s.b=Bs(a,c,i),s.a=Bs(e.a,t.a,i),s}const Or={r:0,g:0,b:0,a:0},lc={r:0,g:0,b:0,a:0},Fr=["gradient","colormap"];function Xi(s,e,t){switch(s.colorMode){case"flat":{const i=$(Or,s.flatColor);return $t(i,i),(n,r)=>{n.r=i.r,n.g=i.g,n.b=i.b,n.a=i.a}}case"gradient":{const i=Math.max(t-e,Number.EPSILON),n=$(Or,s.gradient[0]),r=$(lc,s.gradient[1]);return $t(n,n),$t(r,r),(a,o)=>{const l=Math.max(0,Math.min((o-e)/i,1));Ki(a,n,r,l)}}case"colormap":{const i=Math.max(t-e,Number.EPSILON);switch(s.colorMap){case"turbo":return(n,r)=>{const a=Math.max(0,Math.min((r-e)/i,1));yc(n,a),n.a=s.explicitAlpha};case"rainbow":return(n,r)=>{const a=Math.max(0,Math.min((r-e)/i,1));cc(n,a),n.a=s.explicitAlpha}}throw new Error(`Unrecognized color map: ${s.colorMap}`)}case"rgb":return(i,n)=>{Ur(i,n),i.a=s.explicitAlpha};case"rgba":return Ur}}function Ur(s,e){const t=e>>>0;s.a=((t&4278190080)>>>24)/255,s.r=((t&16711680)>>>16)/255,s.g=((t&65280)>>>8)/255,s.b=((t&255)>>>0)/255}function cc(s,e){const t=(1-ls(e,0,1))*5+1,i=Math.floor(t);let n=t%1;i%2<1&&(n=1-n);const r=te(1-n);i<=1?(s.r=r,s.g=0,s.b=1):i===2?(s.r=0,s.g=r,s.b=1):i===3?(s.r=0,s.g=1,s.b=r):i===4?(s.r=r,s.g=1,s.b=0):(s.r=1,s.g=r,s.b=0),s.a=1}const dc=new d.Ltg(.13572138,4.6153926,-42.66032258,132.13108234),hc=new d.Ltg(.09140261,2.19418839,4.84296658,-14.18503333),uc=new d.Ltg(.1066733,12.64194608,-60.58204836,110.36276771),fc=new d.FM8(-152.94239396,59.28637943),pc=new d.FM8(4.27729857,2.82956604),mc=new d.FM8(-89.90310912,27.34824973),Rt=new d.Ltg,cs=new d.FM8;function gc(s,e){const t=ls(e,0,1)*.99+.01;Rt.set(1,t,t*t,t*t*t),cs.set(Rt.z,Rt.w),cs.multiplyScalar(Rt.z),s.r=te(ls(Rt.dot(dc)+cs.dot(fc),0,1)),s.g=te(ls(Rt.dot(hc)+cs.dot(pc),0,1)),s.b=te(ls(Rt.dot(uc)+cs.dot(mc),0,1)),s.a=1}let vt;const js=65535;function yc(s,e){if(!vt){vt=new Float32Array(js*3);const i={r:0,g:0,b:0,a:0};for(let n=0;n<js;n++){gc(i,n/(js-1));const r=n*3;vt[r+0]=i.r,vt[r+1]=i.g,vt[r+2]=i.b}}const t=Math.trunc(e*(js-1))*3;s.r=vt[t+0],s.g=vt[t+1],s.b=vt[t+2],s.a=1}const Ji=new Set(["rgb","rgba"]),kr=new Set(["intensity","i"]);function bc(s,{supportsPackedRgbModes:e}){if(e){for(const t of s)if(Ji.has(t))return t}for(const t of s)if(kr.has(t))return t;return s.find(t=>t==="x")||s[0]?s[0]:""}function zr(s){let e=!1,t=!1,i=!1,n=!1;for(const r of s)switch(r){case"red":e=!0;break;case"green":t=!0;break;case"blue":i=!0;break;case"alpha":n=!0;break}return e&&t&&i&&n}function Gr(s,e,t,i,{supportsPackedRgbModes:n,supportsRgbaFieldsMode:r}){const a=e.colorMode??"flat",o=e.flatColor??"#ffffff",l=e.colorField??bc(s,{supportsPackedRgbModes:n}),c=s.map(T=>({label:T,value:T})),h=e.gradient,f=e.colorMap??"turbo",u=e.explicitAlpha??1,p=e.minValue,g=e.maxValue,b={};if(b.colorMode={label:"Color mode",input:"select",options:[{label:"Flat",value:"flat"},{label:"Color map",value:"colormap"},{label:"Gradient",value:"gradient"}].concat(n?[{label:"BGR (packed)",value:"rgb"},{label:"BGRA (packed)",value:"rgba"}]:[]).concat(r&&zr(s)?[{label:"RGBA (separate fields)",value:"rgba-fields"}]:[]),value:a},a==="flat")b.flatColor={label:"Flat color",input:"rgba",value:o};else if(a!=="rgba-fields"){switch(b.colorField={label:"Color by",input:"select",options:c,value:l},a){case"gradient":b.gradient={label:"Gradient",input:"gradient",value:h??i.gradient};break;case"colormap":b.colorMap={label:"Color map",input:"select",options:[{label:"Turbo",value:"turbo"},{label:"Rainbow",value:"rainbow"}],value:f};break;default:break}(a==="colormap"||a==="rgb")&&(b.explicitAlpha={label:"Opacity",input:"number",step:.1,placeholder:"1",precision:3,min:0,max:1,value:u}),Fr.includes(a)&&(b.minValue={label:"Value min",input:"number",placeholder:"auto",precision:4,value:p},b.maxValue={label:"Value max",input:"number",placeholder:"auto",precision:4,value:g})}return{fields:b,order:t.name.toLocaleLowerCase(),visible:e.visible??i.visible}}const Qi={r:0,g:0,b:0,a:0};function $s(s){switch(s.colorMode){case"flat":return $(Qi,s.flatColor).a<1;case"gradient":return $(Qi,s.gradient[0]).a<1||$(Qi,s.gradient[1]).a<1;case"colormap":case"rgb":return s.explicitAlpha<1;case"rgba":case"rgba-fields":return!0}}const Br=`
vec3 sRGBToLinear(in vec3 value) {
	return vec3(mix(
    pow(value.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)),
    value.rgb * 0.0773993808,
    vec3(lessThanEqual(value.rgb, vec3(0.04045)))
  ));
}

vec4 sRGBToLinear(in vec4 value) {
  return vec4(sRGBToLinear(value.rgb), value.a);
}
`;var A;(function(s){s[s.ARROW=0]="ARROW",s[s.CUBE=1]="CUBE",s[s.SPHERE=2]="SPHERE",s[s.CYLINDER=3]="CYLINDER",s[s.LINE_STRIP=4]="LINE_STRIP",s[s.LINE_LIST=5]="LINE_LIST",s[s.CUBE_LIST=6]="CUBE_LIST",s[s.SPHERE_LIST=7]="SPHERE_LIST",s[s.POINTS=8]="POINTS",s[s.TEXT_VIEW_FACING=9]="TEXT_VIEW_FACING",s[s.MESH_RESOURCE=10]="MESH_RESOURCE",s[s.TRIANGLE_LIST=11]="TRIANGLE_LIST"})(A||(A={}));var me;(function(s){s[s.ADD=0]="ADD",s[s.MODIFY=0]="MODIFY",s[s.DELETE=2]="DELETE",s[s.DELETEALL=3]="DELETEALL"})(me||(me={}));var W;(function(s){s[s.UNKNOWN=0]="UNKNOWN",s[s.INT8=1]="INT8",s[s.UINT8=2]="UINT8",s[s.INT16=3]="INT16",s[s.UINT16=4]="UINT16",s[s.INT32=5]="INT32",s[s.UINT32=6]="UINT32",s[s.FLOAT32=7]="FLOAT32",s[s.FLOAT64=8]="FLOAT64"})(W||(W={}));const Tt={sec:0,nsec:0},jr=new Set;ae(jr,"geometry_msgs/TransformStamped");const qi=new Set;ae(qi,"tf/tfMessage"),ae(qi,"tf2_msgs/TFMessage");const en=new Set;ae(en,"visualization_msgs/Marker");const Vs=new Set;ae(Vs,"visualization_msgs/MarkerArray"),ae(Vs,"studio_msgs/MarkerArray");const tn=new Set;ae(tn,"nav_msgs/OccupancyGrid");const Hs=new Set;ae(Hs,"sensor_msgs/PointCloud2");const sn=new Set;ae(sn,"sensor_msgs/LaserScan");const nn=new Set;ae(nn,"velodyne_msgs/VelodyneScan");const rn=new Set;ae(rn,"geometry_msgs/PoseStamped");const an=new Set;ae(an,"geometry_msgs/PoseWithCovarianceStamped");const on=new Set;ae(on,"geometry_msgs/PoseArray");const ds=new Set;ae(ds,"nav_msgs/Path");const Vt=new Set;ae(Vt,"sensor_msgs/CameraInfo");const Ws=new Set;ae(Ws,"sensor_msgs/Image");const Ys=new Set;ae(Ys,"sensor_msgs/CompressedImage");const ln=new Set;ae(ln,"geometry_msgs/PolygonStamped");const $r=new Set;ae($r,"sensor_msgs/JointState");function ae(s,e){s.add(e);const t=e.split("/");if(t.length>1){const i=t[0],n=t.slice(1).join("/");s.add(`${i}/msg/${n}`)}return s.add("ros."+e.split("/").join(".")),s}function Vr(s,e){return(t,i)=>{const n=t.getInt8(i+s);return e?Math.max(n/127,-1):n}}function Hr(s,e){return(t,i)=>{const n=t.getUint8(i+s);return e?n/255:n}}function Wr(s,e){return(t,i)=>{const n=t.getInt16(i+s,!0);return e?Math.max(n/32767,-1):n}}function Yr(s,e){return(t,i)=>{const n=t.getUint16(i+s,!0);return e?n/65535:n}}function Zr(s,e){return(t,i)=>{const n=t.getInt32(i+s,!0);return e?Math.max(n/2147483647,-1):n}}function Kr(s,e){return(t,i)=>{const n=t.getUint32(i+s,!0);return e?n/4294967295:n}}function Xr(s){return(e,t)=>e.getFloat32(t+s,!0)}function Jr(s){return(e,t)=>e.getFloat64(t+s,!0)}function Nt(s){return!("count"in s&&s.count!==1)}function Ie(s,e,t=!1,i){if(!Nt(s))return;const n=s.type;if(n==null)switch(i??s.datatype){case W.INT8:return s.offset+1<=e?Vr(s.offset,t):void 0;case W.UINT8:return s.offset+1<=e?Hr(s.offset,t):void 0;case W.INT16:return s.offset+2<=e?Wr(s.offset,t):void 0;case W.UINT16:return s.offset+2<=e?Yr(s.offset,t):void 0;case W.INT32:return s.offset+4<=e?Zr(s.offset,t):void 0;case W.UINT32:return s.offset+4<=e?Kr(s.offset,t):void 0;case W.FLOAT32:return s.offset+4<=e?Xr(s.offset):void 0;case W.FLOAT64:return s.offset+8<=e?Jr(s.offset):void 0;default:return}else switch(i??n){case L.NumericType.INT8:return s.offset+1<=e?Vr(s.offset,t):void 0;case L.NumericType.UINT8:return s.offset+1<=e?Hr(s.offset,t):void 0;case L.NumericType.INT16:return s.offset+2<=e?Wr(s.offset,t):void 0;case L.NumericType.UINT16:return s.offset+2<=e?Yr(s.offset,t):void 0;case L.NumericType.INT32:return s.offset+4<=e?Zr(s.offset,t):void 0;case L.NumericType.UINT32:return s.offset+4<=e?Kr(s.offset,t):void 0;case L.NumericType.FLOAT32:return s.offset+4<=e?Xr(s.offset):void 0;case L.NumericType.FLOAT64:return s.offset+8<=e?Jr(s.offset):void 0;default:return}}var De=v(70159),Ot=v(66867),hs=v(667),St=v(25740);function Q(){return{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}}}function Qr(s,e){const t=St.Su([0,0,0,1],e[0],e[1],e[2]);return{position:{x:s[0],y:s[1],z:s[2]},orientation:{x:t[0],y:t[1],z:t[2],w:t[3]}}}function vc(){return[0,0,0]}function Gg(s,e,t){return[s,e,t]}function Bg(s){return[s[0],s[1],s[2]]}function Tc(){return[0,0,0,1]}function jg(s,e,t,i){return[s,e,t,i]}function $g(s){return[s[0],s[1],s[2],s[3]]}function cn(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Vg(s,e,t,i,n,r,a,o,l,c,h,f,u,p,g,b){return[s,e,t,i,n,r,a,o,l,c,h,f,u,p,g,b]}function Hg(s){return[s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9],s[10],s[11],s[12],s[13],s[14],s[15]]}function Ft(s,e,t=1e-5){return Math.abs(s-e)<=t}function Sc(s,e){return Ft(s.x,e.x)&&Ft(s.y,e.y)&&Ft(s.z,e.z)&&Ft(s.w,e.w)}function Wg(s,e){return Ft(s.position.x,e.position.x)&&Ft(s.position.y,e.position.y)&&Ft(s.position.z,e.position.z)&&Sc(s.orientation,e.orientation)}function qr(s,e){const t=e[0],i=e[1],n=e[2],r=e[4],a=e[5],o=e[6],l=e[8],c=e[9],h=e[10],f=t+a+h;let u=0;return f>0?(u=Math.sqrt(f+1)*2,s[3]=.25*u,s[0]=(o-c)/u,s[1]=(l-n)/u,s[2]=(i-r)/u):t>a&&t>h?(u=Math.sqrt(1+t-a-h)*2,s[3]=(o-c)/u,s[0]=.25*u,s[1]=(i+r)/u,s[2]=(l+n)/u):a>h?(u=Math.sqrt(1+a-t-h)*2,s[3]=(l-n)/u,s[0]=(i+r)/u,s[1]=.25*u,s[2]=(o+c)/u):(u=Math.sqrt(1+h-t-a)*2,s[3]=(i-r)/u,s[0]=(l+n)/u,s[1]=(o+c)/u,s[2]=.25*u),s}class He{constructor(e,t){if(e.length===16)this._matrix=e,this._position=[0,0,0],this._rotation=[0,0,0,1],De.i0(this._position,this._matrix),qr(this._rotation,this._matrix);else if(e.length===3&&t!=null)this._position=e,this._rotation=t,St.Fv(this._rotation,this._rotation),this._matrix=De.yl(cn(),this._rotation,this._position);else throw new Error("new Transform() expected either mat4 or vec3 + quat")}position(){return this._position}rotation(){return this._rotation}matrix(){return this._matrix}setPosition(e){return Ot.JG(this._position,e),De.yl(this._matrix,this._rotation,this._position),this}setRotation(e){return St.Fv(this._rotation,e),De.yl(this._matrix,this._rotation,this._position),this}setPositionRotation(e,t){return Ot.JG(this._position,e),St.Fv(this._rotation,t),De.yl(this._matrix,this._rotation,this._position),this}setPose(e){return Ot.t8(this._position,e.position.x,e.position.y,e.position.z),St.t8(this._rotation,e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),St.Fv(this._rotation,this._rotation),De.yl(this._matrix,this._rotation,this._position),this}setMatrixUnscaled(e){return De.JG(this._matrix,e),De.i0(this._position,e),qr(this._rotation,e),this}copy(e){return Ot.JG(this._position,e._position),St.JG(this._rotation,e._rotation),De.JG(this._matrix,e._matrix),this}toPose(e){e.position.x=this._position[0],e.position.y=this._position[1],e.position.z=this._position[2],e.orientation.x=this._rotation[0],e.orientation.y=this._rotation[1],e.orientation.z=this._rotation[2],e.orientation.w=this._rotation[3]}static Identity(){return new He(vc(),Tc())}static Interpolate(e,t,i,n){return Ot.t7(e._position,t.position(),i.position(),n),St.ZA(e._rotation,t.rotation(),i.rotation(),n),e.setPositionRotation(e._position,e._rotation),e}}function Yg(s,e){return s<e?-1:s>e?1:0}function ea(s,e,t){const i=e-s,n=t-s;return Number(n)/Number(i)}function _c(s,e,t){const i=Number(e-s);return s+BigInt(Math.round(i*t))}const us=4294967295n*BigInt(1e9),dn=Math.PI/180,hn=180/Math.PI,ta=[0n,He.Identity()],sa=[0n,He.Identity()],xc=[0,0,0],Cc=[0,0,0,0],_t=He.Identity(),Ht=cn(),wc=cn(),Wt=Symbol("FALLBACK_FRAME_ID");class J{constructor(e,t,i,n,r=.1){t&&(this._parent=t),this.id=e,this.maxStorageTime=i,this.maxCapacity=n,this.capacityOverfillPercentage=r,this._transforms=new hs.u$}static assertUserFrame(e){if(e.id===Wt)throw new Error("Expected user frame")}parent(){return this._parent}root(){if(this.id===Wt)return this;J.assertUserFrame(this);let e=this;for(;e._parent;)e=e._parent;return e}isRoot(){return this._parent==null}transformsSize(){return this._transforms.size}setParent(e){this._parent&&this._parent!==e&&this._transforms.clear(),this._parent=e}findAncestor(e){let t=this._parent;for(;t;){if(t.id===e)return t;t=t._parent}}addTransform(e,t){if(this._transforms.set(e,t),Math.max(0,this._transforms.size-this.maxCapacity)/this.maxCapacity>this.capacityOverfillPercentage){const n=this._transforms.size-this.maxCapacity;let r=this._transforms.at(n)[0];const o=this._transforms.maxKey()-this.maxStorageTime;r=o>r?o:r,this._transforms.removeBefore(r)}}removeTransformsAfter(e){this._transforms.removeAfter(e)}removeTransformAt(e){this._transforms.remove(e)}findClosestTransforms(e,t,i,n){const r=this._transforms.size;if(r===0)return!1;if(r===1){const[p,g]=this._transforms.maxEntry();return i<=p+n?(e[0]=t[0]=p,e[1]=t[1]=g,!0):!1}const a=this._transforms.binarySearch(i);if(a>=0){const[p,g]=this._transforms.at(a);return e[0]=t[0]=i,e[1]=t[1]=g,!0}const o=~a;if(o>=this._transforms.size){const[p,g]=this._transforms.maxEntry();return i<=p+n?(e[0]=t[0]=p,e[1]=t[1]=g,!0):!1}const l=o-1;if(l<0){const[p,g]=this._transforms.minEntry();return p+n>=i?(e[0]=t[0]=p,e[1]=t[1]=g,!0):!1}const[c,h]=this._transforms.at(l),[f,u]=this._transforms.at(o);return e[0]=c,e[1]=h,t[0]=f,t[1]=u,!0}applyLocal(e,t,i,n,r=us){if(this.id===Wt||i.id===Wt)return e;if(J.assertUserFrame(this),J.assertUserFrame(i),i===this)return Ic(e,t),e;if(i.findAncestor(this.id))return J.Apply(e,t,this,i,!1,n,r)?e:void 0;if(this.findAncestor(i.id))return J.Apply(e,t,i,this,!0,n,r)?e:void 0;let a=i;for(;a;){const o=this.findAncestor(a.id);if(o)return J.Apply(e,t,o,i,!1,n,r)&&J.Apply(e,e,o,this,!0,n,r)?e:void 0;a=a._parent}}apply(e,t,i,n,r,a,o=us){if(i.applyLocal(e,t,n,a,o)!=null)return this.applyLocal(e,e,i,r,o)}displayName(){return J.DisplayName(this.id)}static Interpolate(e,t,i,n){const[r,a]=t,[o,l]=i;if(r===o){e[0]=o,e[1].copy(l);return}const c=Math.max(0,Math.min(1,ea(r,o,n)));e[0]=_c(r,o,c),He.Interpolate(e[1],a,l,c)}static InterpolateTransform(e,t,i,n){const[r,a]=t,[o,l]=i;if(r===o){e.copy(l);return}const c=Math.max(0,Math.min(1,ea(r,o,n)));He.Interpolate(e,a,l,c)}static GetTransformMatrix(e,t,i,n,r){De.yR(e);let a=i;for(;a!==t;){if(!a.findClosestTransforms(ta,sa,n,r))return!1;if(J.InterpolateTransform(_t,ta,sa,n),a.offsetEulerDegrees){const o=_t.rotation(),l=De.en(wc,o),c=Dc(xc,l);Ot.IH(c,c,a.offsetEulerDegrees),_t.setRotation(Mc(Cc,c))}if(a.offsetPosition){const o=_t.position();Ot.IH(o,o,a.offsetPosition),_t.setPosition(o)}if(De.Jp(e,_t.matrix(),e),a._parent==null)throw new Error(`Frame "${t.displayName()}" is not a parent of "${i.displayName()}"`);a=a._parent}return!0}static Apply(e,t,i,n,r,a,o){return J.GetTransformMatrix(Ht,i,n,a,o)?(r&&De.U_(Ht,Ht),De.Jp(Ht,Ht,_t.setPose(t).matrix()),_t.setMatrixUnscaled(Ht).toPose(e),!0):!1}static DisplayName(e){return e===Wt?"(none)":e===""||e.startsWith(" ")||e.endsWith(" ")?`"${e}"`:e}}J.FALLBACK_FRAME_ID=Wt;function Ic(s,e){const t=e.position,i=e.orientation;s.position.x=t.x,s.position.y=t.y,s.position.z=t.z,s.orientation.x=i.x,s.orientation.y=i.y,s.orientation.z=i.z,s.orientation.w=i.w}function Dc(s,e){const t=e[0],i=e[4],n=e[8],r=e[5],a=e[9],o=e[6],l=e[10];return s[1]=Math.asin(Math.max(-1,Math.min(1,n))),Math.abs(n)<.9999999?(s[0]=Math.atan2(-a,l),s[2]=Math.atan2(-i,t)):(s[0]=Math.atan2(o,r),s[2]=0),s[0]*=hn,s[1]*=hn,s[2]*=hn,s}function Mc(s,e){const t=e[0]*dn,i=e[1]*dn,n=e[2]*dn,r=Math.cos(t/2),a=Math.cos(i/2),o=Math.cos(n/2),l=Math.sin(t/2),c=Math.sin(i/2),h=Math.sin(n/2);return s[0]=l*a*o+r*c*h,s[1]=r*c*o-l*a*h,s[2]=r*a*h+l*c*o,s[3]=r*a*o-l*c*h,s}const Ec=5e4;var Ut;(function(s){s[s.NOT_UPDATED=0]="NOT_UPDATED",s[s.UPDATED=1]="UPDATED",s[s.CYCLE_DETECTED=2]="CYCLE_DETECTED"})(Ut||(Ut={}));class un{constructor(e=us,t=Ec){this._frames=new Map,this._maxStorageTime=e,this._maxCapacityPerFrame=t,this.defaultRootFrame=new J(J.FALLBACK_FRAME_ID,void 0,this._maxStorageTime,this._maxCapacityPerFrame),this.defaultRootFrame.addTransform(0n,He.Identity())}addTransform(e,t,i,n){let r=!this.hasFrame(e),a=!1;const o=this.getOrCreateFrame(e),l=o.parent();return(l==null||l.id!==t)&&(a=this._checkParentForCycle(e,t),a||(o.setParent(this.getOrCreateFrame(t)),r=!0)),a||o.addTransform(i,n),a?Ut.CYCLE_DETECTED:r?Ut.UPDATED:Ut.NOT_UPDATED}removeTransform(e,t,i){const n=this.frame(e);n&&n.parent()?.id===t&&(n.removeTransformAt(i),this._removeEmptyAncestors(n))}_removeEmptyAncestors(e){if(e.transformsSize()>0)return;const t=new Map;for(const i of this._frames.values())t.set(i.id,new Set);for(const i of this._frames.values()){const n=i.parent();if(n===e)return;if(n==null)continue;const r=t.get(n.id);if(!r)throw new Error("invariant: should have children array");r.add(i.id)}for(let i=e;i;i=i.parent()){if(i.transformsSize()>0)return;const n=t.get(i.id);if(n&&n.size>0)return;this._frames.delete(i.id),t.delete(i.id);const r=i.parent()?.id;r&&t.get(r)?.delete(i.id)}}clear(){this._frames.clear()}clearAfter(e){for(const t of this._frames.values())t.removeTransformsAfter(e)}hasFrame(e){return e===J.FALLBACK_FRAME_ID?!0:this._frames.has(e)}frame(e){return e===J.FALLBACK_FRAME_ID?this.defaultRootFrame:this._frames.get(e)}getOrCreateFrame(e){let t=this._frames.get(e);return t||(t=new J(e,void 0,this._maxStorageTime,this._maxCapacityPerFrame),this._frames.set(e,t)),t}frames(){return this._frames}apply(e,t,i,n,r,a,o,l){const c=this.frame(i),h=this.frame(r);if(!c||!h)return;const f=(n!=null?this.frame(n):c.root())??c.root();return c.apply(e,t,f,h,a,o,l)}frameList(){const e=Array.from(this._frames.values()),t=new Map(e.map(a=>[a.id,{id:a.id,children:[]}])),i=[];for(const a of e){const o=t.get(a.id),l=a.parent()?.id;if(l==null)i.push(o);else{const c=t.get(l);if(c==null)continue;c.children.push(o)}}const n=[];function r(a,o){const l=J.DisplayName(a.id);n.push({value:a.id,label:`${"\xA0\xA0".repeat(o)}${l}`}),a.children.sort((c,h)=>c.id.localeCompare(h.id));for(const c of a.children)r(c,o+1)}i.sort((a,o)=>a.id.localeCompare(o.id));for(const a of i)r(a,0);return n}_checkParentForCycle(e,t){if(e===t)return!0;let i=this.frame(t);for(;i?.parent();){if(i.parent()?.id===e)return!0;i=i.parent()}return!1}static Clone(e){const t=new un(e._maxStorageTime,e._maxCapacityPerFrame);return t._frames=e._frames,t}}const lt="MISSING_TRANSFORM";function fs(s,e,t){const i=s===t?e:s;return t!==i?`Missing transform from frame <${J.DisplayName(t)}> to frame <${J.DisplayName(i)}>`:t!==e?`Missing transform from frame <${J.DisplayName(t)}> to fixed frame <${J.DisplayName(e)}> to frame <${J.DisplayName(i)}>`:`Identity transform failed for frame <${J.DisplayName(t)}>`}const fn=Q();function ps(s,e,t,i,n,r,a){const o=s.userData.pose;if(!o)throw new Error(`Missing userData.pose for ${s.name}`);const l=Boolean(e.apply(fn,o,t,i,n,r,a));if(s.visible=l,l){const c=fn.position,h=fn.orientation;s.position.set(c.x,c.y,c.z),s.quaternion.set(h.x,h.y,h.z,h.w)}return l}class ie extends d.Tme{constructor(e,t){super(),this.renderables=new Map,this.handleSettingsAction=i=>{},this.extensionId=this.name=e,this.renderer=t,queueMicrotask(()=>this.updateSettingsTree())}dispose(){for(const e of this.renderables.values())e.dispose();this.children.length=0,this.renderables.clear()}removeAllRenderables(){for(const e of this.renderables.values())e.dispose(),this.remove(e);this.renderables.clear(),this.updateSettingsTree()}settingsNodes(){return[]}updateSettingsTree(){this.renderer.settings.setNodesForKey(this.extensionId,this.settingsNodes())}saveSetting(e,t){this.renderer.updateConfig(i=>{t==null?(0,B.unset)(i,e):(0,B.set)(i,e,t)}),this.updateSettingsTree()}setColorScheme(e,t){}startFrame(e,t,i){for(const n of this.renderables.values()){const r=n.userData.settingsPath;if(n.visible=n.userData.settings.visible,!n.visible){this.renderer.settings.errors.clearPath(r);continue}const o=n.userData.settings.frameLocked??!0?e:n.userData.messageTime,l=n.userData.frameId;if(ps(n,this.renderer.transformTree,t,i,l,e,o))this.renderer.settings.errors.remove(r,lt);else{const h=fs(t,i,l);this.renderer.settings.errors.add(r,lt,h)}}}}function ge(s){return s?{sec:s.sec??0,nsec:s.nsec??0}:{sec:0,nsec:0}}function Yt(s){return s==null?new Uint8Array(0):s instanceof Uint8Array?s:Array.isArray(s)||s instanceof ArrayBuffer?new Uint8Array(s):new Uint8Array(0)}function Ac(s){return s==null?new Int8Array(0):s instanceof Int8Array?s:Array.isArray(s)||s instanceof ArrayBuffer?new Int8Array(s):new Int8Array(0)}function Zs(s){return s==null?new Float32Array(0):s instanceof Float32Array?s:Array.isArray(s)||s instanceof ArrayBuffer||s instanceof Float64Array?new Float32Array(s):new Float32Array(0)}function We(s){return s?{x:s.x??0,y:s.y??0,z:s.z??0}:{x:0,y:0,z:0}}function ia(s){return s?s.map(We):[]}function Pc(s){return!s||s.length!==36||typeof s[0]!="number"?[1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1]:s}function pn(s){return s?{x:s.x??0,y:s.y??0,z:s.z??0,w:s.w??0}:{x:0,y:0,z:0,w:1}}function st(s){return s?{r:s.r??0,g:s.g??0,b:s.b??0,a:s.a??1}:{r:0,g:0,b:0,a:1}}function mn(s){return s?s.map(st):[]}function oe(s){return{position:We(s?.position),orientation:pn(s?.orientation)}}function Fe(s){return{frame_id:s?.frame_id??"",stamp:ge(s?.stamp),seq:s?.seq}}function Lc(s){return{translation:We(s?.translation),rotation:pn(s?.rotation)}}function na(s){return{header:Fe(s?.header),child_frame_id:s?.child_frame_id??"",transform:Lc(s?.transform)}}function Rc(s){return{transforms:(s?.transforms??[]).map(na)}}function ra(s){return{timestamp:ge(s?.timestamp),parent_frame_id:s?.parent_frame_id??"",child_frame_id:s?.child_frame_id??"",translation:We(s?.translation??s?.transform?.translation),rotation:pn(s?.rotation??s?.transform?.rotation)}}function Nc(s){return{transforms:(s?.transforms??[]).map(ra)}}function Oc(s){switch(s){case L.NumericType.UINT8:return W.UINT8;case L.NumericType.INT8:return W.INT8;case L.NumericType.UINT16:return W.UINT16;case L.NumericType.INT16:return W.INT16;case L.NumericType.UINT32:return W.UINT32;case L.NumericType.INT32:return W.INT32;case L.NumericType.FLOAT32:return W.FLOAT32;case L.NumericType.FLOAT64:return W.FLOAT64;default:return W.UNKNOWN}}function Y(s,e){return e.has(s.schemaName)||(s.convertibleTo?.some(t=>e.has(t))??!1)}function ct(){return 0}const aa=["gradient","colormap"],Fc="INVALID_FOXGLOVE_GRID",Uc="turbo",kc={r:1,g:1,b:1,a:1},zc={r:100/255,g:47/255,b:105/255,a:1},Gc={r:227/255,g:177/255,b:135/255,a:1},Ks={COLOR_MODE_FLAT:0,COLOR_MODE_RGBA:1,COLOR_MODE_GRADIENT:2,COLOR_MODE_COLORMAP:3},gn={COLOR_MAP_TURBO:0,COLOR_MAP_RAINBOW:1},Xs={visible:!1,frameLocked:!1,colorMode:"flat",minValue:void 0,maxValue:void 0,flatColor:pe(kc),colorField:void 0,gradient:[pe(zc),pe(Gc)],colorMap:Uc,explicitAlpha:1},oa={redReader:ct,greenReader:ct,blueReader:ct,alphaReader:ct};function Bc(s){return L.NumericType[s]??`${s}`}function la(s){switch(s.colorMode){case"flat":return d.rnI;case"gradient":case"colormap":return d.rnI;case"rgba-fields":return d.knz}}const xe={r:0,g:0,b:0,a:1},ca=[0,0];class jc extends fe{dispose(){this.userData.texture.dispose(),this.userData.material.dispose(),this.userData.pickingMaterial.dispose()}details(){return this.userData.foxgloveGrid}syncPickingMaterial(){const{pickingMaterial:e,material:t}=this.userData;e.uniforms=t.uniforms,e.needsUpdate=!0}_getRgbaFieldReaders(e,t){const{cell_stride:i}=t;for(const n of t.fields){const{name:r}=n;r==="red"?e.redReader=Ie(n,i,!0)??ct:r==="green"?e.greenReader=Ie(n,i,!0)??ct:r==="blue"?e.blueReader=Ie(n,i,!0)??ct:r==="alpha"&&(e.alphaReader=Ie(n,i,!0)??ct)}}_getColorByFieldReader(e,t){const{cell_stride:i}=e;for(const n of e.fields){const{type:r,offset:a,name:o}=n;if(o===t.colorField){const l=Ie(n,i);if(!l){const c=L.NumericType[r],h=`Grid field "${o}" is invalid. type=${c}, offset=${a}, stride=${i}`;ms(this.renderer,this.userData.topic,h);return}return l}}return ct}updateMaterial(e){const{colorMode:t}=e,{material:i}=this.userData;let n=!1,r=!1;t==="flat"?($(xe,e.flatColor),r=xe.a<1):t==="gradient"?($(xe,e.gradient[0]),r=xe.a<1,$(xe,e.gradient[1]),r=r||xe.a<1):t==="colormap"&&(r=e.explicitAlpha<1),r!==i.transparent&&(i.depthWrite=!r,i.transparent=r,n=!0),n&&(i.needsUpdate=!0)}updateUniforms(e,t){const{material:i}=this.userData,{uniforms:{colorMode:n,colorMap:r,colorMapOpacity:a,minValue:o,maxValue:l,minGradientColorLinear:c,maxGradientColorLinear:h}}=i;t.colorMode==="rgba-fields"?n.value=Ks.COLOR_MODE_RGBA:n.value=Ks[`COLOR_MODE_${t.colorMode.toUpperCase()}`],r.value=gn[`COLOR_MAP_${t.colorMap.toUpperCase()}`],a.value=t.explicitAlpha,Jc(ca,t,e.fields.find(b=>t.colorField===b.name)?.type??L.NumericType.UNKNOWN);const[f,u]=ca;o.value=f,l.value=u;const p=$(xe,t.gradient[0]);$t(p,p),c.value.set(p.r,p.g,p.b,p.a);const g=$(xe,t.gradient[1]);$t(g,g),h.value.set(g.r,g.g,g.b,g.a)}updateTexture(e,t){let i=this.userData.texture;const n=this._getColorByFieldReader(e,t);if(!n)return;const r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),{column_count:a,row_stride:o,cell_stride:l}=e,c=e.data.length/o,h=a!==i.image.width||c!==i.image.height,f=aa.includes(t.colorMode);((f?i.format!==d.hEm:i.format!==d.wk1)||h)&&(i.dispose(),i=da(e,t),i.generateMipmaps=!1,this.userData.texture=i,this.userData.material.uniforms.map.value=i);const p=la(t);if(p!==i.encoding&&(i.encoding=p,i.needsUpdate=!0),f){const g=i.image.data;for(let b=0;b<c;b++)for(let T=0;T<a;T++){const _=b*o+T*l,R=n(r,_),N=b*a+T;g[N]=R}}else{const g=i.image.data;let b=!1;if(t.colorMode==="rgba-fields"){this._getRgbaFieldReaders(oa,e);const{redReader:T,greenReader:_,blueReader:R,alphaReader:N}=oa;for(let P=0;P<c;P++)for(let O=0;O<a;O++){const U=P*o+O*l,j=(P*a+O)*4,se=N(r,U);g[j+0]=T(r,U)*255|0,g[j+1]=_(r,U)*255|0,g[j+2]=R(r,U)*255|0,g[j+3]=se*255|0,se!==0&&se!==1&&(b=!0)}}else{const T=Xi(t,0,1);for(let _=0;_<c;_++)for(let R=0;R<a;R++){const N=_*o+R*l,P=n(r,N);T(xe,P);const U=(_*a+R)*4;g[U+0]=Math.floor(xe.r*255),g[U+1]=Math.floor(xe.g*255),g[U+2]=Math.floor(xe.b*255),g[U+3]=Math.floor(xe.a*255),xe.a!==0&&xe.a!==1&&(b=!0)}}this.userData.material.transparent!==b&&(this.userData.material.transparent=b,this.userData.material.depthWrite=!b,this.userData.material.needsUpdate=!0)}this.userData.material.uniforms.map.value.needsUpdate=!0}}class $c extends ie{constructor(e){super("foxglove.Grid",e),this.fieldsByTopic=new Map,this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n];r.userData.settings={...Xs,...a},r.updateMaterial(r.userData.settings),r.updateUniforms(r.userData.foxgloveGrid,r.userData.settings),(t.payload.path[2]==="colorMode"||t.payload.path[2]==="colorField"||t.payload.path[2]==="flatColor")&&r.updateTexture(r.userData.foxgloveGrid,r.userData.settings),r.syncPickingMaterial()}},this.handleFoxgloveGrid=t=>{const i=t.topic,n=Xc(t.message),r=(0,m.toNanoSec)(t.receiveTime);let a=this.renderables.get(i);if(!this._validateFoxgloveGrid(n,t.topic)){a&&(a.visible=!1);return}if(a)a.visible=!0;else{const l=this.renderer.config.topics[i],c={...Xs,...l};c.colorField==null&&this.fieldsByTopic.get(i)==null&&(qc(c,n.fields,{supportsPackedRgbModes:!1}),this.renderer.updateConfig(b=>{const T={...l};T.colorField=c.colorField,T.colorMode=c.colorMode,T.colorMap=c.colorMap,b.topics[i]=T}));const h=da(n,c),f=this.renderer.sharedGeometry.getGeometry(this.constructor.name,Vc),u=Hc(i,h,f),p=u.material,g=u.userData.pickingMaterial;a=new jc(i,this.renderer,{receiveTime:r,messageTime:(0,m.toNanoSec)(n.timestamp),frameId:this.renderer.normalizeFrameId(n.frame_id),pose:n.pose,settingsPath:["topics",i],settings:c,topic:i,foxgloveGrid:n,mesh:u,texture:h,material:p,pickingMaterial:g}),a.add(u),this.add(a),this.renderables.set(i,a)}let o=this.fieldsByTopic.get(i);(!o||o.length!==n.fields.length)&&(o=n.fields.map(l=>l.name),this.fieldsByTopic.set(i,o),this.updateSettingsTree()),this._updateFoxgloveGridRenderable(a,n,r,a.userData.settings)},e.addSchemaSubscriptions(Gi,this.handleFoxgloveGrid)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!Y(n,Gi))continue;const r=e[n.name]??{},a=Gr(this.fieldsByTopic.get(n.name)??[],r,n,Xs,{supportsPackedRgbModes:!1,supportsRgbaFieldsMode:!0});a.icon="Cells",a.fields.frameLocked={label:"Frame lock",input:"boolean",value:r.frameLocked??Xs.frameLocked},a.handler=t,i.push({path:["topics",n.name],node:a})}return i}_validateFoxgloveGrid(e,t){const{cell_stride:i,row_stride:n,column_count:r}=e,a=e.data.byteLength/n;if(e.fields.length===0)return ms(this.renderer,t,"Grid has no fields. At least one field is required for the Grid to be displayed."),!1;if(Math.floor(r)!==r||Math.floor(a)!==a){const c=`Grid column count (${e.column_count}) or row count (${a} = data.byteLength ${e.data.byteLength} / row_stride ${n}) is not an integer.`;return ms(this.renderer,t,c),!1}if(i*r>n){const c=`Grid row_stride (${n}) does not allow for requisite column_count (${r}) with cell stride (${i}). Minimum requisite bytes in row_stride needed: (${r*i}) `;return ms(this.renderer,t,c),!1}let o=0,l;for(const c of e.fields){const h=Wc(c.type);c.offset+h>o&&(o=c.offset+h,l=c)}if(o>i){let c=`Grid cell_stride (${i}) is less than minimum bytes per cell (${o})`;return l&&(c+=` required by \u201C${l.name}\u201D field, type=${Bc(l.type)}, offset=${l.offset}`),ms(this.renderer,t,c),!1}return!0}_updateFoxgloveGridRenderable(e,t,i,n){e.userData.foxgloveGrid=t,e.userData.pose=t.pose,e.userData.receiveTime=i,e.userData.messageTime=(0,m.toNanoSec)(t.timestamp),e.userData.frameId=this.renderer.normalizeFrameId(t.frame_id);const{row_stride:r,column_count:a}=t,o=t.data.byteLength/r;e.updateMaterial(n),e.updateUniforms(t,n),e.updateTexture(t,n),e.scale.set(t.cell_size.x*a,t.cell_size.y*o,1),e.syncPickingMaterial()}}function Vc(){const s=new d._12(1,1,1,1);return s.translate(.5,.5,0),s.computeBoundingSphere(),s}function ms(s,e,t){s.settings.errors.addToTopic(e,Fc,t)}function da(s,e){const{column_count:t,row_stride:i}=s,n=s.data.byteLength/i,r=isFinite(t*n)?t*n:0,a=aa.includes(e.colorMode),o=a?new Float32Array(r):new Uint8ClampedArray(r*4),l=a?d.hEm:d.wk1,c=a?d.VzW:d.ywz,h=new d.IEO(o,t,n,l,c,d.xfE,d.uWy,d.uWy,d.TyD,d.wem,1,la(e));return h.generateMipmaps=!1,h}function Hc(s,e,t){const i=Yc(e,s),n=Zc(i),r=new d.Kj0(t,i);return r.castShadow=!0,r.receiveShadow=!0,r.userData.pickingMaterial=n,r}function Wc(s){switch(s){case L.NumericType.INT8:case L.NumericType.UINT8:return 1;case L.NumericType.INT16:case L.NumericType.UINT16:return 2;case L.NumericType.INT32:case L.NumericType.UINT32:case L.NumericType.FLOAT32:return 4;case L.NumericType.FLOAT64:return 8;default:return 0}}function Yc(s,e){return new d.jyz({name:`${e}:Material`,alphaTest:1e-4,side:d.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]},colorMode:{value:Ks.COLOR_MODE_RGBA},colorMap:{value:gn.COLOR_MAP_TURBO},colorMapOpacity:{value:1},minValue:{value:0},maxValue:{value:1},minGradientColorLinear:{value:new d.Ltg},maxGradientColorLinear:{value:new d.Ltg},map:{value:s}},vertexShader:`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,defines:{...Ks,...gn,PICKING:0},fragmentShader:`
      uniform vec4 objectId;

      uniform sampler2D map;

      uniform int colorMode;
      uniform float minValue;
      uniform float maxValue;

      uniform int colorMap;
      uniform float colorMapOpacity;

      uniform vec4 minGradientColorLinear;
      uniform vec4 maxGradientColorLinear;

      varying vec2 vUv;

      ${Br}

      // adapted from https://gist.github.com/mikhailov-work/0d177465a8151eb6ede1768d51d476c7
      vec3 turboLinear(float x) {
        const vec4 kRedVec4 = vec4(0.13572138, 4.61539260, -42.66032258, 132.13108234);
        const vec4 kGreenVec4 = vec4(0.09140261, 2.19418839, 4.84296658, -14.18503333);
        const vec4 kBlueVec4 = vec4(0.10667330, 12.64194608, -60.58204836, 110.36276771);
        const vec2 kRedVec2 = vec2(-152.94239396, 59.28637943);
        const vec2 kGreenVec2 = vec2(4.27729857, 2.82956604);
        const vec2 kBlueVec2 = vec2(-89.90310912, 27.34824973);

        vec4 v4 = vec4(1.0, x, x * x, x * x * x);
        vec2 v2 = v4.zw * v4.z;
        return sRGBToLinear(vec3(
          (dot(v4, kRedVec4)   + dot(v2, kRedVec2)),
          (dot(v4, kGreenVec4) + dot(v2, kGreenVec2)),
          (dot(v4, kBlueVec4)  + dot(v2, kBlueVec2))
        ));
      }


      // taken from http://docs.ros.org/jade/api/rviz/html/c++/point__cloud__transformers_8cpp_source.html
      // line 47
      vec3 rainbowLinear(float pct) {
        vec3 colorOut = vec3(0.0);
        float h = (1.0 - clamp(pct, 0.0, 1.0)) * 5.0 + 1.0;
        float i = floor(h);
        float f = mod(h, 1.0);
        // if i is even
        if (mod(i, 2.0) < 1.0) {
          f = 1.0 - f;
        }
        float n = (1.0 - f);

        if (i <= 1.0) {
          colorOut.r = n;
          colorOut.g = 0.0;
          colorOut.b = 1.0;
        } else if (i == 2.0) {
          colorOut.r = 0.0;
          colorOut.g = n;
          colorOut.b = 1.0;
        } else if (i == 3.0) {
          colorOut.r = 0.0;
          colorOut.g = 1.0;
          colorOut.b = n;
        } else if (i == 4.0) {
          colorOut.r = n;
          colorOut.g = 1.0;
          colorOut.b = 0.0;
        } else {
          colorOut.r = 1.0;
          colorOut.g = n;
          colorOut.b = 0.0;
        }
        return sRGBToLinear(colorOut);
      }

      void main() {
        vec4 color = texture2D(map, vUv);
        if(colorMode == COLOR_MODE_RGBA) {
          // input color is in sRGB, texture.encoding is sRGB, so no conversion is needed
          gl_FragColor = color;
        } else if (colorMode == COLOR_MODE_FLAT) {
          // input color was already converted to linear by getColorConverter
          gl_FragColor = color;
        } else {
          // input color was already converted to linear by getColorConverter
          float delta = max(maxValue - minValue, 0.00001);
          float colorValue = color.r;
          float normalizedColorValue = clamp((colorValue - minValue) / delta, 0.0, 1.0);
          if(colorMode == COLOR_MODE_GRADIENT) {
            /**
            * Computes a gradient step from colors a to b using pre-multiplied alpha to
            * match CSS linear gradients. The inputs are assumed to not have pre-multiplied
            * alpha, and the output will have pre-multiplied alpha.
            */
            vec4 weightedMinColor = vec4(minGradientColorLinear.rgb * minGradientColorLinear.a, minGradientColorLinear.a);
            vec4 weightedMaxColor = vec4(maxGradientColorLinear.rgb * maxGradientColorLinear.a, maxGradientColorLinear.a);
            vec4 finalColor = mix(weightedMinColor, weightedMaxColor, normalizedColorValue);
            // gradient computation takes place in linear colorspace
            gl_FragColor = finalColor;
          } else if(colorMode == COLOR_MODE_COLORMAP) {
            // colormap
            if(colorMap == COLOR_MAP_TURBO) {
              gl_FragColor = vec4(turboLinear(normalizedColorValue), colorMapOpacity);
            } else if(colorMap == COLOR_MAP_RAINBOW) {
              gl_FragColor = vec4(rainbowLinear(normalizedColorValue), colorMapOpacity);
            }
          }
        }
        if(gl_FragColor.a < 0.00001) {
          discard;
        }
        if(PICKING == 1) {
          gl_FragColor = objectId;
        } else {
          #include <encodings_fragment>
        }
      }
    `})}function Zc(s){const e=new d.jyz;return e.copy(s),e.name="",e.defines.PICKING=1,e.uniformsNeedUpdate=!0,e.needsUpdate=!0,e}function Kc(s){return{name:s?.name??"",offset:s?.offset??0,type:s?.type??0}}function Xc(s){return{timestamp:ge(s.timestamp),pose:oe(s.pose),frame_id:s.frame_id??"",row_stride:s.row_stride??0,cell_stride:s.cell_stride??0,column_count:s.column_count??0,cell_size:{x:s.cell_size?.x??1,y:s.cell_size?.y??1},fields:s.fields?.map(Kc)??[],data:Yt(s.data)}}function Jc(s,e,t){if(!Fr.includes(e.colorMode))return;const[i,n]=Qc[t],r=e.minValue??i,a=e.maxValue??n;s[0]=r,s[1]=a}const Qc={[L.NumericType.UNKNOWN]:[0,1],[L.NumericType.UINT8]:[0,255],[L.NumericType.UINT16]:[0,65535],[L.NumericType.UINT32]:[0,Math.pow(2,32)-1],[L.NumericType.INT8]:[-128,127],[L.NumericType.INT16]:[-Math.pow(2,16-1),-Math.pow(2,16-1)-1],[L.NumericType.INT32]:[-Math.pow(2,32-1),-Math.pow(2,32-1)-1],[L.NumericType.FLOAT32]:[0,1],[L.NumericType.FLOAT64]:[0,1]};function qc(s,e,{supportsPackedRgbModes:t}){if(t)for(const i of e){const n=i.name.toLowerCase();if(Ji.has(n)){switch(s.colorField=i.name,n){case"rgb":s.colorMode="rgb";break;default:case"rgba":s.colorMode="rgba";break}return}}if(zr(e.map(i=>i.name))){s.colorMode="rgba-fields";return}if(e.length>0){const i=e[0];s.colorField=i.name,s.colorMode="colormap",s.colorMap="turbo";return}}var ha=v(57718),yn=v(21385);const ed=1,ua=new d.FM8,td=new d.JOQ(new d.Pa4(0,0,1),0);class sd extends Us.Z{constructor(e,t){super(),this.getCamera=t,this.cursorCoords=new d.FM8,this.raycaster=new d.iMs,this.onResize=n=>{if(this.canvas.parentElement){const r=id(this.canvas.parentElement);if(isNaN(r.width)||isNaN(r.height))return;(r.width!==this.canvasSize.width||r.height!==this.canvasSize.height)&&(this.canvasSize.width=r.width,this.canvasSize.height=r.height,this.emit("resize",this.canvasSize))}},this.onMouseDown=n=>{this.startClientPos=new d.FM8(n.offsetX,n.offsetY),this.updateCursorCoords(n),this.emit("mousedown",this.cursorCoords,this.worldSpaceCursorCoords,n)},this.onMouseMove=n=>{this.updateCursorCoords(n),this.emit("mousemove",this.cursorCoords,this.worldSpaceCursorCoords,n)},this.onMouseUp=n=>{this.updateCursorCoords(n),this.emit("mouseup",this.cursorCoords,this.worldSpaceCursorCoords,n)},this.onClick=n=>{if(!this.startClientPos)return;const r=this.startClientPos.distanceTo(ua.set(n.offsetX,n.offsetY));this.startClientPos=void 0,!(r>ed)&&(this.updateCursorCoords(n),this.emit("click",this.cursorCoords,this.worldSpaceCursorCoords,n))},this.onTouchStart=n=>{const r=n.touches[0];r&&(this.startClientPos=new d.FM8(r.clientX,r.clientY)),n.preventDefault()},this.onTouchEnd=n=>{n.preventDefault()},this.onTouchMove=n=>{n.preventDefault()},this.onTouchCancel=n=>{n.preventDefault()};const i=e.parentElement;if(!i)throw new Error("<canvas> must be parented to a DOM element");this.canvas=e,this.canvasSize=new d.FM8(e.width,e.height),this.resizeObserver=new ResizeObserver(this.onResize),this.resizeObserver.observe(i),e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("mousemove",this.onMouseMove),e.addEventListener("mouseup",this.onMouseUp),e.addEventListener("click",this.onClick),e.addEventListener("touchstart",this.onTouchStart,{passive:!1}),e.addEventListener("touchend",this.onTouchEnd,{passive:!1}),e.addEventListener("touchmove",this.onTouchMove,{passive:!1}),e.addEventListener("touchcancel",this.onTouchCancel,{passive:!1})}dispose(){const e=this.canvas;this.removeAllListeners(),this.resizeObserver.disconnect(),e.removeEventListener("mousedown",this.onMouseDown),e.removeEventListener("mousemove",this.onMouseMove),e.removeEventListener("mouseup",this.onMouseUp),e.removeEventListener("click",this.onClick),e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd),e.removeEventListener("touchmove",this.onTouchMove),e.removeEventListener("touchcancel",this.onTouchCancel)}updateCursorCoords(e){this.cursorCoords.x=e.offsetX,this.cursorCoords.y=e.offsetY,this.raycaster.setFromCamera(ua.set(e.offsetX/this.canvasSize.width*2-1,-(e.offsetY/this.canvasSize.height*2-1)),this.getCamera()),this.worldSpaceCursorCoords=this.raycaster.ray.intersectPlane(td,this.worldSpaceCursorCoords??new d.Pa4)??void 0}}function id(s){const e=getComputedStyle(s),t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),i=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom),n=parseFloat(e.borderLeftWidth)+parseFloat(e.borderRightWidth),r=parseFloat(e.borderTopWidth)+parseFloat(e.borderBottomWidth),a=s.clientWidth-t-n,o=s.clientHeight-i-r;return{width:a,height:o}}var nd=v(83829),rd=v(20111),ad=v(14666),od=v(31031),ld=v(556),cd=v(81497),dd=v(28575),hd=v(30224),ud="../../packages/studio-base/src/panels/ThreeDeeRender/ModelCache.ts";const Js=x.ZP.getLogger(ud),bn="y_up",fd=new d.Ilk(2395903).convertSRGBToLinear(),pd=["model/gltf","model/gltf-binary","model/gltf+json"],md=["model/stl","model/x.stl-ascii","model/x.stl-binary","application/sla"],gd=["model/vnd.collada+xml"],yd=["model/obj","text/prs.wavefront-obj"];class bd{constructor(e){this.options=e,this._textDecoder=new TextDecoder,this._models=new Map,this._edgeMaterial=e.edgeMaterial}async load(e,t,i){let n=this._models.get(e);return n?await n:(n=this._loadModel(e,t,i).then(r=>vd(r,this._edgeMaterial)).catch(async r=>{i(r)}),this._models.set(e,n),await n)}async _loadModel(e,t,i){const r=await fetch(e);if(!r.ok){const c=r.statusText;throw new Error(`Error ${r.status}${c?` (${c})`:""}`)}const a=await r.arrayBuffer();if(a.byteLength<4)throw new Error(`${a.byteLength} bytes received`);const o=new DataView(a),l=t.overrideMediaType??r.headers.get("content-type")??"";if(o.getUint32(0,!1)===1735152710||pd.includes(l)||/\.glb$/i.test(e)||/\.gltf$/i.test(e))return await this.loadGltf(e,i);if(md.includes(l)||/\.stl$/i.test(e))return this.loadSTL(e,a,this.options.meshUpAxis);if(gd.includes(l)||/\.dae$/i.test(e)){const c=this._textDecoder.decode(a);return await this.loadCollada(e,c,this.options.ignoreColladaUpAxis,i)}if(yd.includes(l)||/\.obj$/i.test(e)){const c=this._textDecoder.decode(a);return await this.loadOBJ(e,c,this.options.meshUpAxis,i)}throw new Error(`Unknown ${a.byteLength} byte mesh (content-type: "${l}")`)}async loadGltf(e,t){const i=o=>{const l=Sn(o);Js.error(`Failed to load GLTF asset "${l}" for "${e}"`),t(new Error(`Failed to load GLTF asset "${l}"`))},n=new d.lLk(void 0,void 0,i);n.setURLModifier(Tn);const r=new cd.E(n);r.setMeshoptDecoder(nd.z$),r.setDRACOLoader(this.getDracoLoader(n)),n.itemStart(e);const a=await r.loadAsync(e);return n.itemEnd(e),a.scene.rotateX(Math.PI/2),a.scene}loadSTL(e,t,i){const r=new hd.j().parse(t);Js.debug(`Finished loading STL from ${e}`);const a=new d.Wid({name:e.slice(-32),color:fd,metalness:0,roughness:1,dithering:!0}),o=new d.Kj0(r,a),l=new d.ZAu;return l.add(o),i==="y_up"&&l.rotateX(Math.PI/2),l}async loadCollada(e,t,i,n){const r=u=>{const p=Sn(u);Js.error(`Failed to load COLLADA asset "${p}" for "${e}"`),n(new Error(`Failed to load COLLADA asset "${p}"`))},a=new DOMParser().parseFromString(t,"application/xml"),o=i?"Z_UP":(a.querySelector("up_axis")?.textContent??"Y_UP").trim().toUpperCase();a.querySelectorAll("up_axis").forEach(u=>u.remove());const l=a.documentElement.outerHTML,c=new d.lLk(void 0,void 0,r);c.setURLModifier(Tn);const h=new od.G(c);c.itemStart(e);const f=h.parse(l,_d(e));return c.itemEnd(e),o==="Y_UP"&&f.scene.rotateX(Math.PI/2),Td(f.scene)}async loadOBJ(e,t,i,n){const r=c=>{const h=Sn(c);Js.error(`Failed to load OBJ asset "${h}" for "${e}"`),n(new Error(`Failed to load OBJ asset "${h}"`))},a=new d.lLk(void 0,void 0,r);a.setURLModifier(Tn);const o=new dd.L(a);a.itemStart(e);const l=o.parse(t);return a.itemEnd(e),i==="y_up"&&l.rotateX(Math.PI/2),Sd(l)}getDracoLoader(e){let t=this._dracoLoader;return t||(t=new ld._(e),t._loadLibrary=async function(i,n){if(i==="draco_wasm_wrapper.js"&&n==="text")return ad;if(i==="draco_decoder.wasm"&&n==="arraybuffer")return await(await fetch(rd)).arrayBuffer();throw new Error(`DRACOLoader attempt to load non-bundled asset: ${i} as ${n}`)},this._dracoLoader=t),t.manager=e,t}dispose(){this._dracoLoader?.dispose(),this._dracoLoader=void 0}}const vn="edges";function vd(s,e){const t=[];s.traverse(i=>{if(!(i instanceof d.Kj0))return;i.castShadow=!0,i.receiveShadow=!0;const n=new d.TOt(i.geometry,40),r=new d.ejS(n,e);r.name=vn,t.push([r,i])});for(const[i,n]of t)n.add(i);return s}function Td(s){return s.traverse(e=>{if(e instanceof d.Kj0)if(e.material instanceof d.YBo){const t=fa(e.material);e.material.dispose(),e.material=t}else e.material instanceof d.Wid&&(e.material.dithering=!0)}),s}function Sd(s){return s.traverse(e=>{if(e instanceof d.Kj0)if(e.material instanceof d.xoR){const t=fa(e.material);e.material.dispose(),e.material=t}else e.material instanceof d.Wid&&(e.material.metalness=0,e.material.roughness=1,e.material.dithering=!0)}),s}function fa(s){const e=new d.Wid({name:s.name}),t=s.shininess??0,i=s;return i.normalScale??(i.normalScale=new d.FM8(1,1)),e.copy(s),e.metalness=0,e.roughness=1-t/100,e.dithering=!0,e}function Tn(s){return s.startsWith("package://")&&/\.tiff?$/i.test(s)?s.replace("package://","x-foxglove-converted-tiff://"):s}function Sn(s){return s.startsWith("x-foxglove-converted-tiff://")?s.replace("x-foxglove-converted-tiff://","package://"):s}function _d(s){return s.slice(0,s.lastIndexOf("/")+1)}const xt=31,Qs=new d.Ilk(16777215),pa=s=>!0,ma=null;class xd{constructor(e,t,i={}){this.materialCache=new Map,this.currClearColor=new d.Ilk,this.isDebugPass=!1,this.handleAfterRender=()=>{const n=this.gl.renderLists.get(this.scene,0);n.opaque.forEach(this.processItem),n.transmissive.forEach(this.processItem),n.transparent.forEach(this.processItem)},this.processItem=n=>{if(!this.camera)return;const r=n.object,a=this.isDebugPass?wd(r.id):r.id,o=n.material,l=n.geometry;if(!l||n.object.userData.picking===!1||!this.shouldPickObjectCB(r))return;const c=o.type==="SpriteMaterial"?1:0,h=o.sizeAttenuation===!0?1:0,u=n.object.userData.pickingMaterial??this.renderMaterial(c,h);c===1&&(u.uniforms.rotation={value:o.rotation},u.uniforms.center={value:r.center}),Cd(u,a),this.gl.renderBufferDirect(this.camera,ma,l,u,r,null)},this.processInstancedItem=n=>{if(!this.camera)return;const r=n.object,a=n.geometry;if(!a||n.object.userData.picking===!1)return;const l=n.object.userData.instancePickingMaterial??this.instanceRenderMaterial();this.gl.renderBufferDirect(this.camera,ma,a,l,r,null)},this.gl=e,this.scene=t,this.shouldPickObjectCB=pa,this.debug=i.debug??!1,this.pickingTarget=new d.dd2(xt,xt,{minFilter:d.TyD,magFilter:d.TyD,format:d.wk1,encoding:d.rnI,generateMipmaps:!1}),this.pixelBuffer=new Uint8Array(4),this.emptyScene=new d.xsS}dispose(){for(const e of this.materialCache.values())e.dispose();this.materialCache.clear(),this.pickingTarget.dispose()}pick(e,t,i,n=pa){this.emptyScene.onAfterRender=this.handleAfterRender,this.camera=i,this.shouldPickObjectCB=n;const r=xt/2|0,a=this.gl.getPixelRatio(),o=Math.max(0,e*a-r),l=Math.max(0,t*a-r),c=this.gl.domElement.width,h=this.gl.domElement.height;i.setViewOffset(c,h,o,l,xt,xt);const f=this.gl.getRenderTarget(),u=this.gl.getClearAlpha();this.gl.getClearColor(this.currClearColor),this.gl.setRenderTarget(this.pickingTarget),this.gl.setClearColor(Qs,1),this.gl.clear(),this.gl.render(this.emptyScene,i),this.gl.readRenderTargetPixels(this.pickingTarget,r,r,1,1,this.pixelBuffer),this.gl.setRenderTarget(f),this.gl.setClearColor(this.currClearColor,u),i.clearViewOffset();const p=(this.pixelBuffer[0]<<24)+(this.pixelBuffer[1]<<16)+(this.pixelBuffer[2]<<8)+this.pixelBuffer[3];return this.debug&&this.pickDebugRender(i),p}pickInstance(e,t,i,n){this.emptyScene.onAfterRender=this.makeHandleInstanceAfterRender(n),this.camera=i;const r=xt/2|0,a=this.gl.getPixelRatio(),o=Math.max(0,e*a-r),l=Math.max(0,t*a-r),c=this.gl.domElement.width,h=this.gl.domElement.height;i.setViewOffset(c,h,o,l,xt,xt);const f=this.gl.getRenderTarget(),u=this.gl.getClearAlpha();return this.gl.getClearColor(this.currClearColor),this.gl.setRenderTarget(this.pickingTarget),this.gl.setClearColor(Qs,1),this.gl.clear(),this.gl.render(this.emptyScene,i),this.gl.readRenderTargetPixels(this.pickingTarget,r,r,1,1,this.pixelBuffer),this.gl.setRenderTarget(f),this.gl.setClearColor(this.currClearColor,u),i.clearViewOffset(),this.debug&&this.pickInstanceDebugRender(i,n),(this.pixelBuffer[0]<<24)+(this.pixelBuffer[1]<<16)+(this.pixelBuffer[2]<<8)+this.pixelBuffer[3]}pickDebugRender(e){this.isDebugPass=!0,this.emptyScene.onAfterRender=this.handleAfterRender;const t=this.gl.getClearAlpha();this.gl.getClearColor(this.currClearColor),this.gl.setClearColor(Qs,1),this.gl.clear(),this.gl.render(this.emptyScene,e),this.gl.setClearColor(this.currClearColor,t),this.isDebugPass=!1}pickInstanceDebugRender(e,t){this.isDebugPass=!0,this.emptyScene.onAfterRender=this.makeHandleInstanceAfterRender(t);const i=this.gl.getClearAlpha();this.gl.getClearColor(this.currClearColor),this.gl.setClearColor(Qs,1),this.gl.clear(),this.gl.render(this.emptyScene,e),this.gl.setClearColor(this.currClearColor,i),this.isDebugPass=!1}makeHandleInstanceAfterRender(e){return()=>{e.traverseVisible(t=>{const i=t;if(i.id!=null&&i.geometry&&i.material){const n={id:i.id,object:t,geometry:i.geometry,material:i.material,program:void 0,groupOrder:0,renderOrder:0,z:0,group:null};this.processInstancedItem(n)}})}}renderMaterial(e,t){const i=e<<0|t<<1;let n=this.materialCache.get(i);if(n)return n;let r=d.WdD.meshbasic_vert;return e===1&&(r=d.WdD.sprite_vert),t===1&&(r=`#define USE_SIZEATTENUATION

`+r),n=new d.jyz({vertexShader:r,fragmentShader:`
          uniform vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,side:d.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}}),this.materialCache.set(i,n),n}instanceRenderMaterial(){let t=this.materialCache.get(-1);if(t)return t;let i=d.WdD.meshbasic_vert;return i=i.replace("void main() {",`
      varying vec4 objectId;

      void main() {
        objectId = vec4(
          float((gl_InstanceID >> 24) & 255) / 255.0,
          float((gl_InstanceID >> 16) & 255) / 255.0,
          float((gl_InstanceID >> 8) & 255) / 255.0,
          float(gl_InstanceID & 255) / 255.0);
      `),t=new d.jyz({vertexShader:i,fragmentShader:`
          varying vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,side:d.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}}),this.materialCache.set(-1,t),t}}function Cd(s,e){const t=s.uniforms.objectId;if(!t)throw new Error("objectId uniform not found in picking material");t.value=[(e>>24&255)/255,(e>>16&255)/255,(e>>8&255)/255,(e&255)/255],s.uniformsNeedUpdate=!0}const ye=new Uint32Array(1);function wd(s){return ye[0]=s|0,ye[0]-=ye[0]<<6,ye[0]^=ye[0]>>>17,ye[0]-=ye[0]<<9,ye[0]^=ye[0]<<4,ye[0]-=ye[0]<<3,ye[0]^=ye[0]<<10,ye[0]^=ye[0]>>>15,ye[0]}class Id extends d.Tme{constructor(e){super(),this.material=new d.jyz({transparent:!0,uniforms:{color:{value:[1,0,1,1]}},vertexShader:`
        void main() {
          gl_Position = vec4(position.xy, 0.0, 1.0);
        }`,fragmentShader:`
        uniform vec4 color;
        void main() {
          gl_FragColor = color;
        }
      `});const t=e.sharedGeometry.getGeometry(this.constructor.name,Dd),i=new d.Kj0(t,this.material);i.frustumCulled=!1,this.add(i)}setColor(e,t){const i=this.material.uniforms.color.value;i[0]=e.r,i[1]=e.g,i[2]=e.b,i[3]=t}}function Dd(){return new d._12(2,2,1,1)}var Md="../../packages/studio-base/src/panels/ThreeDeeRender/LayerErrors.ts";const Zt=["topics",""];class qs{constructor(e){this.path=e}errorMessage(){if(this.errorsById&&this.errorsById.size>0)return Array.from(this.errorsById.values()).join(`
`)}errorAtPath(e){let t=this;for(const i of e)if(t=t.children?.get(i),!t)return;return t.errorMessage()}clone(){const e=new qs(this.path);return e.errorsById=this.errorsById,e.children=this.children,e}}const Ed=x.ZP.getLogger(Md);class Ad extends Us.Z{constructor(){super(...arguments),this.errors=new qs([])}add(e,t,i){let n=this.errors;for(const a of e)n.children||(n.children=new Map),n.children.has(a)||n.children.set(a,new qs([...n.path,a])),n=n.children.get(a);n.errorsById??(n.errorsById=new Map);const r=n.errorsById.get(t);r==null&&Ed.warn(`[${e.join(" > ")}] ${i}`),i!==r&&(n.errorsById.set(t,i),this.emit("update",e,t,i))}addToTopic(e,t,i){Zt[1]=e,this.add(Zt,t,i)}hasError(e,t){return this._getNode(e)?.errorsById?.has(t)===!0}remove(e,t){const i=this._getNode(e);i?.errorsById?.has(t)===!0&&(i.errorsById.delete(t),this.emit("remove",e,t))}removeFromTopic(e,t){Zt[1]=e,this.remove(Zt,t)}clearPath(e){const t=this._getNode(e);t&&(t.children?.clear(),t.errorsById?.clear(),this.emit("clear",e))}clearTopic(e){Zt[1]=e,this.clearPath(Zt)}clear(){this.clearPath([])}_getNode(e){let t=this.errors;for(const i of e)if(t=t.children?.get(i),!t)return;return t}}class Pd extends Us.Z{constructor(e){super(),this.errors=new Ad,this._nodesByKey=new Map,this._root={children:{}},this.handleAction=t=>{const i=t.payload.path;let n=this._root;n.handler?.(t);for(const r of i){const a=n.children?.[r];if(!a)return;a.handler?.(t),n=a}},this.handleErrorUpdate=t=>{this._root=(0,os.Uy)(this._root,i=>{if(t.length===0)return{...i};let n=i;for(const r of t){const a=n.children?.[r];if(!a)return n.children={...n.children},i;n=a}return n.error=this.errors.errors.errorAtPath(t),i}),this.emit("update")},this._root={children:e},this.errors.on("update",this.handleErrorUpdate),this.errors.on("remove",this.handleErrorUpdate),this.errors.on("clear",this.handleErrorUpdate)}setNodesForKey(e,t){this._root=(0,os.Uy)(this._root,i=>{const n=this._nodesByKey.get(e);if(n)for(const{path:r}of n)ga(i,r);for(const{path:r,node:a}of t)a.error??(a.error=this.errors.errors.errorAtPath(r)),a.label??(a.label=r[r.length-1]),a.defaultExpansionState??(a.defaultExpansionState="collapsed"),Ld(i,r,a)}),this._nodesByKey.set(e,t),this.emit("update")}setLabel(e,t){this._root=(0,os.Uy)(this._root,i=>{Rd(i,e,t)}),this.emit("update")}clearChildren(e){this._root=(0,os.Uy)(this._root,t=>{ya(t,e)}),this.emit("update")}tree(){return this._root.children}}function ga(s,e){if(e.length===0)return!1;const t=e[0],i=s.children?.[t];if(!i)return!1;if(e.length===1){const n=s.children?.[t]!=null;return n&&(s.children[t]=void 0),n}return ga(i,e.slice(1))}function ya(s,e){if(e.length===0)return;const t=e[0],i=s.children?.[t];if(i){if(e.length===1){i.children=void 0;return}ya(i,e.slice(1))}}function Ld(s,e,t){if(e.length===0)throw new Error(`Empty path for settings node "${t.label}"`);let i=s;for(let r=0;r<e.length-1;r++){const a=e[r];i.children||(i.children={}),i.children[a]||(i.children[a]={}),i=i.children[a]}const n=e[e.length-1];i.children||(i.children={}),i.children[n]=t}function Rd(s,e,t){if(e.length===0)throw new Error(`Empty path for settings label "${t}"`);let i=s;for(let n=0;n<e.length;n++){const r=e[n];i.children||(i.children={}),i.children[r]||(i.children[r]={}),i=i.children[r]}i.label=t}class Nd{constructor(){this._geometryMap=new Map}getGeometry(e,t){let i=this._geometryMap.get(e);return i||(i=t(),this._geometryMap.set(e,i)),i}dispose(){for(const e of this._geometryMap.values())e.dispose();this._geometryMap.clear()}}var Ce;(function(s){s[s.Low=0]="Low",s[s.Medium=1]="Medium",s[s.High=2]="High"})(Ce||(Ce={}));function Od(s){return s.maxSamples??0}function ba(s){switch(s){case Ce.Low:return 12;case Ce.Medium:return 20;case Ce.High:return 32}}function va(s){switch(s){case Ce.Low:return 12;case Ce.Medium:return 20;case Ce.High:return 32}}function Fd(s){switch(s){case Ce.Low:return 12;case Ce.Medium:return 20;case Ce.High:return 32}}function Ud(s){switch(s){case Ce.Low:return 10;case Ce.Medium:return 24;case Ce.High:return 32}}var Kt=v(74354);const K=3,it=1;function Ta(s,e,t){return{label:s,input:"number",min:0,step:.5,precision:K,value:e,placeholder:String(t)}}function kd(s,e){return{label:s,input:"vec3",labels:["X","Y","Z"],step:.5,precision:K,value:e}}function Sa(s,e,t){return{label:s,input:"number",min:0,step:.005,precision:4,value:e,placeholder:String(t)}}function zd(s,e){return{label:s,input:"gradient",value:e}}class Gd extends ie{constructor(e){super("foxglove.CameraStateSettings",e),this.handleSettingsAction=t=>{if(t.action==="perform-node-action"&&t.payload.id==="reset-camera"){this.renderer.updateConfig(a=>{a.cameraState=(0,B.cloneDeep)(Kt.d)}),this.updateSettingsTree();return}if(t.action!=="update"||t.payload.path.length===0)return;const i=t.payload.path,n=i[0],r=t.payload.value;if(n==="cameraState")i[1]==="syncCamera"?this.renderer.updateConfig(a=>{a.scene.syncCamera=r}):this.renderer.updateConfig(a=>(0,B.set)(a,i,r));else return;this.updateSettingsTree()},this.handleCameraMove=()=>{this.updateSettingsTree()},this.handleErrorChange=()=>{this.updateSettingsTree()},e.on("cameraMove",this.handleCameraMove),e.settings.errors.on("update",this.handleErrorChange),e.settings.errors.on("clear",this.handleErrorChange),e.settings.errors.on("remove",this.handleErrorChange)}dispose(){this.renderer.off("cameraMove",this.handleCameraMove),this.renderer.settings.errors.off("update",this.handleErrorChange),this.renderer.settings.errors.off("clear",this.handleErrorChange),this.renderer.settings.errors.off("remove",this.handleErrorChange),super.dispose()}settingsNodes(){const e=this.renderer.config,{cameraState:t}=e,i=this.handleSettingsAction;return[{path:["cameraState"],node:{label:(0,E.t)("threeDee:view"),actions:[{type:"action",id:"reset-camera",label:(0,E.t)("threeDee:reset")}],handler:i,fields:{syncCamera:{label:(0,E.t)("threeDee:syncCamera"),input:"boolean",error:this.renderer.cameraSyncError(),value:e.scene.syncCamera??!1,help:(0,E.t)("threeDee:syncCameraHelp")},distance:{label:(0,E.t)("threeDee:distance"),input:"number",step:1,precision:K,value:t.distance},perspective:{label:(0,E.t)("threeDee:perspective"),input:"boolean",value:t.perspective},targetOffset:{label:(0,E.t)("threeDee:target"),input:"vec3",labels:["X","Y","Z"],precision:K,value:[...t.targetOffset]},thetaOffset:{label:(0,E.t)("threeDee:theta"),input:"number",step:1,precision:it,value:t.thetaOffset},...t.perspective&&{phi:{label:(0,E.t)("threeDee:phi"),input:"number",step:1,precision:it,value:t.phi},fovy:{label:(0,E.t)("threeDee:fovy"),input:"number",step:1,precision:it,value:t.fovy}},near:{label:(0,E.t)("threeDee:near"),input:"number",step:Kt.d.near,precision:K,value:t.near},far:{label:(0,E.t)("threeDee:far"),input:"number",step:1,precision:K,value:t.far}}}}]}}var be=v(31953),_n=v(8052),xn=v(16896);const ei=new d.Ilk,ti=new d.Ilk,dt=[0,0,0,0];function Ye(s,e,t){return`${s}:${e?e+":":""}${t}`.replace(/\s/g,"_")}class Ue extends fe{constructor(e,t,i,n){const r=Ye(e,t.ns,t.id),a=t.lifetime.sec!==0||t.lifetime.nsec!==0;super(r,n,{receiveTime:i??0n,messageTime:(0,m.toNanoSec)(t.header.stamp),frameId:n.normalizeFrameId(t.header.frame_id),pose:t.pose,settingsPath:["topics",e],settings:{visible:!0,frameLocked:t.frame_locked},topic:e,marker:t,originalMarker:t,expiresIn:a?(0,m.toNanoSec)(t.lifetime):void 0})}idFromMessage(){return this.userData.marker.id}selectedIdVariable(){return this.getSettings()?.selectedIdVariable}getSettings(){return this.renderer.config.topics[this.userData.topic]}details(){return this.userData.originalMarker}update(e,t){const i=e.lifetime.sec!==0||e.lifetime.nsec!==0;t!=null&&(this.userData.receiveTime=t),this.userData.messageTime=(0,m.toNanoSec)(e.header.stamp),this.userData.frameId=this.renderer.normalizeFrameId(e.header.frame_id),this.userData.pose=e.pose,this.userData.marker=this._renderMarker(e),this.userData.originalMarker=e,this.userData.expiresIn=i?(0,m.toNanoSec)(e.lifetime):void 0}_markerColorsToLinear(e,t,i){_e(ei,e.color);for(let n=0;n<t;n++){const r=e.colors[n];r?(_e(ti,r),dt[0]=ti.r,dt[1]=ti.g,dt[2]=ti.b,dt[3]=r.a):(dt[0]=ei.r,dt[1]=ei.g,dt[2]=ei.b,dt[3]=e.color.a),i(dt,n)}}_renderMarker(e){const t=this.userData.topic,n=this.renderer.config.topics[t]?.color;if(n==null)return e;const r=$(de(),n);return{...e,color:r,colors:[]}}}d.rBU.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new d.FM8(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},d.Vj0["foxglove.line"]={uniforms:d.rDY.merge([d.rBU.common,d.rBU.fog,d.rBU.line]),vertexShader:`
    #include <common>
    #include <color_pars_vertex>
    #include <fog_pars_vertex>
    #include <logdepthbuf_pars_vertex>
    #include <clipping_planes_pars_vertex>

    uniform float linewidth;
    uniform vec2 resolution;

    attribute vec3 instanceStart;
    attribute vec3 instanceEnd;

    attribute vec4 instanceColorStart;
    attribute vec4 instanceColorEnd;

    #ifdef WORLD_UNITS

      varying vec4 worldPos;
      varying vec3 worldStart;
      varying vec3 worldEnd;

      #ifdef USE_DASH

        varying vec2 vUv;

      #endif

    #else

      varying vec2 vUv;

    #endif

    #ifdef USE_DASH

      uniform float dashScale;
      attribute float instanceDistanceStart;
      attribute float instanceDistanceEnd;
      varying float vLineDistance;

    #endif

    #ifdef USE_COLOR

      varying float vAlpha;

    #endif

    void trimSegment( const in vec4 start, inout vec4 end ) {

      // trim end segment so it terminates between the camera plane and the near plane

      // conservative estimate of the near plane
      float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
      float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
      float nearEstimate = - 0.5 * b / a;

      float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

      end.xyz = mix( start.xyz, end.xyz, alpha );

    }

    void main() {

      #ifdef USE_COLOR

        vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart.xyz : instanceColorEnd.xyz;
        vAlpha = ( position.y < 0.5 ) ? instanceColorStart.w : instanceColorEnd.w;

      #endif

      #ifdef USE_DASH

        vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
        vUv = uv;

      #endif

      float aspect = resolution.x / resolution.y;

      // camera space
      vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
      vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

      #ifdef WORLD_UNITS

        worldStart = start.xyz;
        worldEnd = end.xyz;

      #else

        vUv = uv;

      #endif

      // special case for perspective projection, and segments that terminate either in, or behind, the camera plane
      // clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
      // but we need to perform ndc-space calculations in the shader, so we must address this issue directly
      // perhaps there is a more elegant solution -- WestLangley

      bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

      if ( perspective ) {

        if ( start.z < 0.0 && end.z >= 0.0 ) {

          trimSegment( start, end );

        } else if ( end.z < 0.0 && start.z >= 0.0 ) {

          trimSegment( end, start );

        }

      }

      // clip space
      vec4 clipStart = projectionMatrix * start;
      vec4 clipEnd = projectionMatrix * end;

      // ndc space
      vec3 ndcStart = clipStart.xyz / clipStart.w;
      vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

      // direction
      vec2 dir = ndcEnd.xy - ndcStart.xy;

      // account for clip-space aspect ratio
      dir.x *= aspect;
      dir = normalize( dir );

      #ifdef WORLD_UNITS

        // get the offset direction as perpendicular to the view vector
        vec3 worldDir = normalize( end.xyz - start.xyz );
        vec3 offset;
        if ( position.y < 0.5 ) {

          offset = normalize( cross( start.xyz, worldDir ) );

        } else {

          offset = normalize( cross( end.xyz, worldDir ) );

        }

        // sign flip
        if ( position.x < 0.0 ) offset *= - 1.0;

        float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

        // don't extend the line if we're rendering dashes because we
        // won't be rendering the endcaps
        #ifndef USE_DASH

          // extend the line bounds to encompass  endcaps
          start.xyz += - worldDir * linewidth * 0.5;
          end.xyz += worldDir * linewidth * 0.5;

          // shift the position of the quad so it hugs the forward edge of the line
          offset.xy -= dir * forwardOffset;
          offset.z += 0.5;

        #endif

        // endcaps
        if ( position.y > 1.0 || position.y < 0.0 ) {

          offset.xy += dir * 2.0 * forwardOffset;

        }

        // adjust for linewidth
        offset *= linewidth * 0.5;

        // set the world position
        worldPos = ( position.y < 0.5 ) ? start : end;
        worldPos.xyz += offset;

        // project the worldpos
        vec4 clip = projectionMatrix * worldPos;

        // shift the depth of the projected points so the line
        // segements overlap neatly
        vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
        clip.z = clipPose.z * clip.w;

      #else

        vec2 offset = vec2( dir.y, - dir.x );
        // undo aspect ratio adjustment
        dir.x /= aspect;
        offset.x /= aspect;

        // sign flip
        if ( position.x < 0.0 ) offset *= - 1.0;

        // endcaps
        if ( position.y < 0.0 ) {

          offset += - dir;

        } else if ( position.y > 1.0 ) {

          offset += dir;

        }

        // adjust for linewidth
        offset *= linewidth;

        // adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
        offset /= resolution.y;

        // select end
        vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

        // back to clip space
        offset *= clip.w;

        clip.xy += offset;

      #endif

      gl_Position = clip;

      vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

      #include <logdepthbuf_vertex>
      #include <clipping_planes_vertex>
      #include <fog_vertex>

    }
    `,fragmentShader:`
    uniform vec3 diffuse;
    uniform float opacity;
    uniform float linewidth;

    #ifdef USE_DASH

      uniform float dashOffset;
      uniform float dashSize;
      uniform float gapSize;

    #endif

    varying float vLineDistance;

    #ifdef WORLD_UNITS

      varying vec4 worldPos;
      varying vec3 worldStart;
      varying vec3 worldEnd;

      #ifdef USE_DASH

        varying vec2 vUv;

      #endif

    #else

      varying vec2 vUv;

    #endif

    #ifdef USE_COLOR

      varying float vAlpha;

    #endif

    #include <common>
    #include <color_pars_fragment>
    #include <fog_pars_fragment>
    #include <logdepthbuf_pars_fragment>
    #include <clipping_planes_pars_fragment>

    vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

      float mua;
      float mub;

      vec3 p13 = p1 - p3;
      vec3 p43 = p4 - p3;

      vec3 p21 = p2 - p1;

      float d1343 = dot( p13, p43 );
      float d4321 = dot( p43, p21 );
      float d1321 = dot( p13, p21 );
      float d4343 = dot( p43, p43 );
      float d2121 = dot( p21, p21 );

      float denom = d2121 * d4343 - d4321 * d4321;

      float numer = d1343 * d4321 - d1321 * d4343;

      mua = numer / denom;
      mua = clamp( mua, 0.0, 1.0 );
      mub = ( d1343 + d4321 * ( mua ) ) / d4343;
      mub = clamp( mub, 0.0, 1.0 );

      return vec2( mua, mub );

    }

    void main() {

      #include <clipping_planes_fragment>

      #ifdef USE_DASH

        if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

        if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

      #endif

      #ifdef USE_COLOR

      float alpha = vAlpha;

      #else

      float alpha = opacity;

      #endif

      #ifdef WORLD_UNITS

        // Find the closest points on the view ray and the line segment
        vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
        vec3 lineDir = worldEnd - worldStart;
        vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

        vec3 p1 = worldStart + lineDir * params.x;
        vec3 p2 = rayEnd * params.y;
        vec3 delta = p1 - p2;
        float len = length( delta );
        float norm = len / linewidth;

        #ifndef USE_DASH

          #ifdef USE_ALPHA_TO_COVERAGE

            float dnorm = fwidth( norm );
            alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

          #else

            if ( norm > 0.5 ) {

              discard;

            }

          #endif

        #endif

      #else

        #ifdef USE_ALPHA_TO_COVERAGE

          // artifacts appear on some hardware if a derivative is taken within a conditional
          float a = vUv.x;
          float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
          float len2 = a * a + b * b;
          float dlen = fwidth( len2 );

          if ( abs( vUv.y ) > 1.0 ) {

            alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

          }

        #else

          if ( abs( vUv.y ) > 1.0 ) {

            float a = vUv.x;
            float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
            float len2 = a * a + b * b;

            if ( len2 > 1.0 ) discard;

          }

        #endif

      #endif

      vec4 diffuseColor = vec4( diffuse, alpha );

      #include <logdepthbuf_fragment>
      #include <color_fragment>

      gl_FragColor = vec4( diffuseColor.rgb, alpha );

      #include <tonemapping_fragment>
      #include <encodings_fragment>
      #include <fog_fragment>
      #include <premultiplied_alpha_fragment>

    }
    `};class Cn extends d.jyz{constructor(e){super({type:"LineMaterial",uniforms:d.rDY.clone(d.Vj0["foxglove.line"].uniforms),vertexShader:d.Vj0["foxglove.line"].vertexShader,fragmentShader:d.Vj0["foxglove.line"].fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(e){e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get lineWidth(){return this.uniforms.linewidth.value}set lineWidth(e){this.uniforms.linewidth.value=e}get dashed(){return Boolean("USE_DASH"in this.defines)}set dashed(e){Boolean(e)!==Boolean("USE_DASH"in this.defines)&&(this.needsUpdate=!0),e?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(e){this.uniforms.dashScale.value=e}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(e){this.uniforms.dashOffset.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e}get resolution(){return this.uniforms.resolution.value}set resolution(e){this.uniforms.resolution.value.copy(e)}}function he(s){switch(s.type){case A.ARROW:case A.CUBE:case A.SPHERE:case A.CYLINDER:case A.TEXT_VIEW_FACING:case A.MESH_RESOURCE:return s.color.a<1;case A.LINE_STRIP:case A.LINE_LIST:case A.CUBE_LIST:case A.SPHERE_LIST:case A.POINTS:case A.TRIANGLE_LIST:default:for(const e of s.colors)if(e.a<1)return!0;return s.colors.length>=s.points.length?!1:s.color.a<1}}function Xt(s){return new d.Wid({color:new d.Ilk(s.r,s.g,s.b).convertSRGBToLinear(),metalness:0,roughness:1,dithering:!0,opacity:s.a,transparent:s.a<1,depthWrite:s.a===1})}function Bd(s){const e=he(s);return new d.Wid({metalness:0,roughness:1,dithering:!0,vertexColors:!0,side:d.ehD,opacity:1,transparent:e,depthWrite:!e})}function _a(s){const e=he(s);return new d.Wid({metalness:0,roughness:1,dithering:!0,opacity:1,transparent:e,depthWrite:!e})}function xa(s,e){const t=s.scale.x,i=he(s),n=new Cn({worldUnits:e.worldUnits??!0,colorWrite:!1,transparent:i,depthWrite:!i,linewidth:t,resolution:e.resolution,stencilWrite:!0,stencilRef:1,stencilZPass:d.ce8});return n.lineWidth=t,n}function Ca(s,e){const t=s.scale.x,i=he(s),n=new Cn({worldUnits:e.worldUnits??!0,vertexColors:!0,linewidth:t,transparent:i,depthWrite:!i,resolution:e.resolution,stencilWrite:!0,stencilRef:0,stencilFunc:d.RvT,stencilFail:d.ce8,stencilZPass:d.ce8});return n.lineWidth=t,n}function wn(s,e){return new d.jyz({vertexShader:d.Vj0["foxglove.line"].vertexShader,fragmentShader:`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `,clipping:!0,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]},linewidth:{value:s},resolution:{value:e.resolution},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},defines:e.worldUnits??!0?{WORLD_UNITS:""}:{}})}function jd(s){const e=he(s);return new d.UY4({vertexColors:!0,size:s.scale.x,sizeAttenuation:!0,transparent:e,depthWrite:!e})}class In extends Ue{constructor(e,t,i,n,r={}){super(e,t,i,n),this.geometry=new xn.z;const{worldUnits:a=!0}=r,o={resolution:this.renderer.input.canvasSize,worldUnits:a},l=xa(t,o);this.linePrepass=new _n.w(this.geometry,l),this.linePrepass.renderOrder=1,this.linePrepass.userData.picking=!1,this.add(this.linePrepass);const c=Ca(t,o);this.line=new _n.w(this.geometry,c),this.line.renderOrder=2;const h=t.scale.x*1.2;this.line.userData.pickingMaterial=wn(h,o),this.add(this.line),this.update(t,i)}dispose(){this.linePrepass.material.dispose(),this.line.material.dispose(),this.line.userData.pickingMaterial.dispose(),this.geometry.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker;let r=n.points.length;r%2!==0&&r--;const a=n.scale.x,o=he(n);o!==he(i)&&(this.linePrepass.material.transparent=o,this.linePrepass.material.depthWrite=!o,this.linePrepass.material.needsUpdate=!0,this.line.material.transparent=o,this.line.material.depthWrite=!o,this.line.material.needsUpdate=!0);const l=this.linePrepass.material;l.lineWidth=a;const c=this.line.material;c.lineWidth=a;const h=(this.geometry.attributes.instanceStart?.count??0)*2;r!==h&&(this.geometry.dispose(),this.geometry=new xn.z,this.linePrepass.geometry=this.geometry,this.line.geometry=this.geometry),this._setPositions(n,r),this._setColors(n,r),this.line.computeLineDistances()}_setPositions(e,t){const i=new Float32Array(3*t);for(let n=0;n<t;n++){const r=e.points[n],a=n*3;i[a+0]=r.x,i[a+1]=r.y,i[a+2]=r.z}this.geometry.setPositions(i)}_setColors(e,t){const i=new Float32Array(4*t);this._markerColorsToLinear(e,t,(r,a)=>{const o=a*4;i[o+0]=r[0],i[o+1]=r[1],i[o+2]=r[2],i[o+3]=r[3]});const n=new d.$TI(i,8,1);this.geometry.setAttribute("instanceColorStart",new d.kB5(n,4,0)),this.geometry.setAttribute("instanceColorEnd",new d.kB5(n,4,4))}}const gs={x:0,y:0},wa={x:0,y:0,z:0},Ia={x:0,y:0,z:0};function kt(s,e,t,i){return t.rectifyPixel(gs,e),i.planarProjectionFactor===0?t.projectPixelTo3dRay(s,gs):i.planarProjectionFactor===1?t.projectPixelTo3dPlane(s,gs):(t.projectPixelTo3dRay(wa,gs),t.projectPixelTo3dPlane(Ia,gs),Vd(s,wa,Ia,i.planarProjectionFactor)),Hd(s,i.distance),s}function Da(s,e){if(!s||!e)return s===e;if(s===e)return!0;if(!(s.header.frame_id===e.header.frame_id&&s.width===e.width&&s.height===e.height&&s.distortion_model===e.distortion_model&&s.binning_x===e.binning_x&&s.binning_y===e.binning_y&&s.roi.x_offset===e.roi.x_offset&&s.roi.y_offset===e.roi.y_offset&&s.roi.height===e.roi.height&&s.roi.width===e.roi.width&&s.roi.do_rectify===e.roi.do_rectify&&s.D.length===e.D.length))return!1;for(let t=0;t<s.D.length;t++)if(s.D[t]!==e.D[t])return!1;for(let t=0;t<9;t++)if(s.K[t]!==e.K[t])return!1;for(let t=0;t<9;t++)if(s.R[t]!==e.R[t])return!1;for(let t=0;t<12;t++)if(s.P[t]!==e.P[t])return!1;return!0}function Ma(s){const e=s.D??s.d,t=s.K??s.k,i=s.R??s.r,n=s.P??s.p,r=e?.length??0,a=t?.length??0,o=i?.length??0,l=n?.length??0;return{header:"timestamp"in s?{stamp:ge(s.timestamp),frame_id:s.frame_id??""}:Fe(s.header),height:s.height??0,width:s.width??0,distortion_model:s.distortion_model??"",D:r>0?e:[],K:a===9?t:[],R:o===9?i:[],P:l===12?n:[],binning_x:s.binning_x??0,binning_y:s.binning_y??0,roi:$d(s.roi)}}function $d(s){return s?{x_offset:s.x_offset??0,y_offset:s.y_offset??0,height:s.height??0,width:s.width??0,do_rectify:s.do_rectify??!1}:{x_offset:0,y_offset:0,height:0,width:0,do_rectify:!1}}function Vd(s,e,t,i){s.x=e.x+(t.x-e.x)*i,s.y=e.y+(t.y-e.y)*i,s.z=e.z+(t.z-e.z)*i}function Hd(s,e){s.x*=e,s.y*=e,s.z*=e}var Wd="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Cameras.ts";const Yd=x.ZP.getLogger(Wd),Ea=1,Aa=0,Pa=.01,Zd={r:124/255,g:107/255,b:1,a:1},La=pe(Zd),Dn="CameraModel",Mn={visible:!1,frameLocked:!0,distance:Ea,planarProjectionFactor:Aa,width:Pa,color:La};class Kd extends fe{dispose(){this.userData.lines?.dispose(),super.dispose()}details(){return this.userData.originalMessage??{}}}class Xd extends ie{constructor(e){super("foxglove.Cameras",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const{cameraInfo:a,receiveTime:o,originalMessage:l}=r.userData;if(a){const c=this.renderer.config.topics[n];this._updateCameraInfoRenderable(r,a,l,o,c)}}},this.handleCameraInfo=t=>{const i=t.topic,n=Ma(t.message),r=(0,m.toNanoSec)(t.receiveTime);let a=this.renderables.get(i);if(!a){const o=(0,m.toNanoSec)(n.header.stamp),l=this.renderer.normalizeFrameId(n.header.frame_id),c=this.renderer.config.topics[i],h={...Mn,...c};a=new Kd(i,this.renderer,{receiveTime:r,messageTime:o,frameId:l,pose:Q(),settingsPath:["topics",i],settings:h,topic:i,cameraInfo:void 0,originalMessage:void 0,cameraModel:void 0,lines:void 0}),this.add(a),this.renderables.set(i,a)}this._updateCameraInfoRenderable(a,n,t.message,r,a.userData.settings)},e.addSchemaSubscriptions(Vt,this.handleCameraInfo),e.addSchemaSubscriptions(Bt,this.handleCameraInfo)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!(Y(n,Vt)||Y(n,Bt)))continue;const r=e[n.name]??{},a={distance:{label:"Distance",input:"number",placeholder:String(Ea),step:.1,precision:K,value:r.distance},planarProjectionFactor:{label:"Planar Projection Factor",input:"number",placeholder:String(Aa),min:0,max:1,step:.1,precision:2,value:r.planarProjectionFactor},width:Sa("Line Width",r.width,Pa),color:{label:"Color",input:"rgba",value:r.color??La}};i.push({path:["topics",n.name],node:{icon:"Camera",fields:a,visible:r.visible??Mn.visible,handler:t,order:n.name.toLocaleLowerCase()}})}return i}_updateCameraInfoRenderable(e,t,i,n,r){const a=e.userData.settings,o={...Mn,...r},l=o.color===a.color&&o.distance===a.distance&&o.planarProjectionFactor===a.planarProjectionFactor&&o.width===a.width,c=e.userData.topic;e.userData.receiveTime=n,e.userData.messageTime=(0,m.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.settings=o;const h=Da(e.userData.cameraInfo,t);if(!h)if(e.userData.cameraInfo=t,e.userData.originalMessage=i,t.P.length===12)try{e.userData.cameraModel=new be.HL(t)}catch(f){const u=f;this.renderer.settings.errors.addToTopic(c,Dn,u.message),e.userData.cameraModel=void 0,e.userData.lines&&(e.remove(e.userData.lines),e.userData.lines.dispose(),e.userData.lines=void 0)}else this.renderer.settings.errors.addToTopic(c,Dn,`P has length ${t.P.length}, not a 3x4 matrix`);if(e.userData.cameraModel?.P!=null&&(!h||!l||!e.userData.lines)){this.renderer.settings.errors.removeFromTopic(c,Dn);const f=Jd(t,e.userData.cameraModel,e.userData.settings);e.userData.lines?e.userData.lines.update(f,void 0):(e.userData.lines=new In(c,f,void 0,this.renderer),e.add(e.userData.lines))}}}function Jt(){return{x:0,y:0,z:0}}function Jd(s,e,t,i=10){const n={x:0,y:0},r=kt(Jt(),n,e,t);n.x=s.width,n.y=0;const a=kt(Jt(),n,e,t);n.x=0,n.y=s.height;const o=kt(Jt(),n,e,t);n.x=s.width,n.y=s.height;const l=kt(Jt(),n,e,t),c={x:0,y:0,z:0},h=[c,r,c,a,c,l,c,o];return h.push(r),Ra(h,0,s,e,i,t),h.push(a),h.push(o),Ra(h,s.height,s,e,i,t),h.push(l),h.push(r),Na(h,0,s,e,i,t),h.push(o),h.push(a),Na(h,s.width,s,e,i,t),h.push(l),{header:s.header,ns:"",id:0,type:A.LINE_LIST,action:me.ADD,pose:Q(),scale:{x:t.width,y:t.width,z:t.width},color:$(de(),t.color),lifetime:Tt,frame_locked:!0,points:h,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function Ra(s,e,t,i,n,r){const a={x:0,y:0};for(let o=1;o<n;o++){a.x=o/n*t.width,a.y=e;const l=kt(Jt(),a,i,r);s.push(l,l)}}function Na(s,e,t,i,n,r){const a={x:0,y:0};for(let o=1;o<n;o++){a.x=e,a.y=o/n*t.height;const l=kt(Jt(),a,i,r);s.push(l,l)}}var si=v(59677),ii=v(11932),Qd=v(40740);const ys=.154,Oa=.02,Fa=.046,Ua=.05,bs=ys+Fa,ka=new d.Ilk(10238280).convertSRGBToLinear(),za=new d.Ilk(8969476).convertSRGBToLinear(),Ga=new d.Ilk(2855163).convertSRGBToLinear(),Ba={r:1,g:1,b:1,a:1},Qt=Math.PI/2,ht=new d.yGw,Ct=new d.Pa4;class vs extends d.Tme{constructor(e,t){super(),this.name=e,this.renderer=t;const i=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaft-${this.renderer.maxLod}`,()=>qd(this.renderer.maxLod));this.shaftMesh=new d.SPe(i,ja(Ba),3),this.shaftMesh.castShadow=!0,this.shaftMesh.receiveShadow=!0;const n=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-head-${this.renderer.maxLod}`,()=>eh(this.renderer.maxLod));this.headMesh=new d.SPe(n,ja(Ba),3),this.headMesh.castShadow=!0,this.headMesh.receiveShadow=!0,vs.UpdateInstances(this.shaftMesh,this.headMesh,0),this.add(this.shaftMesh),this.add(this.headMesh)}dispose(){this.shaftMesh.material.dispose(),this.shaftMesh.dispose(),this.headMesh.material.dispose(),this.headMesh.dispose()}static UpdateInstances(e,t,i){const n=i*3+0,r=i*3+1,a=i*3+2;Ct.set(ys,Oa,Oa),e.setMatrixAt(n,ht.identity().scale(Ct)),e.setMatrixAt(r,ht.makeRotationZ(Qt).scale(Ct)),e.setMatrixAt(a,ht.makeRotationY(-Qt).scale(Ct)),Ct.set(Fa,Ua,Ua),ht.identity().scale(Ct).setPosition(ys,0,0),t.setMatrixAt(n,ht),ht.makeRotationZ(Qt).scale(Ct).setPosition(0,ys,0),t.setMatrixAt(r,ht),ht.makeRotationY(-Qt).scale(Ct).setPosition(0,0,ys),t.setMatrixAt(a,ht),e.setColorAt(n,ka),e.setColorAt(r,za),e.setColorAt(a,Ga),t.setColorAt(n,ka),t.setColorAt(r,za),t.setColorAt(a,Ga)}}function qd(s){const e=ba(s),t=new d.fHI(.5,.5,1,e,1,!1);return t.rotateZ(-Qt),t.translate(.5,0,0),t.computeBoundingSphere(),t}function eh(s){const e=va(s),t=new d.b_z(.5,1,e,1,!1);return t.rotateZ(-Qt),t.translate(.5,0,0),t.computeBoundingSphere(),t}function ja(s){return new d.Wid({color:new d.Ilk(s.r,s.g,s.b).convertSRGBToLinear(),metalness:0,roughness:1,dithering:!0,opacity:s.a,transparent:s.a<1,depthWrite:s.a===1})}const ni=1;class th extends ie{constructor(e){super("foxglove.SceneSettings",e),this.handleSettingsAction=t=>{if(t.action==="perform-node-action"&&t.payload.id==="reset-scene"){this.renderer.updateConfig(a=>{a.scene={}}),this.updateSettingsTree();return}if(t.action!=="update"||t.payload.path.length===0)return;const i=t.payload.path,n=i[0],r=t.payload.value;if(n==="scene"){if(this.renderer.updateConfig(a=>(0,B.set)(a,i,r)),i[1]==="backgroundColor"){const a=r;this.renderer.setColorScheme(this.renderer.colorScheme,a)}else if(i[1]==="labelScaleFactor"){const a=r;this.renderer.labelPool.setScaleFactor(a??ni)}}else return;this.updateSettingsTree()},e.labelPool.scaleFactor=e.config.scene.labelScaleFactor??ni}dispose(){super.dispose()}settingsNodes(){const e=this.renderer.config,t=this.handleSettingsAction;return[{path:["scene"],node:{label:(0,E.t)("threeDee:scene"),actions:[{type:"action",id:"reset-scene",label:(0,E.t)("threeDee:reset")}],fields:{enableStats:{label:(0,E.t)("threeDee:renderStats"),input:"boolean",value:e.scene.enableStats},backgroundColor:{label:(0,E.t)("threeDee:background"),input:"rgb",value:e.scene.backgroundColor},labelScaleFactor:{label:(0,E.t)("threeDee:labelScale"),help:(0,E.t)("threeDee:labelScaleHelp"),input:"number",min:0,step:.1,precision:2,value:e.scene.labelScaleFactor,placeholder:String(ni)},ignoreColladaUpAxis:{label:(0,E.t)("threeDee:ignoreColladaUpAxis"),help:(0,E.t)("threeDee:ignoreColladaUpAxisHelp"),input:"boolean",value:e.scene.ignoreColladaUpAxis,error:(e.scene.ignoreColladaUpAxis??!1)!==this.renderer.modelCache.options.ignoreColladaUpAxis?(0,E.t)("threeDee:takeEffectAfterReboot"):void 0},meshUpAxis:{label:(0,E.t)("threeDee:meshUpAxis"),help:(0,E.t)("threeDee:meshUpAxisHelp"),input:"select",value:e.scene.meshUpAxis??bn,options:[{label:(0,E.t)("threeDee:YUp"),value:"y_up"},{label:(0,E.t)("threeDee:ZUp"),value:"z_up"}],error:(e.scene.meshUpAxis??bn)!==this.renderer.modelCache.options.meshUpAxis?(0,E.t)("threeDee:takeEffectAfterReboot"):void 0}},defaultExpansionState:"collapsed",handler:t}}]}}const sh=6,ih=Math.PI/2,En=!1,ri=1,An=2,Pn="#ffff00",ai=.2,$a={visible:!0,frameLocked:!0,xyzOffset:[0,0,0],rpyOffset:[0,0,0]};class nh extends fe{dispose(){this.renderer.labelPool.release(this.userData.label),super.dispose()}details(){const e=this.renderer.transformTree.frame(this.userData.frameId),t=e?.parent(),i=e?.root();return{child_frame_id:e?.displayName()??"<unknown>",parent_frame_id:t?.displayName()??"<unknown>",fixed_frame_id:i?.displayName()??"<unknown>"}}}const rh=new d.Pa4,ah=new d.Pa4,oh=[0n,He.Identity()],Va=[0n,He.Identity()],Ha=new d._fP,oi=new d.USm,Wa=["transforms",""];class lh extends ie{constructor(e){super("foxglove.FrameAxes",e),this.labelForegroundColor=1,this.labelBackgroundColor=new d.Ilk,this.handleSettingsAction=r=>{const a=r.payload.path,o=l=>{for(const c of this.renderables.values())c.userData.settings.visible=l;this.renderer.updateConfig(c=>{var h;for(const f of this.renderables.keys()){const u=f==="settings"?"$settings":`frame:${f}`;(h=c.transforms)[u]??(h[u]={}),c.transforms[u].visible=l}}),this.updateSettingsTree()};if(r.action==="perform-node-action"){r.payload.id==="show-all"?o(!0):r.payload.id==="hide-all"&&o(!1);return}if(a.length===3)if(a[1]==="settings"){const l=a[2],c=r.payload.value;if(this.saveSetting(["scene","transforms",l],c),l==="editable")this._updateFrameAxes();else if(l==="showLabel"){const h=c;this.setLabelVisible(h??!0)}else if(l==="labelSize"){const h=c;this.setLabelSize(h??ai)}else if(l==="axisScale"){const h=c;this.setAxisScale(h??ri)}else if(l==="lineWidth"){const h=c;this.setLineWidth(h??An)}else if(l==="lineColor"){const h=c;this.setLineColor(h??Pn)}}else{this.saveSetting(a,r.payload.value);const l=a[1],c=l.replace(/^frame:/,""),h=this.renderables.get(c);if(h){const f=this.renderer.config.transforms[l];h.userData.settings={...$a,...f},this._updateFrameAxis(h)}}},this.handleTransformTreeUpdated=()=>{for(const r of this.renderer.transformTree.frames().keys())this._addFrameAxis(r);this.updateSettingsTree()};const t=this.renderer.config.scene.transforms?.lineWidth??An,i=Yi(new d.Ilk,this.renderer.config.scene.transforms?.lineColor??Pn);this.lineMaterial=new Qd.Y({linewidth:t}),this.lineMaterial.color=i;const n={resolution:e.input.canvasSize,worldUnits:!1};this.lineGeometry=this.renderer.sharedGeometry.getGeometry(this.constructor.name,ch),this.linePickingMaterial=wn(sh,n),e.on("transformTreeUpdated",this.handleTransformTreeUpdated)}dispose(){this.renderer.off("transformTreeUpdated",this.handleTransformTreeUpdated),this.lineMaterial.dispose(),this.linePickingMaterial.dispose(),super.dispose()}removeAllRenderables(){}settingsNodes(){const e=this.renderer.config,t=e.transforms,i=this.handleSettingsAction,n=this.renderer.coordinateFrameList.length,r={settings:{label:(0,E.t)("threeDee:settings"),defaultExpansionState:"collapsed",order:0,fields:{editable:{label:(0,E.t)("threeDee:editable"),input:"boolean",value:e.scene.transforms?.editable??En},showLabel:{label:(0,E.t)("threeDee:labels"),input:"boolean",value:e.scene.transforms?.showLabel??!0},...(e.scene.transforms?.showLabel??!0)&&{labelSize:{label:(0,E.t)("threeDee:labelSize"),input:"number",min:0,step:.01,precision:2,placeholder:String(ai),value:e.scene.transforms?.labelSize}},axisScale:Ta((0,E.t)("threeDee:axisScale"),e.scene.transforms?.axisScale,ri),lineWidth:{label:(0,E.t)("threeDee:lineWidth"),input:"number",min:0,step:.5,precision:1,value:e.scene.transforms?.lineWidth,placeholder:String(An)},lineColor:{label:(0,E.t)("threeDee:lineColor"),input:"rgb",value:e.scene.transforms?.lineColor??Pn},enablePreloading:{label:(0,E.t)("threeDee:enablePreloading"),input:"boolean",value:e.scene.transforms?.enablePreloading??!0}}}};let a=1;for(const{label:o,value:l}of this.renderer.coordinateFrameList){const c=`frame:${l}`,h=t[c]??{},f=this.renderer.transformTree.frame(l),u=dh(f,this.renderer.currentTime,e);Wa[1]=c,r[c]={label:o,fields:u,visible:h.visible??!0,order:a++,defaultExpansionState:"collapsed",error:this.renderer.settings.errors.errors.errorAtPath(Wa)}}return[{path:["transforms"],node:{label:`${(0,E.t)("threeDee:transforms")}${n>0?` (${n})`:""}`,actions:[{id:"show-all",type:"action",label:(0,E.t)("threeDee:showAll")},{id:"hide-all",type:"action",label:(0,E.t)("threeDee:hideAll")}],handler:i,children:r}}]}startFrame(e,t,i){this.lineMaterial.resolution=this.renderer.input.canvasSize,this.updateSettingsTree(),super.startFrame(e,t,i);const n=this.renderer.config.scene.transforms?.axisScale??ri,r=bs*n,a=this.renderer.config.scene.transforms?.labelSize??ai,o=this.renderer.config.scene.labelScaleFactor??ni,l=r+a*o*1.5;for(const c of this.renderables.values()){const h=c.userData.label,f=c.userData.parentLine,p=this.renderer.transformTree.frame(c.userData.frameId)?.parent(),g=ah;if(c.getWorldPosition(g),f.visible=!1,p){const b=this.renderables.get(p.id);if(b?.visible===!0){const T=rh;b.getWorldPosition(T);const _=T.distanceTo(g);f.lookAt(T),f.rotateY(-ih),f.scale.set(_,1,1),f.visible=!0}}g.z+=l,c.worldToLocal(g),h.position.set(g.x,g.y,g.z)}}setColorScheme(e,t){const i=e==="dark"?1:0;this.labelForegroundColor=i,this.labelBackgroundColor.setRGB(1-i,1-i,1-i),t&&(this.labelForegroundColor=Zi(t.r,t.g,t.b)>.5?0:1,this.labelBackgroundColor.copy(t));for(const n of this.renderables.values())n.userData.label.setColor(this.labelForegroundColor,this.labelForegroundColor,this.labelForegroundColor),n.userData.label.setBackgroundColor(this.labelBackgroundColor.r,this.labelBackgroundColor.g,this.labelBackgroundColor.b)}setLabelVisible(e){for(const t of this.renderables.values())t.userData.label.visible=e}setLabelSize(e){for(const t of this.renderables.values())t.userData.label.setLineHeight(e)}setAxisScale(e){for(const t of this.renderables.values())t.userData.axis.scale.set(e,e,e)}setLineWidth(e){this.lineMaterial.linewidth=e}setLineColor(e){Yi(this.lineMaterial.color,e)}_addFrameAxis(e){if(this.renderables.has(e))return;const t=this.renderer.config,i=this.renderer.transformTree.frame(e);if(!i)throw new Error(`CoordinateFrame "${e}" was not created`);const n=i.displayName(),r=this.renderer.labelPool.acquire();r.setBillboard(!0),r.setText(n),r.setLineHeight(t.scene.transforms?.labelSize??ai),r.visible=t.scene.transforms?.showLabel??!0,r.setColor(this.labelForegroundColor,this.labelForegroundColor,this.labelForegroundColor),r.setBackgroundColor(this.labelBackgroundColor.r,this.labelBackgroundColor.g,this.labelBackgroundColor.b);const a=`frame:${e}`,o=t.transforms[a],l={...$a,...o},c=new si.w(this.lineGeometry,this.lineMaterial);c.castShadow=!0,c.receiveShadow=!1,c.userData.pickingMaterial=this.linePickingMaterial,c.visible=!1;const h=new vs(e,this.renderer),f=t.scene.transforms?.axisScale??ri;h.scale.set(f,f,f);const u=new nh(e,this.renderer,{receiveTime:0n,messageTime:0n,frameId:e,pose:Q(),settingsPath:["transforms",a],settings:l,axis:h,label:r,parentLine:c});u.add(h),u.add(r),u.add(c),this.add(u),this.renderables.set(e,u),this._updateFrameAxis(u)}_updateFrameAxes(){for(const e of this.renderables.values())this._updateFrameAxis(e)}_updateFrameAxis(e){const t=this.renderer.transformTree.getOrCreateFrame(e.userData.frameId);if(!(this.renderer.config.scene.transforms?.editable??En)){t.offsetPosition=void 0,t.offsetEulerDegrees=void 0;return}const n=`frame:${e.userData.frameId}`;t.offsetPosition=Ja(this.renderer.config.transforms[n]?.xyzOffset),t.offsetEulerDegrees=Ja(this.renderer.config.transforms[n]?.rpyOffset)}}function ch(){const s=new ii.L;return s.setPositions([0,0,0,1,0,0]),s}function dh(s,e,t){const i=s?`frame:${s.id}`:"",n=s?.parent()?.id;if(n==null)return{parent:{label:"Parent",input:"string",readonly:!0,value:"<root>"}};const r=String(s?.transformsSize()??0);let a,o,l;if(e!=null&&s&&s.findClosestTransforms(oh,Va,e,us)){const[h,f]=Va;a=h<e?fh(e-h):"0 ns";const u=f.position(),p=f.rotation();o=[qt(u[0],3),qt(u[1],3),qt(u[2],3)],Ha.set(p[0],p[1],p[2],p[3]),oi.setFromQuaternion(Ha,"XYZ"),l=[qt(d.M8C.radToDeg(oi.x),3),qt(d.M8C.radToDeg(oi.y),3),qt(d.M8C.radToDeg(oi.z),3)]}const c={parent:{label:"Parent",input:"string",readonly:!0,value:n},age:{label:"Age",input:"string",readonly:!0,value:a},historySize:{label:"History Size",input:"string",readonly:!0,value:r},xyz:{label:"Translation",input:"vec3",precision:K,labels:["X","Y","Z"],readonly:!0,value:o},rpy:{label:"Rotation",input:"vec3",precision:it,labels:["R","P","Y"],readonly:!0,value:l}};if(t.scene.transforms?.editable??En){let h=t.transforms[i]?.xyzOffset,f=t.transforms[i]?.rpyOffset;h&&Xa(h)&&(h=void 0),f&&Xa(f)&&(f=void 0),c.xyzOffset={label:"Translation Offset",input:"vec3",precision:K,step:.1,labels:["X","Y","Z"],value:h},c.rpyOffset={label:"Rotation Offset",input:"vec3",precision:it,step:1,min:-180,max:180,labels:["R","P","Y"],value:f}}return c}const hh=BigInt(1e5),uh=BigInt(1e6),Ya=BigInt(1e9),Za=BigInt(6e10),Ka=BigInt(36e11);function fh(s){const e=ph(s);return e<hh?`${s} ns`:e<Ya?`${Number(s/uh).toFixed(1)} ms`:e<Za?`${Number(s/Ya).toFixed(1)} s`:e<Ka?`${Number(s/Za).toFixed(1)} min`:`${Number(s/Ka).toFixed(1)} hr`}function ph(s){return s<0n?-s:s}function qt(s,e){return Number(s.toFixed(e))}function Xa(s,e=1e-6){return Math.abs(s[0])<e&&Math.abs(s[1])<e&&Math.abs(s[2])<e}function Ja(s){if(!s)return;const[e=0,t=0,i=0]=s;if(!(e===0&&t===0&&i===0))return[e,t,i]}const mh=["general","followTf"];class gh extends ie{constructor(e){super("foxglove.FrameSettings",e),this.handleSettingsAction=t=>{if(t.action!=="update"||t.payload.path.length===0)return;const i=t.payload.path,n=i[0],r=t.payload.value;if(n==="general"){if(i[1]==="followTf"){const a=r;this.renderer.updateConfig(o=>{o.followTf=a}),this.renderer.followFrameId=a,this.renderer.settings.errors.clearPath(["general","followTf"])}else if(i[1]==="followMode"){const a=r;this.renderer.updateConfig(o=>{o.followMode==="follow-none"?(o.cameraState.targetOffset=[...Kt.d.targetOffset],o.cameraState.thetaOffset=Kt.d.thetaOffset):a==="follow-pose"&&(o.cameraState.thetaOffset=Kt.d.thetaOffset),o.followMode=a}),this.renderer.updateFollowMode(a)}}else return;this.updateSettingsTree()},this.handleTransformTreeUpdated=()=>{this.updateSettingsTree()},this.handleErrorChange=()=>{this.updateSettingsTree()},e.on("transformTreeUpdated",this.handleTransformTreeUpdated),e.settings.errors.on("update",this.handleErrorChange),e.settings.errors.on("clear",this.handleErrorChange),e.settings.errors.on("remove",this.handleErrorChange)}dispose(){this.renderer.off("transformTreeUpdated",this.handleTransformTreeUpdated),this.renderer.settings.errors.off("update",this.handleErrorChange),this.renderer.settings.errors.off("clear",this.handleErrorChange),this.renderer.settings.errors.off("remove",this.handleErrorChange),super.dispose()}settingsNodes(){const e=this.renderer.config,t=this.handleSettingsAction;let i=this.renderer.coordinateFrameList;const n=this.renderer.followFrameId;n!=null&&!this.renderer.transformTree.hasFrame(n)&&(i=[{label:J.DisplayName(n),value:n},...i]);const r=yh([this.renderer.followFrameId,e.followTf,this.renderer.renderFrameId],i),a=this.renderer.settings.errors.errors.errorAtPath(mh),o=[{label:(0,E.t)("threeDee:pose"),value:"follow-pose"},{label:(0,E.t)("threeDee:position"),value:"follow-position"},{label:(0,E.t)("threeDee:fixed"),value:"follow-none"}],l=this.renderer.followMode;return[{path:["general"],node:{label:(0,E.t)("threeDee:frame"),fields:{followTf:{label:(0,E.t)("threeDee:displayFrame"),help:(0,E.t)("threeDee:displayFrameHelp"),input:"select",options:i,value:r,error:a},followMode:{label:(0,E.t)("threeDee:followMode"),help:(0,E.t)("threeDee:followModeHelp"),input:"select",options:o,value:l}},defaultExpansionState:"expanded",handler:t}}]}}function yh(s,e){return s.filter(i=>e.some(n=>n.value===i))[0]}var bh="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Grids.ts";const vh=x.ZP.getLogger(bh),Ts="foxglove.Grid",Qa=10,qa=10,eo=1,to="#248eff",Th=4096,Sh={worldUnits:!1},Ln={visible:!0,frameLocked:!0,label:"Grid",instanceId:"invalid",layerId:Ts,frameId:void 0,size:Qa,divisions:qa,lineWidth:eo,color:to,position:[0,0,0],rotation:[0,0,0]};class _h extends fe{dispose(){this.userData.lineList.dispose(),super.dispose()}}class xh extends ie{constructor(e){super("foxglove.Grids",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action==="perform-node-action"){if(i.length===2&&t.payload.id==="delete"){const a=i[1];this.renderer.updateConfig(o=>{delete o.layers[a]}),this._updateGrid(a,void 0),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}return}if(i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderer.config.layers[n];this._updateGrid(n,r)},this.handleAddGrid=t=>{vh.info(`Creating ${Ts} layer ${t}`);const i={...Ln,instanceId:t};this.renderer.updateConfig(n=>{const a=1+((0,B.maxBy)(Object.values(n.layers),o=>o?.order)?.order??0);n.layers[t]={...i,order:a}}),this._updateGrid(t,i),this.updateSettingsTree()},this.handleTransformTreeUpdated=()=>{this.updateSettingsTree()},e.addCustomLayerAction({layerId:Ts,label:(0,E.t)("threeDee:addGrid"),icon:"Grid",handler:this.handleAddGrid}),e.on("transformTreeUpdated",this.handleTransformTreeUpdated);for(const[t,i]of Object.entries(e.config.layers))i?.layerId===Ts&&this._updateGrid(t,i)}dispose(){this.renderer.off("transformTreeUpdated",this.handleTransformTreeUpdated),super.dispose()}removeAllRenderables(){}settingsNodes(){const e=this.handleSettingsAction,t=[];for(const[i,n]of Object.entries(this.renderer.config.layers)){if(n?.layerId!==Ts)continue;const r=n,a=[{label:"<Display frame>",value:void 0},...this.renderer.coordinateFrameList],o={frameId:{label:(0,E.t)("threeDee:frame"),input:"select",options:a,value:r.frameId},size:{label:(0,E.t)("threeDee:size"),input:"number",min:0,step:.5,precision:K,value:r.size,placeholder:String(Qa)},divisions:{label:(0,E.t)("threeDee:divisions"),input:"number",min:1,max:Th,step:1,precision:0,value:r.divisions,placeholder:String(qa)},lineWidth:{label:(0,E.t)("threeDee:lineWidth"),input:"number",min:0,step:.5,precision:1,value:r.lineWidth,placeholder:String(eo)},color:{label:(0,E.t)("threeDee:color"),input:"rgba",value:r.color??to},position:{label:(0,E.t)("threeDee:position"),input:"vec3",labels:["X","Y","Z"],precision:K,value:r.position??[0,0,0]},rotation:{label:(0,E.t)("threeDee:rotation"),input:"vec3",labels:["R","P","Y"],precision:it,value:r.rotation??[0,0,0]}};t.push({path:["layers",i],node:{label:r.label??(0,E.t)("threeDee:grid"),icon:"Grid",fields:o,visible:r.visible??Ln.visible,actions:[{type:"action",id:"delete",label:(0,E.t)("threeDee:delete")}],order:n.order,handler:e}}),this.renderables.has(i)||this._updateGrid(i,r)}return t}startFrame(e,t,i){for(const n of this.renderables.values())n.userData.frameId=n.userData.settings.frameId??t;super.startFrame(e,t,i)}_updateGrid(e,t){let i=this.renderables.get(e);if(t==null){i!=null&&(i.userData.lineList.dispose(),this.remove(i),this.renderables.delete(e));return}const n={...Ln,...t};i||(i=this._createRenderable(e,n),i.userData.pose=Qr(n.position,n.rotation));const r=i.userData.settings,a=n.size===r.size&&n.divisions===r.divisions&&n.frameId===r.frameId&&n.lineWidth===r.lineWidth&&n.color===r.color;if(i.userData.settings=n,!a){const o=so(n);i.userData.lineList.update(o,void 0)}(!Nr(n.position,r.position)||!Nr(n.rotation,r.rotation))&&(i.userData.pose=Qr(n.position,n.rotation))}_createRenderable(e,t){const i=so(t),n=`${e}:LINE_LIST`,r=new In(n,i,void 0,this.renderer,Sh),a=new _h(e,this.renderer,{receiveTime:0n,messageTime:0n,frameId:"",pose:Q(),settingsPath:["layers",e],settings:t,lineList:r});return a.add(r),this.add(a),this.renderables.set(e,a),a}}function so(s){const{size:e,divisions:t,color:i}=s,n=e/t,r=e/2,a=[];for(let l=0;l<=t;l++){const c=-r+l*n;a.push({x:c,y:-r,z:0}),a.push({x:c,y:r,z:0}),a.push({x:-r,y:c,z:0}),a.push({x:r,y:c,z:0})}const o={r:1,g:1,b:1,a:1};return $(o,i),{header:{frame_id:"",stamp:Tt},ns:"",id:0,type:A.LINE_LIST,action:me.ADD,pose:Q(),scale:{x:s.lineWidth,y:1,z:1},color:o,lifetime:Tt,frame_locked:!0,points:a,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}const Rn=["imageMode","imageTopic"],Nn=["imageMode","calibrationTopic"],io="IMAGE_TOPIC_UNAVAILABLE",no="CALIBRATION_TOPIC_UNAVAILABLE";class Ch extends ie{constructor(e){super("foxglove.ImageMode",e),this.handleSettingsAction=t=>{if(t.action!=="update"||t.payload.path.length===0)return;const i=t.payload.path,n=i[0],r=t.payload.value;if(n==="imageMode")this.renderer.updateConfig(a=>(0,B.set)(a,i,r));else return;this.updateSettingsTree()},this.handleErrorChange=()=>{this.updateSettingsTree()},e.settings.errors.on("update",this.handleErrorChange),e.settings.errors.on("clear",this.handleErrorChange),e.settings.errors.on("remove",this.handleErrorChange)}dispose(){this.renderer.settings.errors.off("update",this.handleErrorChange),this.renderer.settings.errors.off("clear",this.handleErrorChange),this.renderer.settings.errors.off("remove",this.handleErrorChange),super.dispose()}settingsNodes(){const e=this.renderer.config,t=this.handleSettingsAction,{imageTopic:i,calibrationTopic:n}=e.imageMode,r=(0,hs.DZ)(this.renderer.topics??[],_=>{if(Y(_,Ws)||Y(_,Ys)||Y(_,zs)||Y(_,Gs))return{label:_.name,value:_.name}}),a=(0,hs.DZ)(this.renderer.topics??[],_=>{if(Y(_,Vt)||Y(_,Bt))return{label:_.name,value:_.name}});i&&!r.some(_=>_.value===i)?this.renderer.settings.errors.add(Rn,io,`${i} is not available`):this.renderer.settings.errors.remove(Rn,io),n&&!a.some(_=>_.value===n)?this.renderer.settings.errors.add(Nn,no,`${n} is not available`):this.renderer.settings.errors.remove(Nn,no);const o=this.renderer.settings.errors.errors.errorAtPath(Rn),l=this.renderer.settings.errors.errors.errorAtPath(Nn),c=!1,h=!1,f=!1,u=!1,p=!1,g=0,b=void 0,T=void 0;return[{path:["imageMode"],node:{label:"General",defaultExpansionState:"expanded",handler:t,fields:{imageTopic:{label:"Topic",input:"select",value:i,options:r,error:o},calibrationTopic:{label:"Calibration",input:"select",value:e.imageMode.calibrationTopic,options:a,error:l},TODO_transformMarkers:{readonly:!0,input:"boolean",label:"\u{1F6A7} Transform markers",value:c,help:c?"Markers are being transformed by Foxglove Studio based on the camera model. Click to turn it off.":"Markers can be transformed by Foxglove Studio based on the camera model. Click to turn it on."},TODO_synchronize:{readonly:!0,input:"boolean",label:"\u{1F6A7} Synchronize timestamps",value:h},TODO_smooth:{readonly:!0,input:"boolean",label:"\u{1F6A7} Bilinear smoothing",value:f},TODO_flipHorizontal:{readonly:!0,input:"boolean",label:"\u{1F6A7} Flip horizontal",value:u},TODO_flipVertical:{readonly:!0,input:"boolean",label:"\u{1F6A7} Flip vertical",value:p},TODO_rotation:{readonly:!0,input:"select",label:"\u{1F6A7} Rotation",value:g,options:[{label:"0\xB0",value:0},{label:"90\xB0",value:90},{label:"180\xB0",value:180},{label:"270\xB0",value:270}]},TODO_minValue:{readonly:!0,input:"number",label:"\u{1F6A7} Min (depth images)",placeholder:"0",value:b},TODO_maxValue:{readonly:!0,input:"number",label:"\u{1F6A7} Max (depth images)",placeholder:"10000",value:T}}}}]}}var wh="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Images.ts";const Ih=x.ZP.getLogger(wh),li="NoCameraInfo",ro="CreateBitmap",ao="CameraModel",Dh=512,oo=1,lo=0,On={visible:!1,frameLocked:!0,cameraInfoTopic:void 0,distance:oo,planarProjectionFactor:lo,color:"#ffffff"};class Mh extends fe{dispose(){this.userData.texture?.dispose(),this.userData.material?.dispose(),this.userData.geometry?.dispose(),super.dispose()}details(){return{image:this.userData.image,camera_info:this.userData.cameraInfo}}}class Eh extends ie{constructor(e){super("foxglove.Images",e),this.cameraInfoTopics=new Set,this.cameraInfoToImageTopics=new hs.kJ,this.cameraInfoByTopic=new Map,this.lastTopics=void 0,this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;const n=i[1],a=this.renderer.config.topics[n]?.cameraInfoTopic;this.saveSetting(i,t.payload.value);const o=this.renderer.config.topics[n],l=o?.cameraInfoTopic;if(l!==a&&l!=null&&this.cameraInfoToImageTopics.set(l,n),!(a!=null&&l!==a)){const _=this.renderables.get(n);if(!_)return;const{image:R,cameraModel:N,receiveTime:P}=_.userData;if(!R||!N)return;this._updateImageRenderable(_,R,N,P,o);return}this.cameraInfoToImageTopics.delete(a,n);const h=this.renderables.get(n);if(!h)return;const{image:f,receiveTime:u,frameId:p}=h.userData;h.dispose(),this.renderables.delete(n);const g=this._getImageRenderable(n,u,f,p);if(!l)return;const b=this.cameraInfoByTopic.get(l);if(!b){this.renderer.settings.errors.addToTopic(n,li,`No CameraInfo received on ${l}`);return}const T=this._recomputeCameraModel(g,b);f&&T&&this._updateImageRenderable(g,f,T,u,o)},this.cameraInfoShouldSubscribe=t=>{for(const i of Object.values(this.renderer.config.topics)){const n=i;if(n.cameraInfoTopic===t&&n.visible===!0)return!0}return!1},this.handleRosRawImage=t=>{this.handleImage(t,Fh(t.message))},this.handleRosCompressedImage=t=>{this.handleImage(t,Uh(t.message))},this.handleRawImage=t=>{this.handleImage(t,kh(t.message))},this.handleCompressedImage=t=>{this.handleImage(t,zh(t.message))},this.handleImage=(t,i)=>{this._updateCameraInfoTopics();const n=t.topic,r=(0,m.toNanoSec)(t.receiveTime),a="header"in i?i.header.frame_id:i.frame_id,o=this._getImageRenderable(n,r,i,a),l=o.userData.settings;if(l.cameraInfoTopic==null){const f=l.cameraInfoTopic=Nh(n,this.cameraInfoTopics);if(f==null){this.renderer.settings.errors.addToTopic(n,li,"No CameraInfo topic found");return}this.cameraInfoToImageTopics.set(f,n),this.renderer.updateConfig(u=>{const p={...l};p.cameraInfoTopic=f,u.topics[n]=p}),this.updateSettingsTree()}if(!l.cameraInfoTopic)return;const c=this.cameraInfoByTopic.get(l.cameraInfoTopic);if(!c){this.renderer.settings.errors.addToTopic(n,li,`No CameraInfo received on ${l.cameraInfoTopic}`);return}const h=this._recomputeCameraModel(o,c);h&&this._updateImageRenderable(o,i,h,r,l)},this.handleCameraInfo=t=>{const i=Ma(t.message);this.cameraInfoByTopic.set(t.topic,i);const n=this.cameraInfoToImageTopics.get(t.topic)??[];for(const r of n){const a=this.renderables.get(r);if(!a)continue;const o=a.userData.settings;if(!o.cameraInfoTopic||o.cameraInfoTopic!==t.topic)continue;const{image:l,receiveTime:c}=a.userData;if(!l)continue;const h=this._recomputeCameraModel(a,i);h&&this._updateImageRenderable(a,l,h,c,o)}},e.addSchemaSubscriptions(Ws,this.handleRosRawImage),e.addSchemaSubscriptions(Ys,this.handleRosCompressedImage),e.addSchemaSubscriptions(Vt,{handler:this.handleCameraInfo,shouldSubscribe:this.cameraInfoShouldSubscribe}),e.addSchemaSubscriptions(zs,this.handleRawImage),e.addSchemaSubscriptions(Gs,this.handleCompressedImage),e.addSchemaSubscriptions(Bt,{handler:this.handleCameraInfo,shouldSubscribe:this.cameraInfoShouldSubscribe}),this._updateCameraInfoTopics()}_updateCameraInfoTopics(){if(this.renderer.topics!==this.lastTopics){this.lastTopics=this.renderer.topics,this.cameraInfoTopics=new Set;for(const e of this.renderer.topics??[])(Y(e,Vt)||Y(e,Bt))&&this.cameraInfoTopics.add(e.name)}}settingsNodes(){this._updateCameraInfoTopics();const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!(Y(n,Ws)||Y(n,Ys)||Y(n,zs)||Y(n,Gs)))continue;const r=n.name,a=e[r]??{},o=[],l=[];for(const f of this.cameraInfoTopics)co(r,f)?o.push({label:f,value:f}):l.push({label:f,value:f});const h={cameraInfoTopic:{label:"Camera Info",input:"select",options:[...o,...l],value:a.cameraInfoTopic},distance:{label:"Distance",input:"number",placeholder:String(oo),step:.1,precision:K,value:a.distance},planarProjectionFactor:{label:"Planar Projection Factor",input:"number",placeholder:String(lo),min:0,max:1,step:.1,precision:2,value:a.planarProjectionFactor},color:{label:"Color",input:"rgba",value:a.color}};i.push({path:["topics",r],node:{icon:"ImageProjection",fields:h,visible:a.visible??On.visible,order:r.toLocaleLowerCase(),handler:t}})}return i}_recomputeCameraModel(e,t){if(Da(e.userData.cameraInfo,t)&&e.userData.cameraModel!=null)return;const n=e.userData.topic;e.userData.cameraModel=void 0,e.userData.geometry?.dispose(),e.userData.geometry=void 0;try{e.userData.cameraModel=new be.HL(t),this.renderer.settings.errors.removeFromTopic(n,ao)}catch(r){const a=r;this.renderer.settings.errors.addToTopic(n,ao,a.message);return}return e.userData.cameraInfo=t,e.userData.cameraModel}_updateImageRenderable(e,t,i,n,r){const a=e.userData.settings,o={...On,...r},l=o.cameraInfoTopic===a.cameraInfoTopic&&o.distance===a.distance&&o.planarProjectionFactor===a.planarProjectionFactor,c=o.color===a.color,h=e.userData.topic;e.userData.image=t,e.userData.cameraModel=i;const f=e.userData.cameraInfo?.header.frame_id??("header"in t?t.header.frame_id:t.frame_id);if(e.userData.frameId=this.renderer.normalizeFrameId(f),e.userData.receiveTime=n,e.userData.messageTime=(0,m.toNanoSec)("header"in t?t.header.stamp:t.timestamp),e.userData.settings=o,l||(e.userData.geometry?.dispose(),e.userData.geometry=void 0,e.userData.mesh&&(e.remove(e.userData.mesh),e.userData.mesh=void 0)),r?.cameraInfoTopic!=null&&this.renderer.settings.errors.removeFromTopic(h,li),e.userData.geometry==null){const p=Rh(i,e.userData.settings);e.userData.geometry=p,e.userData.mesh&&(e.remove(e.userData.mesh),e.userData.mesh=void 0)}if("format"in t){const p=new Blob([t.data],{type:`image/${t.format}`});self.createImageBitmap(p,{resizeWidth:Dh}).then(g=>{e.userData.texture==null?(e.userData.texture=Ah(g),Un(e),Fn(e,this.renderer)):(e.userData.texture.image.close(),e.userData.texture.image=g,e.userData.texture.needsUpdate=!0),this.renderer.settings.errors.removeFromTopic(h,ro)}).catch(g=>{this.renderer.settings.errors.addToTopic(h,ro,`createBitmap failed: ${g.message}`)})}else{const{width:p,height:g}=t,b=e.userData.texture;(b==null||b.image.width!==p||b.image.height!==g)&&(b?.dispose(),e.userData.texture=Ph(p,g),Un(e),Fn(e,this.renderer));const T=e.userData.texture;Oh(t,{},T),T.needsUpdate=!0}(!e.userData.material||!c)&&Un(e),Fn(e,this.renderer)}_getImageRenderable(e,t,i,n){let r=this.renderables.get(e);if(r)return r;const a=this.renderer.config.topics[e];return r=new Mh(e,this.renderer,{receiveTime:t,messageTime:i?(0,m.toNanoSec)("header"in i?i.header.stamp:i.timestamp):0n,frameId:this.renderer.normalizeFrameId(n),pose:Q(),settingsPath:["topics",e],topic:e,settings:{...On,...a},cameraInfo:void 0,cameraModel:void 0,image:i,texture:void 0,material:void 0,geometry:void 0,mesh:void 0}),this.add(r),this.renderables.set(e,r),r}}const es={r:0,g:0,b:0,a:0};function Fn(s,e){const{mesh:t,geometry:i,material:n}=s.userData;!t&&i&&n&&(s.userData.mesh=new d.Kj0(i,s.userData.material),s.add(s.userData.mesh),e.queueAnimationFrame())}function Un(s){const e=s.userData.texture;s.userData.material?.dispose(),s.userData.material=e?Lh(e,s):void 0,s.userData.mesh&&(s.remove(s.userData.mesh),s.userData.mesh=void 0)}function Ah(s){const e=new d.ROQ(s,d.xfE,d.uWy,d.uWy,d.TyD,d.wem,d.wk1,d.ywz);return e.generateMipmaps=!1,e.encoding=d.knz,e}function Ph(s,e){const t=s*e,i=new Uint8ClampedArray(t*4);return new d.IEO(i,s,e,d.wk1,d.ywz,d.xfE,d.uWy,d.uWy,d.TyD,d.wem,1,d.knz)}function Lh(s,e){$(es,e.userData.settings.color);const t=es.a<1,i=new d.Ilk(es.r,es.g,es.b);return new d.vBJ({name:`${e.userData.topic}:Material`,color:i,map:s,side:d.ehD,opacity:es.a,transparent:t,depthWrite:!t})}function Rh(s,e){const n=s.width,r=s.height,a=new d._12(1,1,10,10),o=10+1,l=10+1,c=o*l,h=n/10,f=r/10,u=.001,p={x:0,y:0},g={x:0,y:0,z:0},b=new Float32Array(c*3),T=new Float32Array(c*2);for(let _=0;_<l;_++)for(let R=0;R<o;R++){const N=(_*o+R)*3,P=(_*o+R)*2;p.x=R*h,p.y=_*f,kt(g,p,s,e),b[N+0]=g.x,b[N+1]=g.y,b[N+2]=g.z-u,T[P+0]=R/10,T[P+1]=_/10}return a.setAttribute("position",new d.TlE(b,3)),a.setAttribute("uv",new d.TlE(T,2)),a.attributes.position.needsUpdate=!0,a.attributes.uv.needsUpdate=!0,a}function co(s,e){const t=s.split("/"),i=e.split("/");for(let n=0;n<t.length-1&&n<i.length-1;n++)if(t[n]!==i[n])return!1;return!0}function Nh(s,e){const t=[];for(const i of e)co(s,i)&&t.push(i);return t.sort(),t[0]}function Oh(s,e,t){const{encoding:i,width:n,height:r}=s,a="is_bigendian"in s?s.is_bigendian:!1,o=s.data;switch(i){case"yuv422":(0,be.ai)(s.data,n,r,t.image.data);break;case"uyuv":(0,be.ai)(s.data,n,r,t.image.data);break;case"yuyv":(0,be.gl)(s.data,n,r,t.image.data);break;case"rgb8":(0,be.$C)(o,n,r,t.image.data);break;case"rgba8":(0,be.X)(o,n,r,t.image.data);break;case"bgra8":(0,be.Rh)(o,n,r,t.image.data);break;case"bgr8":case"8UC3":(0,be.km)(o,n,r,t.image.data);break;case"32FC1":(0,be.CA)(o,n,r,a,t.image.data);break;case"bayer_rggb8":(0,be.wk)(o,n,r,t.image.data);break;case"bayer_bggr8":(0,be.TD)(o,n,r,t.image.data);break;case"bayer_gbrg8":(0,be.eQ)(o,n,r,t.image.data);break;case"bayer_grbg8":(0,be.cS)(o,n,r,t.image.data);break;case"mono8":case"8UC1":(0,be.GT)(o,n,r,t.image.data);break;case"mono16":case"16UC1":(0,be.v$)(o,n,r,a,t.image.data,e);break;default:throw new Error(`Unsupported encoding ${i}`)}}function ho(s){return s==null?new Uint8Array(0):s instanceof Int8Array||s instanceof Uint8Array?s:new Uint8Array(0)}function Fh(s){return{header:Fe(s.header),height:s.height??0,width:s.width??0,encoding:s.encoding??"",is_bigendian:s.is_bigendian??!1,step:s.step??0,data:ho(s.data)}}function Uh(s){return{header:Fe(s.header),format:s.format??"",data:Yt(s.data)}}function kh(s){return{timestamp:ge(s.timestamp),frame_id:s.frame_id??"",height:s.height??0,width:s.width??0,encoding:s.encoding??"",step:s.step??0,data:ho(s.data)}}function zh(s){return{timestamp:ge(s.timestamp),frame_id:s.frame_id??"",format:s.format??"",data:Yt(s.data)}}class Ss extends d.u9r{constructor(e=d.dj0){super(),this.attributes={},this._attributeConstructors=new Map,this._itemCapacity=0,this._usage=e}setUsage(e){this._usage=e;for(const t of Object.values(this.attributes))t.setUsage(e)}createAttribute(e,t,i,n){const r=new t(this._itemCapacity*i),a=new d.TlE(r,i,n);return a.setUsage(this._usage),this._attributeConstructors.set(e,t),this.setAttribute(e,a)}resize(e){if(this.setDrawRange(0,e),e<=this._itemCapacity){for(const t of Object.values(this.attributes))t.count=e;return}for(const[t,i]of Object.entries(this.attributes)){const n=this._attributeConstructors.get(t);if(!n)throw new Error(`DynamicBufferGeometry resize(${e}) failed, missing data constructor for attribute "${t}". Attributes must be created using createAttribute().`);const r=new n(e*i.itemSize),a=new d.TlE(r,i.itemSize,i.normalized);a.setUsage(this._usage),this.setAttribute(t,a)}this._itemCapacity=e}}const Gh=1.5,Bh="circle",jh="turbo",$h={r:1,g:1,b:1,a:1},Vh={r:100/255,g:47/255,b:105/255,a:1},Hh={r:227/255,g:177/255,b:135/255,a:1},ci={visible:!1,frameLocked:!1,pointSize:Gh,pointShape:Bh,decayTime:0,colorMode:"flat",flatColor:pe($h),colorField:void 0,gradient:[pe(Vh),pe(Hh)],colorMap:jh,explicitAlpha:1,minValue:void 0,maxValue:void 0},uo=["x","y","z"],Wh=[{label:"Circle",value:"circle"},{label:"Square",value:"square"}];function kn(s,e,t,i=ci){const n=t.pointSize,r=t.pointShape??"circle",a=t.decayTime,o=Gr(e,t,s,i,{supportsPackedRgbModes:Hs.has(s.schemaName),supportsRgbaFieldsMode:ks.has(s.schemaName)});return o.fields={pointSize:{label:"Point size",input:"number",step:1,placeholder:"2",precision:2,value:n},pointShape:{label:"Point shape",input:"select",options:Wh,value:r},decayTime:{label:"Decay time",input:"number",step:.5,placeholder:"0 seconds",min:0,precision:3,value:a},...o.fields},o}function fo(s,e,{supportsPackedRgbModes:t}){if(t)for(const n of e.fields){if(!Nt(n))continue;const r=n.name.toLowerCase();if(Ji.has(r)){switch(s.colorField=n.name,r){case"rgb":s.colorMode="rgb";break;default:case"rgba":s.colorMode="rgba";break}return}}for(const n of e.fields)if(Nt(n)&&kr.has(n.name)){s.colorField=n.name,s.colorMode="colormap",s.colorMap="turbo";return}const i=e.fields.find(n=>Nt(n));if(i!=null){s.colorField=i.name,s.colorMode="colormap",s.colorMap="turbo";return}}function po(s,e){const t=new Ss(e);return t.name=`${s}:PointScans:geometry`,t.createAttribute("position",Float32Array,3),t.createAttribute("color",Uint8Array,4,!0),t}function zn(s){switch(s.colorMode){case"flat":case"colormap":case"gradient":return"linear";case"rgb":case"rgba":case"rgba-fields":return"srgb"}}function di(s,e,t,i,n,r){const a=new d.woe(t,i);return a.frustumCulled=!1,a.name=`${s}:PointCloud:points`,a.userData={pickingMaterial:n,instancePickingMaterial:r,pose:e},a}const Yh=`
outgoingLight = sRGBToLinear(outgoingLight);
`,Zh=`
vec2 cxy = 2.0 * gl_PointCoord - 1.0;
if (dot(cxy, cxy) > 1.0) { discard; }
`;function Gn(s){const e=$s(s),t=zn(s),i=s.pointSize,n=s.pointShape,r=new d.UY4({vertexColors:!0,size:i,sizeAttenuation:!1,transparent:e,depthWrite:!0});return r.customProgramCacheKey=()=>`${n}-${t}`,r.onBeforeCompile=a=>{const o="#include <output_fragment>";n==="circle"&&(a.fragmentShader=a.fragmentShader.replace(o,Zh+o)),t==="srgb"&&(a.fragmentShader=Br+a.fragmentShader.replace(o,Yh+o))},r}function mo(s){const t=Math.max(s.pointSize,8);return new d.jyz({vertexShader:`
      uniform float pointSize;
      void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        gl_PointSize = pointSize;
      }
    `,fragmentShader:`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `,side:d.ehD,uniforms:{pointSize:{value:t},objectId:{value:[NaN,NaN,NaN,NaN]}}})}function go(s){const t=Math.max(s.pointSize,8);return new d.jyz({vertexShader:`
        uniform float pointSize;
        varying vec4 objectId;
        void main() {
          objectId = vec4(
            float((gl_VertexID >> 24) & 255) / 255.0,
            float((gl_VertexID >> 16) & 255) / 255.0,
            float((gl_VertexID >> 8) & 255) / 255.0,
            float(gl_VertexID & 255) / 255.0);
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          gl_PointSize = pointSize;
        }
      `,fragmentShader:`
        varying vec4 objectId;
        void main() {
          gl_FragColor = objectId;
        }
      `,side:d.ehD,uniforms:{pointSize:{value:t}}})}class Bn{constructor({initial:e,renderer:t,parentRenderable:i}){this.history=[e],this.renderer=t,this.renderable=i}addHistoryEntry(e){this.history.push(e)}updateMaterial(e){for(const t of this.history)t.object3d.material=e}updateHistoryFromCurrentTime(e){const t=this.history,i=this.renderable.userData.settings.decayTime,n=i>0?e-BigInt(Math.round(i*1e9)):us;for(;t.length>1&&t[0].receiveTime<n;){const r=this.history.shift();this.renderable.remove(r.object3d),r.object3d.geometry.dispose()}}updatePoses(e,t,i){let n=!1;for(const r of this.history){const a=r.messageTime,o=this.renderable.userData.frameId;if(!ps(r.object3d,this.renderer.transformTree,t,i,o,e,a)&&!n){const c=fs(t,i,o);this.renderer.settings.errors.add(this.renderable.userData.settingsPath,lt,c),n=!0}}}latest(){return this.history[this.history.length-1]}clearHistory(){for(const e of this.history.splice(0,this.history.length-1))e.object3d.geometry.dispose(),this.renderable.remove(e.object3d)}dispose(){for(const e of this.history)e.object3d.geometry.dispose();this.history.length=0}}function jn(){return{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}}}const yo=ci,Kh=["range","intensity"],Xh=new Set([...Fi,...sn]),Jh="INVALID_LASERSCAN",Qh=new d.Pa4,_s={r:0,g:0,b:0,a:0};function bo(s,e){const t=new Ss(e);return t.name=`${s}:LaserScan:geometry`,t.createAttribute("position",Float32Array,1),t.createAttribute("color",Uint8Array,4,!0),t}class qh extends fe{constructor(e,t,i){super(e,t,i),this.pickableInstances=!0;const n=i.settings.decayTime>0,r=bo(e,n?d.dj0:d.W2J),a=di(e,i.laserScan.pose,r,i.material,i.pickingMaterial,i.instancePickingMaterial);this.pointsHistory=new Bn({initial:{messageTime:i.receiveTime,receiveTime:i.receiveTime,object3d:a},parentRenderable:this,renderer:t}),this.add(a)}dispose(){this.userData.originalMessage=void 0,this.userData.material.dispose(),this.userData.pickingMaterial.dispose(),this.userData.instancePickingMaterial.dispose(),this.pointsHistory.dispose(),super.dispose()}details(){return this.userData.originalMessage??{}}instanceDetails(e){const t=e>=0&&e<this.userData.laserScan.ranges.length?this.userData.laserScan.ranges[e]:void 0,i=e>=0&&e<this.userData.laserScan.intensities.length?this.userData.laserScan.intensities[e]:void 0;return{range:t,intensity:i}}updateLaserScan(e,t,i,n){var r;const a=(0,m.toNanoSec)(e.timestamp);this.userData.receiveTime=n,this.userData.messageTime=a,this.userData.frameId=this.renderer.normalizeFrameId(e.frame_id),this.userData.laserScan=e,this.userData.originalMessage=t,this.userData.settings=i;const{colorField:o}=i,{intensities:l,ranges:c}=e;if(l.length!==0&&l.length!==c.length){const U=`LaserScan intensities length (${l.length}) does not match ranges length (${c.length})`;vo(this.renderer,this,U);return}if(o!=="intensity"&&o!=="range"){const U=`LaserScan color field must be either 'intensity' or 'range', found '${o}'`;vo(this.renderer,this,U);return}const h=this.userData.material,f=this.userData.pickingMaterial,u=this.userData.topic,p=this.pointsHistory;if(i.decayTime>0){const U=bo(u,d.W2J),V=di(u,e.pose,U,h,f,void 0);p.addHistoryEntry({receiveTime:n,messageTime:a,object3d:V}),this.add(V)}const b=p.latest();if(!b)throw new Error(`pointsHistory is empty for ${u}`);b.receiveTime=n,b.messageTime=a,b.object3d.userData.pose=e.pose;const T=b.object3d.geometry;T.resize(c.length);const _=T.attributes.position,R=T.attributes.color;_.set(c),h.update(i,e),f.update(i,e);let N=i.minValue??Number.POSITIVE_INFINITY,P=i.maxValue??Number.NEGATIVE_INFINITY;if(i.minValue==null||i.maxValue==null){let U=0;for(let V=0;V<c.length;V++){const j=c[V];Number.isFinite(j)&&(U=Math.max(U,j));const se=o==="range"?j:l[V];Number.isFinite(se)&&(N=Math.min(N,se),P=Math.max(P,se))}N=i.minValue??N,P=i.maxValue??P,(r=b.object3d.geometry).boundingSphere??(r.boundingSphere=new d.aLr),b.object3d.geometry.boundingSphere.set(Qh,U),b.object3d.frustumCulled=!0}else b.object3d.geometry.boundingSphere=null,b.object3d.frustumCulled=!1;const O=i.colorMode==="rgba-fields"?()=>NaN:Xi(i,N,P);for(let U=0;U<c.length;U++){const V=o==="range"?c[U]:l[U]??0;O(_s,V),R.setXYZW(U,_s.r,_s.g,_s.b,_s.a)}_.needsUpdate=!0,R.needsUpdate=!0}updateUniforms(){const t=this.userData.material.uniforms?.pixelRatio;t&&(t.value=this.renderer.getPixelRatio())}invalidateLastEntry(){this.pointsHistory.latest()?.object3d.geometry.resize(0)}startFrame(e,t,i){if(!this.userData.settings.visible){this.renderer.settings.errors.clearPath(this.userData.settingsPath),this.pointsHistory.clearHistory();return}this.pointsHistory.updateHistoryFromCurrentTime(e),this.pointsHistory.updatePoses(e,t,i),this.updateUniforms()}}class eu extends ie{constructor(e){super("foxglove.LaserScans",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n],o={...yo,...a};r.updateLaserScan(r.userData.laserScan,r.userData.originalMessage,o,r.userData.receiveTime)}},this.handleLaserScan=t=>{const i=t.topic,n="header"in t.message?su(t.message):tu(t.message),r=(0,m.toNanoSec)(t.receiveTime);let a=this.renderables.get(i);if(!a){const o=this.renderer.config.topics[i],l={...yo,...o};l.colorField==null&&(l.colorField="intensity",l.colorMode="colormap",l.colorMap="turbo",this.renderer.updateConfig(p=>{const g={...o};g.colorField=l.colorField,g.colorMode=l.colorMode,g.colorMap=l.colorMap,p.topics[i]=g}));const c=new xs,h=new xs({picking:!0}),f=new hi;c.update(l,n),h.update(l,n);const u=(0,m.toNanoSec)(n.timestamp);a=new qh(i,this.renderer,{receiveTime:r,messageTime:u,frameId:this.renderer.normalizeFrameId(n.frame_id),pose:n.pose,settingsPath:["topics",i],settings:l,topic:i,laserScan:n,originalMessage:t.message,material:c,pickingMaterial:h,instancePickingMaterial:f}),this.add(a),this.renderables.set(i,a)}a.updateLaserScan(n,t.message,a.userData.settings,r)},e.addSchemaSubscriptions(sn,this.handleLaserScan),e.addSchemaSubscriptions(Fi,this.handleLaserScan)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!Y(n,Xh))continue;const a=e[n.name]??{},l=kn(n,Kh,a);l.handler=t,l.icon="Radar",i.push({path:["topics",n.name],node:l})}return i}startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i),n.updateUniforms()}}class xs extends d.FIo{constructor({picking:e=!1}={}){super({vertexShader:`        #version 300 es
        precision highp float;
        precision highp int;
        uniform mat4 projectionMatrix, modelViewMatrix;

        uniform float pointSize;
        uniform float pixelRatio;
        uniform float angleMin, angleIncrement;
        uniform float rangeMin, rangeMax;
        in float position; // range, but must be named position in order for three.js to render anything
        in mediump vec4 color;
        out mediump vec4 vColor;
        void main() {
          if (position < rangeMin || position > rangeMax) {
            gl_PointSize = 0.0;
            return;
          }
          vColor = color;
          float angle = angleMin + angleIncrement * float(gl_VertexID);
          vec4 pos = vec4(position * cos(angle), position * sin(angle), 0, 1.0);
          gl_Position = projectionMatrix * modelViewMatrix * pos;
          ${e?`gl_PointSize = pixelRatio * max(pointSize, ${xs.MIN_PICKING_POINT_SIZE.toFixed(1)});`:"gl_PointSize = pixelRatio * pointSize;"}

        }
      `,fragmentShader:`        #version 300 es
        #ifdef GL_FRAGMENT_PRECISION_HIGH
          precision highp float;
        #else
          precision mediump float;
        #endif
        uniform bool isCircle;
        ${e?"uniform vec4 objectId;":"in mediump vec4 vColor;"}
        out vec4 outColor;

        ${d.WdD.encodings_pars_fragment}

        void main() {
          if (isCircle) {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) { discard; }
          }
          ${e?"outColor = objectId;":"outColor = LinearTosRGB(vColor);"}
        }
      `}),this.uniforms={isCircle:{value:!1},pointSize:{value:1},pixelRatio:{value:1},angleMin:{value:NaN},angleIncrement:{value:NaN},rangeMin:{value:NaN},rangeMax:{value:NaN}},e&&(this.uniforms.objectId={value:[NaN,NaN,NaN,NaN]})}update(e,t){this.uniforms.isCircle.value=e.pointShape==="circle",this.uniforms.pointSize.value=e.pointSize,this.uniforms.angleMin.value=t.start_angle,this.uniforms.angleIncrement.value=(t.end_angle-t.start_angle)/(t.ranges.length-1),this.uniforms.rangeMin.value=t.range_min,this.uniforms.rangeMax.value=t.range_max,this.uniformsNeedUpdate=!0;const i=$s(e);i!==this.transparent&&(this.transparent=i,this.depthWrite=!this.transparent,this.needsUpdate=!0)}}xs.MIN_PICKING_POINT_SIZE=8;class hi extends d.FIo{constructor(){const e=hi.MIN_PICKING_POINT_SIZE.toFixed(1);super({vertexShader:`        #version 300 es
        precision highp float;
        precision highp int;
        uniform mat4 projectionMatrix, modelViewMatrix;

        uniform float pointSize;
        uniform float pixelRatio;
        uniform float angleMin, angleIncrement;
        uniform float rangeMin, rangeMax;
        in float position; // range, but must be named position in order for three.js to render anything
        varying vec4 objectId;
        void main() {
          if (position < rangeMin || position > rangeMax) {
            gl_PointSize = 0.0;
            return;
          }
          objectId = vec4(
            float((gl_VertexID >> 24) & 255) / 255.0,
            float((gl_VertexID >> 16) & 255) / 255.0,
            float((gl_VertexID >> 8) & 255) / 255.0,
            float(gl_VertexID & 255) / 255.0);
          float angle = angleMin + angleIncrement * float(gl_VertexID);
          vec4 pos = vec4(position * cos(angle), position * sin(angle), 0, 1.0);
          gl_Position = projectionMatrix * modelViewMatrix * pos;
          gl_PointSize = pixelRatio * max(pointSize, ${e});
        }
      `,fragmentShader:`        #version 300 es
        #ifdef GL_FRAGMENT_PRECISION_HIGH
          precision highp float;
        #else
          precision mediump float;
        #endif
        uniform bool isCircle;
        varying vec4 objectId;
        out vec4 outColor;

        void main() {
          if (isCircle) {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) { discard; }
          }
          outColor = objectId;
        }
      `}),this.uniforms={isCircle:{value:!1},pointSize:{value:1},pixelRatio:{value:1},angleMin:{value:NaN},angleIncrement:{value:NaN},rangeMin:{value:NaN},rangeMax:{value:NaN}}}update(e,t){this.uniforms.isCircle.value=e.pointShape==="circle",this.uniforms.pointSize.value=e.pointSize,this.uniforms.angleMin.value=t.angle_min,this.uniforms.angleIncrement.value=t.angle_increment,this.uniforms.rangeMin.value=t.range_min,this.uniforms.rangeMax.value=t.range_max,this.uniformsNeedUpdate=!0}}hi.MIN_PICKING_POINT_SIZE=8;function vo(s,e,t){s.settings.errors.addToTopic(e.userData.topic,Jh,t),e.invalidateLastEntry()}function tu(s){return{timestamp:ge(s.timestamp),frame_id:s.frame_id??"",pose:oe(s.pose),start_angle:s.start_angle??0,end_angle:s.end_angle??0,range_min:-1/0,range_max:1/0,ranges:Zs(s.ranges),intensities:Zs(s.intensities)}}function su(s){return{timestamp:ge(s.header?.stamp),frame_id:s.header?.frame_id??"",pose:jn(),start_angle:s.angle_min??0,end_angle:s.angle_max??0,range_min:s.range_min??-1/0,range_max:s.range_max??1/0,ranges:Zs(s.ranges),intensities:Zs(s.intensities)}}const iu="INVALID_CUBE_LIST",$n="INVALID_LINE_LIST",To="INVALID_LINE_STRIP",nu="INVALID_MARKER_ACTION",ru="INVALID_MARKER_TYPE",au="INVALID_POINTS_LIST",ou="INVALID_SPHERE_LIST",lu={visible:!0};class cu{constructor(e,t,i){this.markersById=new Map,this.namespace=t;const r=i.config.topics[e]?.namespaces?.[t];this.settings={...lu,...r}}}class du extends fe{constructor(){super(...arguments),this.pickable=!1,this.namespaces=new Map}dispose(){for(const e of this.namespaces.values())for(const t of e.markersById.values())this.renderer.markerPool.release(t);this.children.length=0,this.namespaces.clear()}addMarkerMessage(e,t){switch(e.action){case me.ADD:case me.MODIFY:this._addOrUpdateMarker(e,t);break;case me.DELETE:this._deleteMarker(e.ns,e.id);break;case me.DELETEALL:{this._deleteAllMarkers(e.ns);break}default:this.renderer.settings.errors.addToTopic(this.topic,nu,`Invalid marker action ${e.action}`)}}update(){for(const e of this.namespaces.values())for(const t of e.markersById.values())t.update(t.userData.originalMarker,t.userData.receiveTime)}startFrame(e,t,i){if(this.visible=this.userData.settings.visible,!this.visible){this.renderer.settings.errors.clearTopic(this.topic);return}for(const n of this.namespaces.values())for(const r of n.markersById.values()){if(r.visible=n.settings.visible,!r.visible)continue;const a=r.userData.marker,o=r.userData.receiveTime,l=r.userData.expiresIn;if(l!=null&&e>o+l){this._deleteMarker(n.namespace,a.id);continue}const c=this.renderer.normalizeFrameId(a.header.frame_id),h=a.frame_locked?e:r.userData.messageTime,f=ps(r,this.renderer.transformTree,t,i,c,e,h);r.visible=f;const u=r.userData.topic;if(f)this.renderer.settings.errors.removeFromTopic(u,lt);else{const p=fs(t,i,c);this.renderer.settings.errors.addToTopic(u,lt,p)}}}_addOrUpdateMarker(e,t){let i=this.namespaces.get(e.ns);i||(i=new cu(this.topic,e.ns,this.renderer),this.namespaces.set(e.ns,i));let n=i.markersById.get(e.id);if(n&&n.userData.marker.type!==e.type&&(this._deleteMarker(e.ns,e.id),n=void 0),!n){if(n=this._createMarkerRenderable(e,t),!n)return;this.add(n),i.markersById.set(e.id,n)}n.update(e,t)}_deleteMarker(e,t){const i=this.namespaces.get(e);if(i){const n=i.markersById.get(t);if(n)return this.remove(n),this.renderer.markerPool.release(n),i.markersById.delete(t),!0}return!1}_deleteAllMarkers(e){const t=i=>{for(const n of i.markersById.values())this.remove(n),this.renderer.markerPool.release(n);i.markersById.clear()};if(e.length===0)for(const i of this.namespaces.values())t(i);else{const i=this.namespaces.get(e);i&&t(i)}}_createMarkerRenderable(e,t){const i=this.renderer.markerPool;switch(e.type){case A.ARROW:return i.acquire(A.ARROW,this.topic,e,t);case A.CUBE:return i.acquire(A.CUBE,this.topic,e,t);case A.SPHERE:return i.acquire(A.SPHERE,this.topic,e,t);case A.CYLINDER:return i.acquire(A.CYLINDER,this.topic,e,t);case A.LINE_STRIP:if(e.points.length===0){const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,To,`LINE_STRIP marker ${n} has no points`);return}else if(e.points.length===1){const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,To,`LINE_STRIP marker ${n} only has one point`);return}return i.acquire(A.LINE_STRIP,this.topic,e,t);case A.LINE_LIST:if(e.points.length===0){const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,$n,`LINE_LIST marker ${n} has no points`);return}else if(e.points.length===1){const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,$n,`LINE_LIST marker ${n} only has one point`);return}else if(e.points.length%2!==0){const n=Ye(this.topic,e.ns,e.id);if(this.renderer.settings.errors.addToTopic(this.topic,$n,`LINE_LIST marker ${n} has an odd number of points (${e.points.length})`),e.points.length===1)return}return i.acquire(A.LINE_LIST,this.topic,e,t);case A.CUBE_LIST:if(e.points.length===0){const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,iu,`CUBE_LIST marker ${n} has no points`);return}return i.acquire(A.CUBE_LIST,this.topic,e,t);case A.SPHERE_LIST:if(e.points.length===0){const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,ou,`SPHERE_LIST marker ${n} has no points`);return}return i.acquire(A.SPHERE_LIST,this.topic,e,t);case A.POINTS:if(e.points.length===0){const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,au,`POINTS marker ${n} has no points`);return}return i.acquire(A.POINTS,this.topic,e,t);case A.TEXT_VIEW_FACING:return i.acquire(A.TEXT_VIEW_FACING,this.topic,e,t);case A.MESH_RESOURCE:{const n=i.acquire(A.MESH_RESOURCE,this.topic,e,t);return n.update(e,t,!0),n}case A.TRIANGLE_LIST:return i.acquire(A.TRIANGLE_LIST,this.topic,e,t);default:{const n=Ye(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,ru,`Marker ${n} has invalid type ${e.type}`);return}}}}const Vn={visible:!1,showOutlines:!0,color:void 0,selectedIdVariable:void 0,namespaces:{}};class hu extends ie{constructor(e){super("foxglove.Markers",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n];r.userData.settings={...Vn,...a},r.update()}},this.handleSettingsActionNamespace=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==4)return;const n=i[1],r=i[2],a=i[3],o=r.slice(3);this.renderer.updateConfig(c=>{const h=["topics",n,"namespaces",o,a];(0,B.set)(c,h,t.payload.value)});const l=this.renderables.get(n);if(l){const c=this.renderer.config.topics[n],h=l.namespaces.get(o);if(h){const f=c?.namespaces?.[o];h.settings={...h.settings,...f}}}this.updateSettingsTree()},this.handleMarkerArray=t=>{const i=t.topic,n=t.message,r=(0,m.toNanoSec)(t.receiveTime);for(const a of n.markers??[])if(a){const o=So(a);this.addMarker(i,o,r)}},this.handleMarker=t=>{const i=t.topic,n=So(t.message),r=(0,m.toNanoSec)(t.receiveTime);this.addMarker(i,n,r)},e.addSchemaSubscriptions(Vs,this.handleMarkerArray),e.addSchemaSubscriptions(en,this.handleMarker)}settingsNodes(){const e=this.renderer.config.topics,t=[];for(const i of this.renderer.topics??[]){if(!(Y(i,Vs)||Y(i,en)))continue;const n=e[i.name]??{},r={label:i.name,icon:"Shapes",order:i.name.toLocaleLowerCase(),fields:{color:{label:"Color",input:"rgba",value:n.color},showOutlines:{label:"Show outline",input:"boolean",value:n.showOutlines},selectedIdVariable:{label:"Selection Variable",input:"string",help:"When selecting a marker, this global variable will be set to the marker ID",value:n.selectedIdVariable,placeholder:Oi}},visible:n.visible??Vn.visible,handler:this.handleSettingsAction},a=this.renderables.get(i.name),o=Array.from(a?.namespaces.values()??[]).sort((l,c)=>l.namespace.localeCompare(c.namespace));if(o.length>1||o.length===1&&o[0].namespace!==""){r.children={};for(const l of o){const c={label:l.namespace!==""?l.namespace:'""',icon:"Shapes",visible:l.settings.visible,defaultExpansionState:o.length>1?"collapsed":"expanded",handler:this.handleSettingsActionNamespace};r.children[`ns:${l.namespace}`]=c}}t.push({path:["topics",i.name],node:r})}return t}startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i)}addMarker(e,t,i){const n=this._getTopicMarkers(e,t,i),r=n.namespaces.size;n.addMarkerMessage(t,i),r!==n.namespaces.size&&this.updateSettingsTree()}addMarkerArray(e,t,i){const n=t[0];if(!n)return;const r=this._getTopicMarkers(e,n,i),a=r.namespaces.size;for(const o of t)r.addMarkerMessage(o,i);a!==r.namespaces.size&&this.updateSettingsTree()}_getTopicMarkers(e,t,i){let n=this.renderables.get(e);if(!n){const r=this.renderer.config.topics[e];n=new du(e,this.renderer,{receiveTime:i,messageTime:(0,m.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:Q(),settingsPath:["topics",e],topic:e,settings:{...Vn,...r}}),this.renderables.set(e,n),this.add(n)}return n}}function So(s){return{header:Fe(s.header),ns:s.ns??"",id:s.id??0,type:s.type??0,action:s.action??0,pose:oe(s.pose),scale:We(s.scale),color:st(s.color),lifetime:ge(s.lifetime),frame_locked:s.frame_locked??!1,points:ia(s.points),colors:mn(s.colors),text:s.text??"",mesh_resource:s.mesh_resource??"",mesh_use_embedded_materials:s.mesh_use_embedded_materials??!1}}const ui=9999999;class uu extends d.jyz{constructor({color:e,...t}){super({...t,vertexShader:`
        #include <common>
        uniform vec2 canvasSize;
        void main() {
          vec4 mvPosition = modelViewMatrix * vec4(0., 0., 0., 1.);

          // Adapted from THREE.ShaderLib.sprite
          vec2 scale;
          scale.x = length(vec3(modelMatrix[0].xyz));
          scale.y = length(vec3(modelMatrix[1].xyz));

          gl_Position = projectionMatrix * mvPosition;

          // Add position after projection to maintain constant pixel size
          gl_Position.xy += position.xy / canvasSize * scale * gl_Position.w;
        }
      `,fragmentShader:`
        uniform vec3 color;
        void main() {
          gl_FragColor = vec4(color, 1.0);
        }
      `,uniforms:{canvasSize:{value:[0,0]},color:{value:new d.Ilk(e).convertSRGBToLinear()}}})}}class fu extends ie{constructor(e){super("foxglove.MeasurementTool",e),this.circleGeometry=new d.zf8(5,16),this.circleMaterial=new uu({color:16711680,depthTest:!1,depthWrite:!1}),this.circle1=new d.Kj0(this.circleGeometry,this.circleMaterial),this.circle2=new d.Kj0(this.circleGeometry,this.circleMaterial),this.linePositionAttribute=new d.a$l([0,0,0,0,0,0],3),this.line=new d.x12(new d.u9r,new d.nls({color:16711680})),this.lineOccluded=new d.x12(new d.u9r,new d.FT0({color:16711680,dashSize:1,gapSize:1,depthWrite:!1,depthFunc:d.w$m})),this.point1NeedsUpdate=!1,this.point2NeedsUpdate=!1,this.state="idle",this._handleMouseMove=(t,i,n)=>{if(i){switch(this.state){case"idle":break;case"place-first-point":(this.point1??(this.point1=new d.Pa4)).copy(i),this.point1NeedsUpdate=!0;break;case"place-second-point":(this.point2??(this.point2=new d.Pa4)).copy(i),this.point2NeedsUpdate=!0,this._updateDistance();break}this._render()}},this._handleClick=(t,i,n)=>{if(i){switch(this.state){case"idle":break;case"place-first-point":this.point1=i.clone(),this.point1NeedsUpdate=!0,this._setState("place-second-point");break;case"place-second-point":this.point2=i.clone(),this.point2NeedsUpdate=!0,this._setState("idle");break}this._render()}},this.line.userData.picking=!1,this.lineOccluded.userData.picking=!1,this.circle1.userData.picking=!1,this.circle2.userData.picking=!1,this.label=e.labelPool.acquire(),this.label.visible=!1,this.label.setBillboard(!0),this.label.setSizeAttenuation(!1),this.label.setLineHeight(12),this.label.setColor(1,0,0),this.label.renderOrder=ui,this.label.material.depthTest=!1,this.label.material.depthWrite=!1,this.label.material.transparent=!0,this.lineOccluded.renderOrder=ui,this.circle1.renderOrder=ui,this.circle2.renderOrder=ui,this.line.frustumCulled=!1,this.lineOccluded.frustumCulled=!1,this.line.geometry.setAttribute("position",this.linePositionAttribute),this.lineOccluded.geometry.setAttribute("position",this.linePositionAttribute),this.circle1.visible=!1,this.circle2.visible=!1,this.add(this.circle1),this.add(this.circle2),this.add(this.line),this.add(this.lineOccluded),this.add(this.label),this._setState("idle")}dispose(){super.dispose(),this.renderer.labelPool.release(this.label),this.circleGeometry.dispose(),this.circleMaterial.dispose(),this.line.geometry.dispose(),this.line.material.dispose(),this.lineOccluded.geometry.dispose(),this.lineOccluded.material.dispose(),this.renderer.input.removeListener("click",this._handleClick),this.renderer.input.removeListener("mousemove",this._handleMouseMove)}startMeasuring(){this._setState("place-first-point")}stopMeasuring(){this.point1=this.point2=void 0,this._setState("idle")}startFrame(e,t,i){super.startFrame(e,t,i),this.circleMaterial.uniforms.canvasSize.value[0]=this.renderer.input.canvasSize.x,this.circleMaterial.uniforms.canvasSize.value[1]=this.renderer.input.canvasSize.y}_setState(e){switch(this.state=e,e){case"idle":this.renderer.input.removeListener("click",this._handleClick),this.renderer.input.removeListener("mousemove",this._handleMouseMove),this.dispatchEvent({type:"foxglove.measure-end"});break;case"place-first-point":this.point1=this.point2=void 0,this.renderer.input.addListener("click",this._handleClick),this.renderer.input.addListener("mousemove",this._handleMouseMove),this.dispatchEvent({type:"foxglove.measure-start"});break;case"place-second-point":break}this._updateDistance(),this._render()}_updateDistance(){this.point1&&this.point2&&this.label.setText(this.point1.distanceTo(this.point2).toFixed(2))}_render(){this.point1?(this.circle1.visible=!0,this.circle1.position.copy(this.point1),this.point1NeedsUpdate&&(this.linePositionAttribute.setXYZ(0,this.point1.x,this.point1.y,this.point1.z),this.linePositionAttribute.needsUpdate=!0,this.lineOccluded.computeLineDistances(),this.point1NeedsUpdate=!1)):this.circle1.visible=!1,this.point2?(this.circle2.visible=!0,this.circle2.position.copy(this.point2),this.point2NeedsUpdate&&(this.linePositionAttribute.setXYZ(1,this.point2.x,this.point2.y,this.point2.z),this.linePositionAttribute.needsUpdate=!0,this.lineOccluded.computeLineDistances(),this.point2NeedsUpdate=!1)):this.circle2.visible=!1,this.point1&&this.point2?(this.line.visible=!0,this.lineOccluded.visible=!0,this.label.visible=!0,this.label.position.copy(this.point1).lerp(this.point2,.5)):(this.line.visible=!1,this.lineOccluded.visible=!1,this.label.visible=!1),this.renderer.queueAnimationFrame()}}const pu="INVALID_OCCUPANCY_GRID",mu={r:1,g:1,b:1,a:1},gu={r:0,g:0,b:0,a:1},yu={r:.5,g:.5,b:.5,a:1},bu={r:1,g:0,b:1,a:1},vu=1,Tu=pe(mu),Su=pe(gu),_u=pe(yu),xu=pe(bu),Hn={visible:!1,frameLocked:!1,colorMode:"custom",minColor:Tu,maxColor:Su,unknownColor:_u,invalidColor:xu,alpha:vu};class Cu extends fe{dispose(){this.userData.texture.dispose(),this.userData.material.dispose(),this.userData.pickingMaterial.dispose()}details(){return this.userData.occupancyGrid}}class wu extends ie{constructor(e){super("foxglove.OccupancyGrids",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=Wn(r.userData.settings),o=this.renderer.config.topics[n];r.userData.settings={...Hn,...o};const l=Wn(r.userData.settings);a!==l&&(r.userData.material.transparent=l,r.userData.material.depthWrite=!l,r.userData.material.needsUpdate=!0),this._updateOccupancyGridRenderable(r,r.userData.occupancyGrid,r.userData.receiveTime)}},this.handleOccupancyGrid=t=>{const i=t.topic,n=Lu(t.message),r=(0,m.toNanoSec)(t.receiveTime);let a=this.renderables.get(i);if(!a){const o=this.renderer.config.topics[i],l={...Hn,...o},c=_o(n),h=this.renderer.sharedGeometry.getGeometry(this.constructor.name,Iu),f=Mu(i,h,c,l),u=f.material,p=f.userData.pickingMaterial;a=new Cu(i,this.renderer,{receiveTime:r,messageTime:(0,m.toNanoSec)(n.header.stamp),frameId:this.renderer.normalizeFrameId(n.header.frame_id),pose:n.info.origin,settingsPath:["topics",i],settings:l,topic:i,occupancyGrid:n,mesh:f,texture:c,material:u,pickingMaterial:p}),a.add(f),this.add(a),this.renderables.set(i,a)}this._updateOccupancyGridRenderable(a,n,r)},e.addSchemaSubscriptions(tn,this.handleOccupancyGrid)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!Y(n,tn))continue;const r={...Hn,...e[n.name]};let a={colorMode:{label:"Color mode",input:"select",value:r.colorMode,options:[{label:"Custom",value:"custom"},{label:"Map",value:"map"},{label:"Costmap",value:"costmap"},{label:"Raw",value:"raw"}]}};if(r.colorMode==="custom"){const o={minColor:{label:"Min color",input:"rgba",value:r.minColor},maxColor:{label:"Max color",input:"rgba",value:r.maxColor},unknownColor:{label:"Unknown color",input:"rgba",value:r.unknownColor},invalidColor:{label:"Invalid color",input:"rgba",value:r.invalidColor}};a={...a,...o}}else{const o={alpha:{label:"Alpha",input:"number",value:r.alpha,min:0,max:1,step:.1,placeholder:"auto"}};a={...a,...o}}a.frameLocked={label:"Frame lock",input:"boolean",value:r.frameLocked},i.push({path:["topics",n.name],node:{label:n.name,icon:"Cells",fields:a,visible:r.visible,order:n.name.toLocaleLowerCase(),handler:t}})}return i}_updateOccupancyGridRenderable(e,t,i){e.userData.occupancyGrid=t,e.userData.pose=t.info.origin,e.userData.receiveTime=i,e.userData.messageTime=(0,m.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id);const n=t.info.width*t.info.height;if(t.data.length!==n){const c=`OccupancyGrid data length (${t.data.length}) is not equal to width ${t.info.width} * height ${t.info.height}`;Du(this.renderer,e,c);return}let r=e.userData.texture;const a=t.info.width,o=t.info.height,l=t.info.resolution;(a!==r.image.width||o!==r.image.height)&&(r.dispose(),r=_o(t),e.userData.texture=r,e.userData.material.map=r),Eu(r,t,e.userData.settings),e.scale.set(l*a,l*o,1)}}function Iu(){const s=new d._12(1,1,1,1);return s.translate(.5,.5,0),s.computeBoundingSphere(),s}function Du(s,e,t){s.settings.errors.addToTopic(e.userData.topic,pu,t)}function _o(s){const e=s.info.width,t=s.info.height,i=e*t,n=new Uint8ClampedArray(i*4),r=new d.IEO(n,e,t,d.wk1,d.ywz,d.xfE,d.uWy,d.uWy,d.TyD,d.wem,1,d.rnI);return r.generateMipmaps=!1,r}function Mu(s,e,t,i){const n=Pu(t),r=Au(t,s,i),a=new d.Kj0(e,r);return a.castShadow=!0,a.receiveShadow=!0,a.userData.pickingMaterial=n,a}const Cs={r:0,g:0,b:0,a:0},wt={r:0,g:0,b:0,a:0},It={r:0,g:0,b:0,a:0},ke={r:0,g:0,b:0,a:0},Dt={r:0,g:0,b:0,a:0};function Eu(s,e,t){const i=e.info.width*e.info.height,n=s.image.data;$(ke,t.minColor),$(Dt,t.maxColor),$(wt,t.unknownColor),$(It,t.invalidColor),fi(ke),fi(Dt),fi(wt),fi(It);const r=e.data;for(let a=0;a<i;a++){const o=r[a]|0,l=a*4;if(t.colorMode==="custom")if(o===-1)n[l+0]=wt.r,n[l+1]=wt.g,n[l+2]=wt.b,n[l+3]=wt.a;else if(o>=0&&o<=100){const c=o/100;n[l+0]=ke.r+(Dt.r-ke.r)*c,n[l+1]=ke.g+(Dt.g-ke.g)*c,n[l+2]=ke.b+(Dt.b-ke.b)*c,n[l+3]=ke.a+(Dt.a-ke.a)*c}else n[l+0]=It.r,n[l+1]=It.g,n[l+2]=It.b,n[l+3]=It.a;else Ru(Cs,o,t.colorMode),n[l+0]=Cs.r,n[l+1]=Cs.g,n[l+2]=Cs.b,n[l+3]=Cs.a*t.alpha}s.needsUpdate=!0}function Au(s,e,t){const i=Wn(t);return new d.vBJ({name:`${e}:Material`,alphaTest:1e-4,depthWrite:!i,map:s,side:d.ehD,transparent:i})}function Pu(s){return new d.jyz({vertexShader:`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,fragmentShader:`
      uniform sampler2D map;
      uniform vec4 objectId;
      varying vec2 vUv;
      void main() {
        vec4 color = texture2D(map, vUv);
        if (color.a == 0.0) {
          discard;
        }
        gl_FragColor = objectId;
      }
    `,side:d.ehD,uniforms:{map:{value:s},objectId:{value:[NaN,NaN,NaN,NaN]}}})}function Wn(s){return s.colorMode==="custom"?($(ke,s.minColor),$(Dt,s.maxColor),$(wt,s.unknownColor),$(It,s.invalidColor),ke.a<1||Dt.a<1||It.a<1||wt.a<1):!0}function fi(s){s.r=Math.trunc(te(s.r)*255),s.g=Math.trunc(te(s.g)*255),s.b=Math.trunc(te(s.b)*255),s.a=Math.trunc(s.a*255)}function Lu(s){const e=s.info??{};return{header:Fe(s.header),info:{map_load_time:ge(e.map_load_time),resolution:e.resolution??0,width:e.width??0,height:e.height??0,origin:oe(e.origin)},data:Ac(s.data)}}let Yn,Zn,Kn;function Ru(s,e,t){const i=e>=0?e:e+256;(i<0||i>255)&&(s.r=0,s.g=0,s.b=0,s.a=0);let n;if(t==="costmap")Yn||(Yn=Ou()),n=Yn;else if(t==="map")Zn||(Zn=Nu()),n=Zn;else if(t==="raw")Kn||(Kn=Fu()),n=Kn;else throw new Error(`Unsupported color mode ${t}`);const r=n[Math.trunc(i)];s.r=r[0],s.g=r[1],s.b=r[2],s.a=r[3]}function Nu(){let s=0;const e=new Array(256).fill([0,0,0,0]);for(let t=0;t<=100;t++){const i=Math.trunc(255-255*t/100);e[s++]=[i,i,i,255]}for(let t=101;t<=127;t++)e[s++]=[0,255,0,255];for(let t=128;t<=254;t++)e[s++]=[255,Math.trunc(255*(t-128)/(254-128)),0,255];return e[s++]=[112,137,134,255],e}function Ou(){let s=0;const e=new Array(256).fill([0,0,0,0]);e[s++]=[0,0,0,0];for(let t=1;t<=98;t++){const i=Math.trunc(255*t/100);e[s++]=[i,0,255-i,255]}e[s++]=[0,255,255,255],e[s++]=[255,0,255,255];for(let t=101;t<=127;t++)e[s++]=[0,255,0,255];for(let t=128;t<=254;t++)e[s++]=[255,Math.trunc(255*(t-128)/(254-128)),0,255];return e[s++]=[112,137,134,255],e}function Fu(){let s=0;const e=new Array(256).fill([0,0,0,0]);for(let t=0;t<256;t++)e[s++]=[t,t,t,255];return e}const Xn={...ci,stixelsEnabled:!1},Uu=["gradient","colormap"],ku=new Set([...ks,...Hs]),Jn="INVALID_POINTCLOUD",Pe={r:0,g:0,b:0,a:0},xo=[0,0],Co={xReader:ve,yReader:ve,zReader:ve,packedColorReader:ve,redReader:ve,greenReader:ve,blueReader:ve,alphaReader:ve};class wo extends fe{constructor(e,t,i){super(e,t,i),this.pickableInstances=!0;const n=i.settings.decayTime>0,r=po(e,n?d.W2J:d.dj0),a=di(e,Is(i.pointCloud),r,i.material,i.pickingMaterial,i.instancePickingMaterial);this.pointsHistory=new Bn({initial:{messageTime:i.receiveTime,receiveTime:i.receiveTime,object3d:a},parentRenderable:this,renderer:t}),this.add(a);const o=Io(e,n?d.W2J:d.dj0),l=Do(e,Is(i.pointCloud),o,i.stixelMaterial);this.stixelsHistory=new Bn({initial:{messageTime:i.receiveTime,receiveTime:i.receiveTime,object3d:l},parentRenderable:this,renderer:t}),this.add(l)}dispose(){this.userData.originalMessage=void 0,this.userData.material.dispose(),this.userData.pickingMaterial.dispose(),this.userData.instancePickingMaterial.dispose(),this.userData.stixelMaterial.dispose(),this.pointsHistory.dispose(),this.stixelsHistory.dispose(),super.dispose()}details(){return this.userData.originalMessage??{}}instanceDetails(e){const t=this.userData.pointCloud,i=t.data,n=ws(t),r=new DataView(i.buffer,i.byteOffset,i.byteLength),a=ws(t),o={};for(const l of t.fields){const c=e*a,h=Ie(l,n);h&&(o[l.name]=h(r,c))}return o}updatePointCloud(e,t,i,n){const r=(0,m.toNanoSec)(Hu(e));this.userData.receiveTime=n,this.userData.messageTime=r,this.userData.frameId=this.renderer.normalizeFrameId(Wu(e)),this.userData.pointCloud=e,this.userData.originalMessage=t;const a=this.userData.settings,o=a.decayTime>0;this.userData.settings=i;let l=this.userData.material,c=this.userData.stixelMaterial;const h=$s(i)!==l.transparent||zn(i)!==zn(a)||i.pointShape!==a.pointShape,f=this.pointsHistory,u=this.stixelsHistory;h?(l.dispose(),l=Gn(i),this.userData.material=l,f.updateMaterial(l),c.dispose(),c=Qn(i),this.userData.stixelMaterial=c,u.updateMaterial(c)):l.size=i.pointSize;const p=a.stixelsEnabled!==i.stixelsEnabled;if(!i.stixelsEnabled&&p&&u.clearHistory(),!this._validatePointCloud(e)||!this._getPointCloudFieldReaders(Co,e,i))return;const g=this.userData.topic,b=i.decayTime>0;if(b){const j=po(g,d.W2J),se=di(g,Is(e),j,l,this.userData.pickingMaterial,void 0);if(f.addHistoryEntry({receiveTime:n,messageTime:r,object3d:se}),this.add(se),i.stixelsEnabled){const Pt=Io(g,d.W2J),Lt=Do(g,Is(e),Pt,c);u.addHistoryEntry({receiveTime:n,messageTime:r,object3d:Lt}),this.add(Lt)}}const T=f.latest();if(!T)throw new Error(`pointsHistory is empty for ${g}`);T.receiveTime=n,T.messageTime=r,T.object3d.userData.pose=Is(e);const _=Math.trunc(e.data.length/ws(e)),R=T.object3d;T.object3d.geometry.resize(_);const N=R.geometry.attributes.position,P=R.geometry.attributes.color,O=u.latest();if(!O)throw new Error(`stixelsHistory is empty for ${g}`);!b&&o!==b&&(T.object3d.geometry.setUsage(d.dj0),O.object3d.geometry.setUsage(d.dj0)),O.receiveTime=n,O.messageTime=r,O.object3d.userData.pose=T.object3d.userData.pose,i.stixelsEnabled?O.object3d.geometry.resize(_*2):O.object3d.geometry.resize(0);const U=O.object3d.geometry.attributes.position,V=O.object3d.geometry.attributes.color;this._updatePointCloudBuffers(e,Co,_,i,N,P,U,V)}startFrame(e,t,i){if(this.visible=this.userData.settings.visible,!this.userData.settings.visible){this.renderer.settings.errors.clearPath(this.userData.settingsPath),this.pointsHistory.clearHistory(),this.stixelsHistory.clearHistory();return}this.pointsHistory.updateHistoryFromCurrentTime(e),this.pointsHistory.updatePoses(e,t,i),this.userData.settings.stixelsEnabled&&(this.stixelsHistory.updateHistoryFromCurrentTime(e),this.stixelsHistory.updatePoses(e,t,i))}invalidError(e){this.renderer.settings.errors.addToTopic(this.userData.topic,Jn,e),this.pointsHistory.latest()?.object3d.geometry.resize(0)}_validatePointCloud(e){return e.header?this._validateRosPointCloud(e):this._validateFoxglovePointCloud(e)}_validateFoxglovePointCloud(e){const t=e.data;if(t.length%e.point_stride!==0){const i=`PointCloud data length ${t.length} is not a multiple of point_stride ${e.point_stride}`;return this.invalidError(i),!1}if(e.fields.length===0){const i="PointCloud has no fields";return this.invalidError(i),!1}return!0}_validateRosPointCloud(e){const t=e.data;if(e.is_bigendian){const i="PointCloud2 is_bigendian=true is not supported";return this.invalidError(i),!1}if(t.length%e.point_step!==0){const i=`PointCloud2 data length ${t.length} is not a multiple of point_step ${e.point_step}`;return this.invalidError(i),!1}if(e.fields.length===0){const i="PointCloud2 has no fields";return this.invalidError(i),!1}if(t.length<e.height*e.row_step){const i=`PointCloud2 data length ${t.length} is less than height ${e.height} * row_step ${e.row_step}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Jn,i)}if(e.width*e.point_step>e.row_step){const i=`PointCloud2 width ${e.width} * point_step ${e.point_step} is greater than row_step ${e.row_step}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Jn,i)}return!0}_getPointCloudFieldReaders(e,t,i){let n,r,a,o,l,c,h,f;const u=ws(t);let p=0;for(let b=0;b<t.fields.length;b++){const T=t.fields[b];if(!Nt(T))continue;const _=T.type,R=_!=null?Oc(_):T.datatype;if(T.offset<0){const P=`PointCloud field "${T.name}" has invalid offset ${T.offset}. Must be >= 0`;return this.invalidError(P),!1}if(T.name==="x"){if(n=Ie(T,u),!n){const O=`PointCloud field "x" is invalid. type=${pi(R)}, offset=${T.offset}, stride=${u}`;return this.invalidError(O),!1}}else if(T.name==="y"){if(r=Ie(T,u),!r){const O=`PointCloud field "y" is invalid. type=${pi(R)}, offset=${T.offset}, stride=${u}`;return this.invalidError(O),!1}}else if(T.name==="z"){if(a=Ie(T,u),!a){const O=`PointCloud field "z" is invalid. type=${pi(R)}, offset=${T.offset}, stride=${u}`;return this.invalidError(O),!1}}else T.name==="red"?l=Ie(T,u,!0):T.name==="green"?c=Ie(T,u,!0):T.name==="blue"?h=Ie(T,u,!0):T.name==="alpha"&&(f=Ie(T,u,!0));const N=Gu(R);if(p=Math.max(p,T.offset+N),T.name===i.colorField){const P=(i.colorMode==="rgb"||i.colorMode==="rgba")&&N>=4?_!=null?L.NumericType.UINT32:W.UINT32:void 0;if(o=Ie(T,u,!1,P),!o){const O=pi(R),U=`PointCloud field "${T.name}" is invalid. type=${O}, offset=${T.offset}, stride=${u}`;return this.invalidError(U),!1}}}if(p>u){const b=`PointCloud stride ${u} is less than minimum bytes per point ${p}`;return this.invalidError(b),!1}if((n?1:0)+(r?1:0)+(a?1:0)<2){const b="PointCloud must contain at least two of x/y/z fields";return this.invalidError(b),!1}return e.xReader=n??ve,e.yReader=r??ve,e.zReader=a??ve,e.packedColorReader=o??n??r??a??ve,e.redReader=l??ve,e.greenReader=c??ve,e.blueReader=h??ve,e.alphaReader=f??ve,!0}_minMaxColorValues(e,t,i,n,r,a){let o=a.minValue??Number.POSITIVE_INFINITY,l=a.maxValue??Number.NEGATIVE_INFINITY;if(Uu.includes(a.colorMode)&&(a.minValue==null||a.maxValue==null)){for(let c=0;c<n;c++){const h=c*r,f=t(i,h);o=Math.min(o,f),l=Math.max(l,f)}o=a.minValue??o,l=a.maxValue??l}e[0]=o,e[1]=l}_updatePointCloudBuffers(e,t,i,n,r,a,o,l){const c=e.data,h=new DataView(c.buffer,c.byteOffset,c.byteLength),f=ws(e),{xReader:u,yReader:p,zReader:g,packedColorReader:b,redReader:T,greenReader:_,blueReader:R,alphaReader:N}=t;for(let P=0;P<i;P++){const O=P*f,U=u(h,O),V=p(h,O),j=g(h,O);r.setXYZ(P,U,V,j),n.stixelsEnabled&&(o.setXYZ(P*2,U,V,j),o.setXYZ(P*2+1,U,V,0))}if(n.colorMode==="rgba-fields")for(let P=0;P<i;P++){const O=P*f,U=T(h,O),V=_(h,O),j=R(h,O),se=N(h,O);a.setXYZW(P,U,V,j,se),n.stixelsEnabled&&(l.setXYZW(P*2,U,V,j,se),l.setXYZW(P*2+1,U,V,j,se))}else{this._minMaxColorValues(xo,b,h,i,f,n);const[P,O]=xo,U=Xi(n,P,O);for(let V=0;V<i;V++){const j=V*f,se=b(h,j);U(Pe,se),a.setXYZW(V,Pe.r,Pe.g,Pe.b,Pe.a),n.stixelsEnabled&&(l.setXYZW(V*2,Pe.r,Pe.g,Pe.b,Pe.a),l.setXYZW(V*2+1,Pe.r,Pe.g,Pe.b,Pe.a))}}r.needsUpdate=!0,a.needsUpdate=!0,o.needsUpdate=!0,l.needsUpdate=!0}}class zu extends ie{constructor(e){super("foxglove.PointClouds",e),this.fieldsByTopic=new Map,this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n],o={...Xn,...a};r.updatePointCloud(r.userData.pointCloud,r.userData.originalMessage,o,r.userData.receiveTime)}},this.handleFoxglovePointCloud=t=>{const i=t.topic,n=$u(t.message),r=(0,m.toNanoSec)(t.receiveTime),a=(0,m.toNanoSec)(n.timestamp),o=n.frame_id;let l=this.fieldsByTopic.get(i);(!l||l.length!==n.fields.length)&&(l=n.fields.map(c=>c.name),this.fieldsByTopic.set(i,l),this.updateSettingsTree()),this.handlePointCloud(i,n,r,a,t.message,o)},this.handleRosPointCloud=t=>{const i=t.topic,n=Vu(t.message),r=(0,m.toNanoSec)(t.receiveTime),a=(0,m.toNanoSec)(n.header.stamp),o=n.header.frame_id;let l=this.fieldsByTopic.get(i);const c=n.fields.reduce((h,f)=>h+(Nt(f)?1:0),0);(!l||l.length!==c)&&(l=(0,hs.DZ)(n.fields,h=>Nt(h)?h.name:void 0),this.fieldsByTopic.set(i,l),this.updateSettingsTree()),this.handlePointCloud(i,n,r,a,t.message,o)},e.addSchemaSubscriptions(Hs,this.handleRosPointCloud),e.addSchemaSubscriptions(ks,this.handleFoxglovePointCloud)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!Y(n,ku))continue;const a=e[n.name]??{},o=this.fieldsByTopic.get(n.name)??uo,l=kn(n,o,a);l.fields.stixelsEnabled={label:"Stixel view",input:"boolean",value:a.stixelsEnabled??Xn.stixelsEnabled},l.handler=t,l.icon="Points",i.push({path:["topics",n.name],node:l})}return i}startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i)}handlePointCloud(e,t,i,n,r,a){let o=this.renderables.get(e);if(!o){const l=this.renderer.config.topics[e],c={...Xn,...l};c.colorField==null&&(fo(c,t,{supportsPackedRgbModes:!0}),this.renderer.updateConfig(g=>{const b={...l};b.colorField=c.colorField,b.colorMode=c.colorMode,b.colorMap=c.colorMap,g.topics[e]=b}));const h=Gn(c),f=mo(c),u=go(c),p=Qn(c);o=new wo(e,this.renderer,{receiveTime:i,messageTime:n,frameId:this.renderer.normalizeFrameId(a),pose:Q(),settingsPath:["topics",e],settings:c,topic:e,pointCloud:t,originalMessage:r,material:h,pickingMaterial:f,instancePickingMaterial:u,stixelMaterial:p}),this.add(o),this.renderables.set(e,o)}o.updatePointCloud(t,r,o.userData.settings,i)}}function pi(s){return W[s]??`${s}`}function Gu(s){switch(s){case W.INT8:case W.UINT8:return 1;case W.INT16:case W.UINT16:return 2;case W.INT32:case W.UINT32:case W.FLOAT32:return 4;case W.FLOAT64:return 8;default:return 0}}function ve(){return 0}function Bu(s){return s?{name:s.name??"",offset:s.offset??0,datatype:s.datatype??W.UNKNOWN,count:s.count??0}:{name:"",offset:0,datatype:W.UNKNOWN,count:0}}function ju(s){return{name:s?.name??"",offset:s?.offset??0,type:s?.type??0}}function $u(s){return{timestamp:ge(s.timestamp),frame_id:s.frame_id??"",pose:oe(s.pose),point_stride:s.point_stride??0,fields:s.fields?.map(ju)??[],data:Yt(s.data)}}function Vu(s){return{header:Fe(s.header),height:s.height??0,width:s.width??0,fields:s.fields?.map(Bu)??[],is_bigendian:s.is_bigendian??!1,point_step:s.point_step??0,row_step:s.row_step??0,data:Yt(s.data),is_dense:s.is_dense??!1}}function Hu(s){const e=s;return e.header?e.header.stamp:s.timestamp}function Wu(s){const e=s;return e.header?e.header.frame_id:s.frame_id}function ws(s){const e=s;return e.point_step!=null?e.point_step:s.point_stride}function Is(s){return s.pose??Q()}function Qn(s){const e=$s(s);return new d.nls({vertexColors:!0,transparent:e,depthWrite:!0})}function Io(s,e){const t=new Ss(e);return t.name=`${s}:PointCloud:stixelGeometry`,t.createAttribute("position",Float32Array,3),t.createAttribute("color",Uint8Array,4,!0),t}function Do(s,e,t,i){const n=new d.ejS(t,i);return n.frustumCulled=!1,n.name=`${s}:PointCloud:stixels`,n.userData={pose:e},n}class qn extends Ue{constructor(e,t,i,n){super(e,t,i,n),this.geometry=new ii.L;const r={resolution:n.input.canvasSize,worldUnits:!0},a=xa(t,r);this.linePrepass=new si.w(this.geometry,a),this.linePrepass.renderOrder=1,this.linePrepass.userData.picking=!1,this.add(this.linePrepass);const o=Ca(t,r);this.line=new si.w(this.geometry,o),this.line.renderOrder=2;const l=t.scale.x*1.2;this.line.userData.pickingMaterial=wn(l,r),this.add(this.line),this.update(t,i)}dispose(){this.linePrepass.material.dispose(),this.line.material.dispose(),this.line.userData.pickingMaterial.dispose(),this.line.userData.pickingMaterial=void 0,super.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=n.points.length,a=n.scale.x,o=he(n);if(r===0){this.linePrepass.visible=!1,this.line.visible=!1;return}else this.linePrepass.visible=!0,this.line.visible=!0;o!==he(i)&&(this.linePrepass.material.transparent=o,this.linePrepass.material.depthWrite=!o,this.linePrepass.material.needsUpdate=!0,this.line.material.transparent=o,this.line.material.depthWrite=!o,this.line.material.needsUpdate=!0);const l=this.linePrepass.material;l.lineWidth=a;const c=this.line.material;c.lineWidth=a;const h=(this.geometry.attributes.instanceStart?.count??0)*2;r!==h&&(this.geometry.dispose(),this.geometry=new ii.L,this.linePrepass.geometry=this.geometry,this.line.geometry=this.geometry),this._setPositions(n,r),this._setColors(n,r),this.linePrepass.computeLineDistances(),this.line.computeLineDistances()}_setPositions(e,t){const i=new Float32Array(3*t);for(let n=0;n<t;n++){const r=e.points[n],a=n*3;i[a+0]=r.x,i[a+1]=r.y,i[a+2]=r.z}this.geometry.setPositions(i)}_setColors(e,t){const i=new Float32Array(8*t),n=[0,0,0,0];this._markerColorsToLinear(e,t,(a,o)=>{if(o===0){Mo(a,n);return}const c=(o-1)*8;i[c+0]=n[0],i[c+1]=n[1],i[c+2]=n[2],i[c+3]=n[3],i[c+4]=a[0],i[c+5]=a[1],i[c+6]=a[2],i[c+7]=a[3],Mo(a,n)});const r=new d.$TI(i,8,1);this.geometry.setAttribute("instanceColorStart",new d.kB5(r,4,0)),this.geometry.setAttribute("instanceColorEnd",new d.kB5(r,4,4))}}function Mo(s,e){e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3]}const Yu={r:124/255,g:107/255,b:1,a:1},Eo=.1,Ao=pe(Yu),er={visible:!1,lineWidth:Eo,color:Ao};class Zu extends fe{dispose(){this.userData.lines?.dispose(),super.dispose()}details(){return this.userData.polygonStamped}}class Ku extends ie{constructor(e){super("foxglove.Polygons",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n];r.userData.settings={...er,...a},this._updatePolygonRenderable(r,r.userData.polygonStamped,r.userData.receiveTime)}},this.handlePolygon=t=>{const i=t.topic,n=Qu(t.message),r=(0,m.toNanoSec)(t.receiveTime);let a=this.renderables.get(i);if(!a){const o=this.renderer.config.topics[i],l={...er,...o};a=new Zu(i,this.renderer,{receiveTime:r,messageTime:(0,m.toNanoSec)(n.header.stamp),frameId:this.renderer.normalizeFrameId(n.header.frame_id),pose:Q(),settingsPath:["topics",i],settings:l,topic:i,polygonStamped:n,lines:void 0}),this.add(a),this.renderables.set(i,a)}this._updatePolygonRenderable(a,n,r)},e.addSchemaSubscriptions(ln,this.handlePolygon)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!Y(n,ln))continue;const r=e[n.name]??{},a={lineWidth:{label:"Line Width",input:"number",min:0,placeholder:String(Eo),step:.005,precision:3,value:r.lineWidth},color:{label:"Color",input:"rgba",value:r.color??Ao}};i.push({path:["topics",n.name],node:{label:n.name,icon:"Star",fields:a,visible:r.visible??er.visible,handler:t}})}return i}_updatePolygonRenderable(e,t,i){const n=e.userData.settings;e.userData.receiveTime=i,e.userData.messageTime=(0,m.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.polygonStamped=t;const r=e.userData.topic,a=Xu(t,n);e.userData.lines?e.userData.lines.update(a,i):(e.userData.lines=new qn(r,a,i,this.renderer),e.add(e.userData.lines))}}function Xu(s,e){const t=[...s.polygon.points];return t.length>0&&t.push(t[0]),{header:s.header,ns:"",id:0,type:A.LINE_STRIP,action:me.ADD,pose:Q(),scale:{x:e.lineWidth,y:1,z:1},color:$(de(),e.color),lifetime:Tt,frame_locked:!0,points:t,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function Ju(s){return{points:ia(s?.points)}}function Qu(s){return{header:Fe(s.header),polygon:Ju(s.polygon)}}var qu=v(89380);const Po=.77,Lo=1,Ro=.23,No=2,ef=.23,tf=new d.Pa4(1,0,0),Oo=new d.Pa4,Fo=new d.Pa4,Ds=new d.Pa4;class mi extends Ue{constructor(e,t,i,n){super(e,t,i,n);const r=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaft-${n.maxLod}`,()=>sf(n.maxLod)),a=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-head-${n.maxLod}`,()=>nf(n.maxLod)),o=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges-${n.maxLod}`,()=>rf(r)),l=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-headedges-${n.maxLod}`,()=>af(a));this.shaftMesh=new d.Kj0(r,Xt(t.color)),this.shaftMesh.castShadow=!0,this.shaftMesh.receiveShadow=!0,this.add(this.shaftMesh),this.headMesh=new d.Kj0(a,Xt(t.color)),this.headMesh.castShadow=!0,this.headMesh.receiveShadow=!0,this.add(this.headMesh),this.shaftOutline=new d.ejS(o,n.outlineMaterial),this.shaftOutline.userData.picking=!1,this.shaftMesh.add(this.shaftOutline),this.headOutline=new d.ejS(l,n.outlineMaterial),this.headOutline.userData.picking=!1,this.headMesh.add(this.headOutline),this.update(t,i)}dispose(){this.shaftMesh.material.dispose(),this.headMesh.material.dispose(),super.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.shaftMesh.material.transparent&&(this.shaftMesh.material.transparent=n,this.shaftMesh.material.depthWrite=!n,this.shaftMesh.material.needsUpdate=!0,this.headMesh.material.transparent=n,this.headMesh.material.depthWrite=!n,this.headMesh.material.needsUpdate=!0),_e(this.shaftMesh.material.color,i.color),this.shaftMesh.material.opacity=i.color.a,this.headMesh.material.color.set(this.shaftMesh.material.color),this.headMesh.material.opacity=i.color.a;const r=this.getSettings();if(this.shaftOutline.visible=r?.showOutlines??!0,this.headOutline.visible=r?.showOutlines??!0,i.points.length===2){const a=i.points[0],o=i.points[1];Oo.set(a.x,a.y,a.z),Fo.set(o.x,o.y,o.z),Ds.subVectors(Fo,Oo);const l=Ds.length();let c=ef*l;if(i.scale.z!==0){const g=i.scale.z;c=(0,qu.uZ)(g,0,l)}const h=l-c,f=i.scale.x,u=i.scale.y;this.shaftMesh.scale.set(h,f,f),this.headMesh.scale.set(c,u,u),this.scale.set(1,1,1),this.shaftMesh.position.set(a.x,a.y,a.z),this.shaftMesh.position.addScaledVector(Ds,.5*(h/l)),this.headMesh.position.set(o.x,o.y,o.z),this.headMesh.position.addScaledVector(Ds,-.5*(c/l));const p=ac(tf,Ds);this.shaftMesh.setRotationFromQuaternion(p),this.headMesh.rotation.copy(this.shaftMesh.rotation)}else{this.shaftMesh.scale.set(Po,Lo,Lo),this.headMesh.scale.set(Ro,No,No),this.scale.set(i.scale.x,i.scale.y,i.scale.z);const a=Po/2,o=Ro/2;this.shaftMesh.position.set(a,0,0),this.headMesh.position.set(a*2+o,0,0),this.shaftMesh.rotation.set(0,0,0),this.headMesh.rotation.set(0,0,0)}}}function sf(s){const e=ba(s),t=new d.fHI(.5,.5,1,e,1,!1);return t.rotateZ(-Math.PI/2),t.computeBoundingSphere(),t}function nf(s){const e=va(s),t=new d.b_z(.5,1,e,1,!1);return t.rotateZ(-Math.PI/2),t.computeBoundingSphere(),t}function rf(s){const e=new d.TOt(s,40),t=e.getAttribute("position"),i=Array.from(t.array),n=i.length/3/2*3,r=i.slice(n,i.length),a=new d.a$l(r,3);return e.setAttribute("position",a),e.computeBoundingSphere(),e}function af(s){const e=new d.TOt(s,40);return e.computeBoundingSphere(),e}class gi extends Ue{constructor(e,t,i,n){super(e,t,i,n);const r=n.sharedGeometry.getGeometry(`${this.constructor.name}-${n.maxLod}`,()=>Uo(n.maxLod));this.mesh=new d.Kj0(r,Xt(t.color)),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh),this.update(t,i)}dispose(){this.mesh.material.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.mesh.material.transparent&&(this.mesh.material.transparent=n,this.mesh.material.depthWrite=!n,this.mesh.material.needsUpdate=!0),_e(this.mesh.material.color,i.color),this.mesh.material.opacity=i.color.a,this.scale.set(i.scale.x,i.scale.y,i.scale.z)}}function Uo(s){const e=Ud(s),t=new d.xo$(.5,e,e);return t.computeBoundingSphere(),t}const ko="axis",zo=bs,Go=[1,.15,.15],of={r:124/255,g:107/255,b:1,a:1},Bo=!0,lf={r:198/255,g:107/255,b:1,a:.25},jo=pe(of),$o=pe(lf),tr={type:ko,visible:!1,axisScale:zo,arrowScale:Go,color:jo,showCovariance:Bo,covarianceColor:$o},cf=[{label:"Axis",value:"axis"},{label:"Arrow",value:"arrow"}];class df extends fe{dispose(){this.userData.axis?.dispose(),this.userData.arrow?.dispose(),this.userData.sphere?.dispose(),super.dispose()}details(){return this.userData.originalMessage}}class hf extends ie{constructor(e){super("foxglove.Poses",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n];this._updatePoseRenderable(r,r.userData.poseMessage,r.userData.originalMessage,r.userData.receiveTime,{...tr,...a})}},this.handlePoseStamped=t=>{const i=ff(t.message),n=(0,m.toNanoSec)(t.receiveTime);this.addPose(t.topic,i,t.message,n)},this.handlePoseInFrame=t=>{const i=pf(t.message),n=(0,m.toNanoSec)(t.receiveTime);this.addPose(t.topic,i,t.message,n)},this.handlePoseWithCovariance=t=>{const i=gf(t.message),n=(0,m.toNanoSec)(t.receiveTime);this.addPose(t.topic,i,t.message,n)},e.addSchemaSubscriptions(rn,this.handlePoseStamped),e.addSchemaSubscriptions(ki,this.handlePoseInFrame),e.addSchemaSubscriptions(an,this.handlePoseWithCovariance)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){const r=Y(n,rn),a=Y(n,ki),o=r?!1:Y(n,an);if(!(r||o||a))continue;const l=e[n.name]??{},c=l.type??ko,h={type:{label:"Type",input:"select",options:cf,value:c}};if(c==="axis"?h.axisScale={label:"Scale",input:"number",step:.5,min:0,precision:K,value:l.axisScale??zo}:(h.arrowScale={label:"Scale",input:"vec3",labels:["X","Y","Z"],step:.5,precision:K,value:l.arrowScale??Go},h.color={label:"Color",input:"rgba",value:l.color??jo}),o){const f=l.showCovariance??Bo,u=l.covarianceColor??$o;h.showCovariance={label:"Covariance",input:"boolean",value:f},f&&(h.covarianceColor={label:"Covariance Color",input:"rgba",value:u})}i.push({path:["topics",n.name],node:{label:n.name,icon:"Flag",fields:h,visible:l.visible??tr.visible,order:n.name.toLocaleLowerCase(),handler:t}})}return i}addPose(e,t,i,n){let r=this.renderables.get(e);if(!r){const a=this.renderer.config.topics[e],o={...tr,...a};r=new df(e,this.renderer,{receiveTime:n,messageTime:(0,m.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:Q(),settingsPath:["topics",e],settings:o,topic:e,poseMessage:t,originalMessage:i,axis:void 0,arrow:void 0,sphere:void 0}),this.add(r),this.renderables.set(e,r)}this._updatePoseRenderable(r,t,i,n,r.userData.settings)}_updatePoseRenderable(e,t,i,n,r){e.userData.receiveTime=n,e.userData.messageTime=(0,m.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.poseMessage=t,e.userData.originalMessage=i,e.userData.sphere&&(e.userData.sphere.visible=!1);const{topic:a,settings:o}=e.userData,l=r.type!==o.type||r.axisScale!==o.axisScale||!Vi(r.arrowScale,o.arrowScale)||r.color!==o.color||!e.userData.arrow&&!e.userData.axis;if(e.userData.settings=r,l)if(e.userData.settings.type==="axis"){if(e.userData.arrow&&(e.remove(e.userData.arrow),e.userData.arrow.dispose(),e.userData.arrow=void 0),!e.userData.axis){const h=new vs(a,this.renderer);e.userData.axis=h,e.add(h)}const c=e.userData.settings.axisScale*(1/bs);e.userData.axis.scale.set(c,c,c)}else{e.userData.axis&&(e.remove(e.userData.axis),e.userData.axis.dispose(),e.userData.axis=void 0);const c=$(de(),r.color),h=Vo(r.arrowScale,c);if(!e.userData.arrow){const f=new mi(a,h,void 0,this.renderer);e.userData.arrow=f,e.add(f)}e.userData.arrow.update(h,void 0)}if("covariance"in t.pose){e.userData.pose=t.pose.pose;const h=uf(t,e.userData.settings);h?(e.userData.sphere||(e.userData.sphere=new gi(e.userData.topic,h,void 0,this.renderer),e.add(e.userData.sphere)),e.userData.sphere.visible=e.userData.settings.showCovariance,e.userData.sphere.update(h,void 0)):e.userData.sphere&&(e.userData.sphere.visible=!1)}else e.userData.pose=t.pose}}function Vo(s,e){const[t,i,n]=s;return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:A.ARROW,action:me.ADD,pose:Q(),scale:{x:t,y:i,z:n},color:e,lifetime:Tt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function uf(s,e){const t=s.pose.covariance,i={x:Math.sqrt(t[0]),y:Math.sqrt(t[7]),z:Math.sqrt(t[14])};return{header:s.header,ns:"",id:1,type:A.SPHERE,action:me.ADD,pose:Q(),scale:i,color:$(de(),e.covarianceColor),lifetime:Tt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function ff(s){return{header:Fe(s.header),pose:oe(s.pose)}}function pf(s){return{header:{stamp:ge(s.timestamp),frame_id:s.frame_id??""},pose:oe(s.pose)}}function mf(s){const e=Pc(s?.covariance);return{pose:oe(s?.pose),covariance:e}}function gf(s){return{header:Fe(s.header),pose:mf(s.pose)}}const Ho="axis",yf=bs,Wo=[1,.15,.15],Yo=.2,Zo=[{r:124/255,g:107/255,b:1,a:1},{r:124/255,g:107/255,b:1,a:.5}],bf="MISMATCHED_FRAME_ID",vf={sec:0,nsec:0},Tf={r:1,g:1,b:1,a:1},Ko=[pe(Zo[0]),pe(Zo[1])],sr={visible:!1,type:Ho,axisScale:yf,arrowScale:Wo,lineWidth:Yo,gradient:Ko},Sf=[{label:"Axis",value:"axis"},{label:"Arrow",value:"arrow"},{label:"Line",value:"line"}],_f=de(),xf=de(),Cf=de();class wf extends fe{dispose(){this.userData.axes.forEach(e=>e.dispose()),this.userData.arrows.forEach(e=>e.dispose()),this.userData.lineStrip?.dispose(),super.dispose()}details(){return this.userData.originalMessage}removeArrows(){for(const e of this.userData.arrows)this.remove(e),e.dispose();this.userData.arrows.length=0}removeAxes(){for(const e of this.userData.axes)this.remove(e),e.dispose();this.userData.axes.length=0}removeLineStrip(){this.userData.lineStrip&&(this.remove(this.userData.lineStrip),this.userData.lineStrip.dispose(),this.userData.lineStrip=void 0)}}class If extends ie{constructor(e){super("foxglove.PoseArrays",e),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n],o={type:ir(this.renderer.topicsByName?.get(n))};this._updatePoseArrayRenderable(r,r.userData.poseArrayMessage,r.userData.originalMessage,r.userData.receiveTime,{...sr,...o,...a})}},this.handlePoseArray=t=>{const i=Df(t.message),n=(0,m.toNanoSec)(t.receiveTime);this.addPoseArray(t.topic,i,t.message,n)},this.handleNavPath=t=>{if(!Af(t,this.renderer))return;const i=Mf(t.message),n=(0,m.toNanoSec)(t.receiveTime);this.addPoseArray(t.topic,i,t.message,n)},this.handlePosesInFrame=t=>{const i=Ef(t.message),n=(0,m.toNanoSec)(t.receiveTime);this.addPoseArray(t.topic,i,t.message,n)},e.addSchemaSubscriptions(on,this.handlePoseArray),e.addSchemaSubscriptions(zi,this.handlePosesInFrame),e.addSchemaSubscriptions(ds,this.handleNavPath)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!(Y(n,on)||Y(n,ds)||Y(n,zi)))continue;const r=e[n.name]??{},a=r.type??ir(n),{axisScale:o,lineWidth:l}=r,c=r.arrowScale??Wo,h=r.gradient??Ko,f={type:{label:"Type",input:"select",options:Sf,value:a}};switch(a){case"axis":f.axisScale=Ta("Scale",o,K);break;case"arrow":f.arrowScale=kd("Scale",c);break;case"line":f.lineWidth=Sa("Line Width",l,Yo);break}a!=="axis"&&(f.gradient=zd("Gradient",h)),i.push({path:["topics",n.name],node:{label:n.name,icon:Y(n,ds)?"Timeline":"Flag",fields:f,visible:r.visible??sr.visible,handler:t}})}return i}addPoseArray(e,t,i,n){let r=this.renderables.get(e);if(!r){const a=this.renderer.config.topics[e],o={type:ir(this.renderer.topicsByName?.get(e))},l={...sr,...o,...a};r=new wf(e,this.renderer,{receiveTime:n,messageTime:(0,m.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:Q(),settingsPath:["topics",e],settings:l,topic:e,poseArrayMessage:t,originalMessage:i,axes:[],arrows:[]}),this.add(r),this.renderables.set(e,r)}this._updatePoseArrayRenderable(r,t,i,n,r.userData.settings)}_createAxesToMatchPoses(e,t,i){const n=e.userData.settings.axisScale*(1/bs),r=Math.min(e.userData.axes.length,t.poses.length);for(let a=0;a<r;a++){const o=e.userData.axes[a];o.visible=!0,o.scale.set(n,n,n)}for(let a=e.userData.axes.length;a<t.poses.length;a++){const o=new vs(i,this.renderer);e.userData.axes.push(o),e.add(o),o.scale.set(n,n,n)}for(let a=t.poses.length;a<e.userData.axes.length;a++){const o=e.userData.axes[a];o.visible=!1}}_createArrowsToMatchPoses(e,t,i,n,r){const a=l=>{const c=l/(t.poses.length-1),h=Ki(Cf,n,r,c);return Vo(e.userData.settings.arrowScale,h)},o=Math.min(e.userData.arrows.length,t.poses.length);for(let l=0;l<o;l++){const c=a(l),h=e.userData.arrows[l];h.visible=!0,h.update(c,void 0)}for(let l=e.userData.arrows.length;l<t.poses.length;l++){const c=a(l),h=new mi(i,c,void 0,this.renderer);e.userData.arrows.push(h),e.add(h)}for(let l=t.poses.length;l<e.userData.arrows.length;l++){const c=e.userData.arrows[l];c.visible=!1}}_updatePoseArrayRenderable(e,t,i,n,r){e.userData.receiveTime=n,e.userData.messageTime=(0,m.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.poseArrayMessage=t,e.userData.originalMessage=i;const{topic:a,settings:o}=e.userData,l=r.type!==o.type||r.axisScale!==o.axisScale||!Vi(r.arrowScale,o.arrowScale)||!Vi(r.gradient,o.gradient)||e.userData.arrows.length===0&&e.userData.axes.length===0;e.userData.settings=r;const c=$(_f,r.gradient[0]),h=$(xf,r.gradient[1]);if(l)switch(e.userData.settings.type){case"axis":e.removeArrows(),e.removeLineStrip();break;case"arrow":e.removeAxes(),e.removeLineStrip();break;case"line":{e.removeArrows(),e.removeAxes();const f=Jo(t,r.lineWidth,c,h);if(!e.userData.lineStrip){const u=new qn(a,f,void 0,this.renderer);e.userData.lineStrip=u,e.add(u)}e.userData.lineStrip.update(f,void 0)}break}switch(r.type){case"axis":this._createAxesToMatchPoses(e,t,a);for(let f=0;f<t.poses.length;f++)Xo(e.userData.axes[f],t.poses[f]);break;case"arrow":this._createArrowsToMatchPoses(e,t,a,c,h);for(let f=0;f<t.poses.length;f++)Xo(e.userData.arrows[f],t.poses[f]);break;case"line":{const f=Jo(t,r.lineWidth,c,h);e.userData.lineStrip?.update(f,void 0);break}}}}function ir(s){return s!=null&&ds.has(s.schemaName)?"line":Ho}function Xo(s,e){const t=e.position,i=e.orientation;s.position.set(t.x,t.y,t.z),s.quaternion.set(i.x,i.y,i.z,i.w),s.updateMatrix()}function Jo(s,e,t,i){const n=[];for(let r=0;r<s.poses.length;r++){const a=r/(s.poses.length-1);n.push(Ki(de(),t,i,a))}return{header:s.header,ns:"",id:0,type:A.LINE_STRIP,action:me.ADD,pose:Q(),scale:{x:e,y:1,z:1},color:Tf,lifetime:vf,frame_locked:!0,points:s.poses.map(r=>r.position),colors:n,text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function Df(s){return{header:Fe(s.header),poses:s.poses?.map(e=>oe(e))??[]}}function Mf(s){return{header:Fe(s.header),poses:s.poses?.map(e=>oe(e?.pose))??[]}}function Ef(s){return{header:{stamp:ge(s.timestamp),frame_id:s.frame_id??""},poses:s.poses?.map(oe)??[]}}function Af(s,e){const{topic:t,message:i}=s;if(i.poses){const n=e.normalizeFrameId(i.header?.frame_id??"");for(const r of i.poses){const a=e.normalizeFrameId(r?.header?.frame_id??"");if(n!==a)return e.settings.errors.addToTopic(t,bf,`Path poses must all have the same frame_id. "${n}" != "${a}"`),!1}}return!0}const Qo=new d.Pa4(1,0,0),qo=new d.Pa4;function el(s){return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:A.ARROW,action:me.ADD,pose:Q(),scale:{x:2,y:.25,z:.25},color:s==="pose_estimate"?{r:0,g:1,b:1,a:1}:{r:1,g:0,b:1,a:1},lifetime:Tt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function Pf(){return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:A.SPHERE,action:me.ADD,pose:Q(),scale:{x:.25,y:.25,z:.25},color:{r:1,g:1,b:0,a:1},lifetime:Tt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}class Lf extends ie{constructor(e){super("foxglove.PublishClickTool",e),this.publishClickType="point",this.state="idle",this._handleMouseMove=(t,i,n)=>{if(i){switch(this.state){case"idle":break;case"place-first-point":(this.point1??(this.point1=new d.Pa4)).copy(i);break;case"place-second-point":(this.point2??(this.point2=new d.Pa4)).copy(i);break}this._render()}},this._handleClick=(t,i,n)=>{if(i){switch(this.state){case"idle":break;case"place-first-point":this.point1=i.clone(),this.publishClickType==="point"?(this.dispatchEvent({type:"foxglove.publish-submit",publishClickType:this.publishClickType,point:{x:this.point1.x,y:this.point1.y,z:this.point1.z}}),this._setState("idle")):this._setState("place-second-point");break;case"place-second-point":if(this.point2=i.clone(),this.point1&&this.publishClickType!=="point"){const r=this.point1.clone(),a=new d._fP().setFromUnitVectors(Qo,qo.subVectors(this.point2,this.point1).normalize());this.dispatchEvent({type:"foxglove.publish-submit",publishClickType:this.publishClickType,pose:{position:{x:r.x,y:r.y,z:r.z},orientation:{x:a.x,y:a.y,z:a.z,w:a.w}}})}this._setState("idle");break}this._render()}},this.sphere=new gi("",Pf(),void 0,this.renderer),this.arrow=new mi("",el(this.publishClickType),void 0,this.renderer),this.sphere.visible=!1,this.sphere.mesh.userData.picking=!1,this.arrow.visible=!1,this.arrow.shaftMesh.userData.picking=!1,this.arrow.headMesh.userData.picking=!1,this.add(this.sphere),this.add(this.arrow),this._setState("idle")}dispose(){super.dispose(),this.arrow.dispose(),this.sphere.dispose(),this.renderer.input.removeListener("click",this._handleClick),this.renderer.input.removeListener("mousemove",this._handleMouseMove)}setPublishClickType(e){this.publishClickType=e,this.arrow.update(el(this.publishClickType),void 0),this.dispatchEvent({type:"foxglove.publish-type-change"})}start(){this._setState("place-first-point")}stop(){this._setState("idle")}_setState(e){switch(this.state=e,e){case"idle":this.point1=this.point2=void 0,this.renderer.input.removeListener("click",this._handleClick),this.renderer.input.removeListener("mousemove",this._handleMouseMove),this.dispatchEvent({type:"foxglove.publish-end"});break;case"place-first-point":this.renderer.input.addListener("click",this._handleClick),this.renderer.input.addListener("mousemove",this._handleMouseMove),this.dispatchEvent({type:"foxglove.publish-start"});break;case"place-second-point":break}this._render()}_render(){this.publishClickType==="point"?(this.arrow.visible=!1,this.point1?(this.sphere.visible=!0,this.sphere.position.copy(this.point1)):this.sphere.visible=!1):(this.sphere.visible=!1,this.point1?(this.arrow.visible=!0,this.arrow.position.copy(this.point1),this.point2?this.arrow.quaternion.setFromUnitVectors(Qo,qo.subVectors(this.point2,this.point1).normalize()):this.arrow.quaternion.set(0,0,0,1)):this.arrow.visible=!1),this.renderer.queueAnimationFrame()}}const yi={type:"point",poseTopic:"/move_base_simple/goal",pointTopic:"/clicked_point",poseEstimateTopic:"/initialpose",poseEstimateXDeviation:.5,poseEstimateYDeviation:.5,poseEstimateThetaDeviation:(0,B.round)(Math.PI/12,8)};class Rf extends ie{constructor(e){super("foxglove.PublishSettings",e),this.handleSettingsAction=t=>{if(t.action!=="update"||t.payload.path.length===0)return;const i=t.payload.path,n=i[0],r=t.payload.value;if(n==="publish")i[1]==="topic"?this.renderer.updateConfig(a=>{switch(a.publish.type){case"point":a.publish.pointTopic=r??yi.pointTopic;break;case"pose":a.publish.poseTopic=r??yi.poseTopic;break;case"pose_estimate":a.publish.poseEstimateTopic=r??yi.poseEstimateTopic;break}}):i[1]==="type"?this.renderer.publishClickTool.publishClickType!==r&&(this.renderer.publishClickTool.setPublishClickType(r),this.renderer.publishClickTool.stop()):this.renderer.updateConfig(a=>(0,B.set)(a,i,r));else return;this.updateSettingsTree()},this.handlePublishToolChange=()=>{this.renderer.updateConfig(t=>(t.publish.type=this.renderer.publishClickTool.publishClickType,t)),this.updateSettingsTree()},e.publishClickTool.addEventListener("foxglove.publish-type-change",this.handlePublishToolChange)}dispose(){this.renderer.publishClickTool.removeEventListener("foxglove.publish-type-change",this.handlePublishToolChange),super.dispose()}settingsNodes(){const e=this.renderer.config,{publish:t}=e,i=this.handleSettingsAction;return[{path:["publish"],node:{label:"Publish",fields:{type:{label:"Type",input:"select",value:t.type,options:[{label:"Point (geometry_msgs/Point)",value:"point"},{label:"Pose (geometry_msgs/PoseStamped)",value:"pose"},{label:"Pose estimate (geometry_msgs/PoseWithCovarianceStamped)",value:"pose_estimate"}],help:"The type of message to publish when clicking in the scene"},topic:{label:"Topic",input:"string",value:{point:t.pointTopic,pose:t.poseTopic,pose_estimate:t.poseEstimateTopic}[t.type],help:`The topic on which to publish ${{point:"points",pose:"poses",pose_estimate:"pose estimates"}[t.type]}`},...t.type==="pose_estimate"&&{poseEstimateXDeviation:{label:"X deviation",input:"number",value:t.poseEstimateXDeviation,help:"The X standard deviation to publish with pose estimates"},poseEstimateYDeviation:{label:"Y deviation",input:"number",value:t.poseEstimateYDeviation,help:"The Y standard deviation to publish with pose estimates"},poseEstimateThetaDeviation:{label:"Theta deviation",input:"number",value:t.poseEstimateThetaDeviation,help:"The theta standard deviation to publish with pose estimates"}}},defaultExpansionState:"collapsed",handler:i}}]}}var q;(function(s){s.CUBES="CUBES",s.MODELS="MODELS",s.LINES="LINES",s.CYLINDERS="CYLINDERS",s.ARROWS="ARROWS",s.SPHERES="SPHERES",s.TEXTS="TEXTS",s.TRIANGLES="TRIANGLES"})(q||(q={}));const Nf=[q.CUBES,q.MODELS,q.LINES,q.CYLINDERS,q.ARROWS,q.SPHERES,q.TEXTS,q.TRIANGLES],Of="INVALID_DELETION_TYPE",Ff={[q.CUBES]:"cubes",[q.MODELS]:"models",[q.LINES]:"lines",[q.CYLINDERS]:"cylinders",[q.ARROWS]:"arrows",[q.SPHERES]:"spheres",[q.TEXTS]:"texts",[q.TRIANGLES]:"triangles"};class Uf extends fe{constructor(e,t,i,n){super(e,i,n),this.primitivePool=t,this.pickable=!1,this.renderablesById=new Map}dispose(){this.children.length=0,this._deleteAllEntities()}updateSettings(){for(const e of this.renderablesById.values())for(const t of Object.values(e))t.updateSettings(this.userData.settings)}setColorScheme(e){for(const t of this.renderablesById.values())for(const i of Object.values(t))i.setColorScheme(e)}startFrame(e,t,i){if(this.visible=this.userData.settings.visible,!this.visible){this.renderer.settings.errors.clearTopic(this.topic);return}for(const n of this.renderablesById.values())for(const r of Object.values(n)){const a=r.userData.entity;if(!a)continue;const o=r.userData.expiresAt;if(o!=null&&e>o){this._deleteEntity(a.id);break}const l=this.renderer.normalizeFrameId(a.frame_id),c=a.frame_locked?e:(0,m.toNanoSec)(a.timestamp),h=ps(r,this.renderer.transformTree,t,i,l,e,c);r.visible=h;const f=this.userData.topic;if(h)this.renderer.settings.errors.removeFromTopic(f,lt);else{const u=fs(t,i,l);this.renderer.settings.errors.addToTopic(f,lt,u)}}}addOrUpdateEntity(e,t){let i=this.renderablesById.get(e.id);i||(i={},this.renderablesById.set(e.id,i));for(const n of Nf){const r=e[Ff[n]].length>0;let a=i[n];r?(a||(a=this.primitivePool.acquire(n),a.name=`${e.id}:${n} on ${this.topic}`,a.userData.settingsPath=this.userData.settingsPath,a.setColorScheme(this.renderer.colorScheme),i[n]=a,this.add(a)),a.update(this.userData.topic,e,this.userData.settings,t)):a&&(this.remove(a),delete i[n],this.primitivePool.release(n,a))}}deleteEntities(e){switch(e.type){case L.SceneEntityDeletionType.MATCHING_ID:this._deleteEntity(e.id);break;case L.SceneEntityDeletionType.ALL:this._deleteAllEntities();break;default:this.renderer.settings.errors.addToTopic(this.topic,Of,`Invalid deletion type ${e.type}`)}}_removeRenderables(e){for(const[t,i]of Object.entries(e))i&&(this.remove(i),this.primitivePool.release(t,i))}_deleteEntity(e){const t=this.renderablesById.get(e);t&&this._removeRenderables(t),this.renderablesById.delete(e)}_deleteAllEntities(){for(const e of this.renderablesById.values())this._removeRenderables(e);this.renderablesById.clear()}}const kf={showOutlines:!0,visible:!1,color:void 0,selectedIdVariable:void 0};class Mt extends fe{constructor(e,t,i={receiveTime:-1n,messageTime:-1n,frameId:"",pose:jn(),settings:kf,settingsPath:[],entity:void 0}){super(e,t,i)}update(e,t,i,n){this.userData.topic=e,this.userData.entity=t,this.userData.settings=i,this.userData.receiveTime=n}idFromMessage(){return this.userData.entity?.id}selectedIdVariable(){return this.getSettings()?.selectedIdVariable}getSettings(){if(this.userData.topic!=null)return this.userData.settings}details(){return this.userData.entity??{}}setColorScheme(e){}prepareForReuse(){this.userData.entity=void 0,this.userData.pose=jn()}addError(e,t){this.renderer.settings.errors.add(this.userData.settingsPath,e,t)}clearErrors(){this.userData.settingsPath.length>0&&this.renderer.settings.errors.clearPath(this.userData.settingsPath)}}class bi extends d.Wid{onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=e.vertexShader.replace("#include <color_pars_vertex>",`
        #include <color_pars_vertex>
        attribute float instanceOpacity;
        varying float vInstanceOpacity;
        `).replace("#include <color_vertex>",`
        #include <color_vertex>
        vInstanceOpacity = instanceOpacity;
        `),e.fragmentShader=e.fragmentShader.replace("#include <color_pars_fragment>",`
        #include <color_pars_fragment>
        varying float vInstanceOpacity;
        `).replace("#include <color_fragment>",`
        #include <color_fragment>
        diffuseColor.a = vInstanceOpacity * opacity;
        `)}}const tl=new d.Ilk,nr=new d.Pa4,rr=new d.Pa4,sl=new d.yGw,vi=new d._fP,zf=de();class Gf extends Mt{constructor(e){super("",e,void 0),this.material=new bi({metalness:0,roughness:1,dithering:!0}),this.maxInstances=16,this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.shaftGeometry=e.sharedGeometry.getGeometry(`${this.constructor.name}-shaft`,Bf).clone(),this.shaftGeometry.setAttribute("instanceOpacity",this.instanceOpacity),this.shaftMesh=new d.SPe(this.shaftGeometry,this.material,this.maxInstances),this.shaftMesh.count=0,this.add(this.shaftMesh),this.headGeometry=e.sharedGeometry.getGeometry(`${this.constructor.name}-head`,jf).clone(),this.headGeometry.setAttribute("instanceOpacity",this.instanceOpacity),this.headMesh=new d.SPe(this.headGeometry,this.material,this.maxInstances),this.headMesh.count=0,this.add(this.headMesh);const t=e.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges`,()=>il(this.shaftGeometry));this.shaftOutlineGeometry=new d.L5s().copy(t),this.shaftOutlineGeometry.setAttribute("instanceMatrix",this.shaftMesh.instanceMatrix),this.shaftOutline=new d.ejS(this.shaftOutlineGeometry,e.instancedOutlineMaterial),this.shaftOutline.frustumCulled=!1,this.shaftOutline.userData.picking=!1,this.add(this.shaftOutline);const i=e.sharedGeometry.getGeometry(`${this.constructor.name}-headedges`,()=>nl(this.headGeometry));this.headOutlineGeometry=new d.L5s().copy(i),this.headOutlineGeometry.setAttribute("instanceMatrix",this.headMesh.instanceMatrix),this.headOutline=new d.ejS(this.headOutlineGeometry,e.instancedOutlineMaterial),this.headOutline.frustumCulled=!1,this.headOutline.userData.picking=!1,this.add(this.headOutline)}_ensureCapacity(e){if(e>this.maxInstances){const t=Math.ceil(e*1.5)+16;this.maxInstances=t,this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.shaftMesh.removeFromParent(),this.shaftMesh.dispose(),this.shaftMesh=new d.SPe(this.shaftGeometry,this.material,this.maxInstances),this.shaftGeometry.setAttribute("instanceOpacity",this.instanceOpacity),this.add(this.shaftMesh),this.headMesh.removeFromParent(),this.headMesh.dispose(),this.headMesh=new d.SPe(this.headGeometry,this.material,this.maxInstances),this.headGeometry.setAttribute("instanceOpacity",this.instanceOpacity),this.add(this.headMesh),this.shaftOutlineGeometry.dispose();const i=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges`,()=>il(this.shaftGeometry));this.shaftOutlineGeometry=new d.L5s().copy(i),this.shaftOutlineGeometry.instanceCount=t,this.shaftOutlineGeometry.setAttribute("instanceMatrix",this.shaftMesh.instanceMatrix),this.shaftOutline.geometry=this.shaftOutlineGeometry,this.headOutlineGeometry.dispose();const n=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-headedges`,()=>nl(this.headGeometry));this.headOutlineGeometry=new d.L5s().copy(n),this.headOutlineGeometry.instanceCount=t,this.headOutlineGeometry.setAttribute("instanceMatrix",this.headMesh.instanceMatrix),this.headOutline.geometry=this.headOutlineGeometry}}_updateMesh(e){let t=!1;this._ensureCapacity(e.length);const i=this.userData.settings.color?$(zf,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.shaftMesh.setColorAt(n,_e(tl,a)),this.headMesh.setColorAt(n,_e(tl,a)),this.instanceOpacity.setX(n,a.a),vi.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),this.shaftMesh.setMatrixAt(n,sl.compose(nr.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),vi,rr.set(r.shaft_length,r.shaft_diameter,r.shaft_diameter))),nr.add(rr.set(r.shaft_length,0,0).applyQuaternion(vi)),this.headMesh.setMatrixAt(n,sl.compose(nr,vi,rr.set(r.head_length,r.head_diameter,r.head_diameter))),n++}this.material.transparent!==t&&(this.material.transparent=t,this.material.depthWrite=!t,this.material.needsUpdate=!0),this.shaftMesh.count===0&&e.length>0&&(this.material.needsUpdate=!0),this.shaftMesh.count=e.length,this.headMesh.count=e.length,this.shaftOutlineGeometry.instanceCount=e.length,this.headOutlineGeometry.instanceCount=e.length,this.shaftMesh.instanceMatrix.needsUpdate=!0,this.headMesh.instanceMatrix.needsUpdate=!0,this.instanceOpacity.needsUpdate=!0,this.shaftMesh.instanceColor&&(this.shaftMesh.instanceColor.needsUpdate=!0),this.headMesh.instanceColor&&(this.headMesh.instanceColor.needsUpdate=!0)}dispose(){this.material.dispose(),this.shaftMesh.dispose(),this.headMesh.dispose(),this.shaftGeometry.dispose(),this.headGeometry.dispose(),this.shaftOutlineGeometry.dispose(),this.headOutlineGeometry.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateMesh(t.arrows),this.headOutline.visible=i.showOutlines??!0,this.shaftOutline.visible=i.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Bf(){const s=new d.fHI(.5,.5,1,16);return s.rotateZ(-Math.PI/2).translate(.5,0,0),s.computeBoundingSphere(),s}function il(s){const e=new d.TOt(s,40);return e.computeBoundingSphere(),e}function jf(){const s=new d.b_z(.5,1,16);return s.rotateZ(-Math.PI/2).translate(.5,0,0),s.computeBoundingSphere(),s}function nl(s){const e=new d.TOt(s,40);return e.computeBoundingSphere(),e}const $f=new d.Ilk,Vf=new d.Pa4,Hf=new d.Pa4,Wf=new d.yGw,Yf=new d._fP,Zf=de();class Kf extends Mt{constructor(e){super("",e),this.material=new bi({metalness:0,roughness:1,dithering:!0}),this.geometry=e.sharedGeometry.getGeometry(`${this.constructor.name}-cube`,Xf).clone(),this.maxInstances=16,this.mesh=new d.SPe(this.geometry,this.material,this.maxInstances),this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.geometry.setAttribute("instanceOpacity",this.instanceOpacity),this.mesh.count=0,this.add(this.mesh),this.sharedEdgesGeometry=e.sharedGeometry.getGeometry(`${this.constructor.name}-edges`,()=>Jf(this.geometry)),this.outlineGeometry=new d.L5s().copy(this.sharedEdgesGeometry),this.outlineGeometry.setAttribute("instanceMatrix",this.mesh.instanceMatrix),this.outline=new d.ejS(this.outlineGeometry,e.instancedOutlineMaterial),this.outline.frustumCulled=!1,this.outline.userData.picking=!1,this.add(this.outline)}_ensureCapacity(e){if(e>this.maxInstances){const t=Math.trunc(e*1.5)+16;this.maxInstances=t,this.mesh.removeFromParent(),this.mesh.dispose(),this.mesh=new d.SPe(this.geometry,this.material,this.maxInstances),this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.geometry.setAttribute("instanceOpacity",this.instanceOpacity),this.add(this.mesh),this.outlineGeometry.dispose(),this.outlineGeometry=new d.L5s().copy(this.sharedEdgesGeometry),this.outlineGeometry.instanceCount=t,this.outlineGeometry.setAttribute("instanceMatrix",this.mesh.instanceMatrix),this.outline.geometry=this.outlineGeometry}}_updateMesh(e){let t=!1;this._ensureCapacity(e.length);const i=this.userData.settings.color?$(Zf,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.mesh.setColorAt(n,_e($f,a)),this.instanceOpacity.setX(n,a.a),this.mesh.setMatrixAt(n,Wf.compose(Vf.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),Yf.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),Hf.set(r.size.x,r.size.y,r.size.z))),n++}this.material.transparent!==t&&(this.material.transparent=t,this.material.depthWrite=!t,this.material.needsUpdate=!0),this.mesh.count===0&&e.length>0&&(this.material.needsUpdate=!0),this.mesh.count=e.length,this.outlineGeometry.instanceCount=e.length,this.mesh.instanceMatrix.needsUpdate=!0,this.instanceOpacity.needsUpdate=!0,this.mesh.instanceColor&&(this.mesh.instanceColor.needsUpdate=!0)}dispose(){this.mesh.dispose(),this.geometry.dispose(),this.material.dispose(),this.outlineGeometry.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateMesh(t.cubes),this.outline.visible=i.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Xf(){const s=new d.DvJ(1,1,1);return s.computeBoundingSphere(),s}function Jf(s){const e=new d.TOt(s,40);return e.computeBoundingSphere(),e}const Qf=new d.Ilk,qf=new d.Pa4,ep=new d.Pa4,tp=new d.yGw,sp=new d._fP,ip=de();class np extends Mt{constructor(e){super("",e),this.outlineMaterial=new lp,this.material=new op,this.pickingMaterial=new cp,this.geometry=e.sharedGeometry.getGeometry(`${this.constructor.name}-cylinder`,rp).clone(),this.maxInstances=16,this.mesh=new d.SPe(this.geometry,this.material,this.maxInstances),this.mesh.userData.pickingMaterial=this.pickingMaterial,this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.instanceBottomScale=new d.lb7(new Float32Array(this.maxInstances),1),this.instanceTopScale=new d.lb7(new Float32Array(this.maxInstances),1),this.geometry.setAttribute("instanceOpacity",this.instanceOpacity),this.geometry.setAttribute("instanceBottomScale",this.instanceBottomScale),this.geometry.setAttribute("instanceTopScale",this.instanceTopScale),this.mesh.count=0,this.add(this.mesh),this.sharedEdgesGeometry=e.sharedGeometry.getGeometry(`${this.constructor.name}-edges`,()=>ap(this.geometry)),this.outlineGeometry=new d.L5s().copy(this.sharedEdgesGeometry),this.outlineGeometry.setAttribute("instanceMatrix",this.mesh.instanceMatrix),this.outlineGeometry.setAttribute("instanceBottomScale",this.instanceBottomScale),this.outlineGeometry.setAttribute("instanceTopScale",this.instanceTopScale),this.outline=new d.ejS(this.outlineGeometry,this.outlineMaterial),this.outline.frustumCulled=!1,this.outline.userData.picking=!1,this.add(this.outline)}setColorScheme(e){this.outlineMaterial.color.copy(e==="dark"?Wi:Hi),this.outlineMaterial.needsUpdate=!0}_ensureCapacity(e){if(e>this.maxInstances){const t=Math.trunc(e*1.5)+16;this.maxInstances=t,this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.instanceBottomScale=new d.lb7(new Float32Array(this.maxInstances),1),this.instanceTopScale=new d.lb7(new Float32Array(this.maxInstances),1),this.geometry.setAttribute("instanceOpacity",this.instanceOpacity),this.geometry.setAttribute("instanceBottomScale",this.instanceBottomScale),this.geometry.setAttribute("instanceTopScale",this.instanceTopScale),this.mesh.removeFromParent(),this.mesh.dispose(),this.mesh=new d.SPe(this.geometry,this.material,this.maxInstances),this.mesh.userData.pickingMaterial=this.pickingMaterial,this.add(this.mesh),this.outlineGeometry.dispose(),this.outlineGeometry=new d.L5s().copy(this.sharedEdgesGeometry),this.outlineGeometry.instanceCount=t,this.outlineGeometry.setAttribute("instanceMatrix",this.mesh.instanceMatrix),this.outlineGeometry.setAttribute("instanceBottomScale",this.instanceBottomScale),this.outlineGeometry.setAttribute("instanceTopScale",this.instanceTopScale),this.outline.geometry=this.outlineGeometry}}_updateMesh(e){let t=!1;this._ensureCapacity(e.length);const i=this.userData.settings.color?$(ip,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.mesh.setColorAt(n,_e(Qf,a)),this.instanceOpacity.setX(n,a.a),this.instanceBottomScale.setX(n,r.bottom_scale),this.instanceTopScale.setX(n,r.top_scale),this.mesh.setMatrixAt(n,tp.compose(qf.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),sp.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),ep.set(r.size.x,r.size.y,r.size.z))),n++}this.material.transparent!==t&&(this.material.transparent=t,this.material.depthWrite=!t,this.material.needsUpdate=!0),this.mesh.count===0&&e.length>0&&(this.material.needsUpdate=!0),this.mesh.count=e.length,this.outlineGeometry.instanceCount=e.length,this.mesh.instanceMatrix.needsUpdate=!0,this.instanceOpacity.needsUpdate=!0,this.instanceBottomScale.needsUpdate=!0,this.instanceTopScale.needsUpdate=!0,this.mesh.instanceColor&&(this.mesh.instanceColor.needsUpdate=!0)}dispose(){this.mesh.dispose(),this.geometry.dispose(),this.material.dispose(),this.pickingMaterial.dispose(),this.outlineMaterial.dispose(),this.outlineGeometry.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateMesh(t.cylinders),this.outline.visible=i.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function rp(){const s=new d.fHI(.5,.5,1,16);return s.rotateX(Math.PI/2),s.computeBoundingSphere(),s}function ap(s){const e=new d.TOt(s,40);return e.computeBoundingSphere(),e}function ar(s){return s.replace("#include <color_pars_vertex>",`
  #include <color_pars_vertex>
  attribute float instanceBottomScale, instanceTopScale;
  `).replace("#include <begin_vertex>",`
  #include <begin_vertex>
  transformed.xy *= mix(instanceBottomScale, instanceTopScale, transformed.z + 0.5);
  `)}class op extends bi{constructor(){super({metalness:0,roughness:1,dithering:!0})}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=ar(e.vertexShader)}}class lp extends d.nls{constructor(){super(),this.defines??(this.defines={}),this.defines.USE_INSTANCING=!0}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=ar(e.vertexShader)}}class cp extends d.jyz{constructor(){super({vertexShader:ar(d.WdD.meshbasic_vert),fragmentShader:`
          uniform vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}})}}const dp=de();class hp extends Mt{constructor(e){super("",e),this._lines=[]}_updateLines(e){this.clear(),this._lines.length=0;for(const t of e){if(t.points.length===0)continue;const i=this._makeLine(t),n=new d.ZAu().add(i);n.position.set(t.pose.position.x,t.pose.position.y,t.pose.position.z),n.quaternion.set(t.pose.orientation.x,t.pose.orientation.y,t.pose.orientation.z,t.pose.orientation.w),this.add(n),this._lines.push(i)}}_makeLine(e){let t;const i=e.type===L.LineType.LINE_LIST,n=e.type===L.LineType.LINE_LOOP,r=!0,a=new Cn({worldUnits:!e.scale_invariant,linewidth:e.thickness,transparent:r,depthWrite:!r,resolution:this.renderer.input.canvasSize});a.lineWidth=e.thickness;const o=new d.jyz({vertexShader:a.vertexShader,fragmentShader:`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `,clipping:!0,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]},linewidth:{value:e.thickness},resolution:{value:this.renderer.input.canvasSize},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},defines:e.scale_invariant?{}:{WORLD_UNITS:""}});let l;switch(e.type){case L.LineType.LINE_STRIP:case L.LineType.LINE_LOOP:{const f=new ii.L;t=f,l=new si.w(f,a);break}case L.LineType.LINE_LIST:{t=new xn.z,l=new _n.w(t,a);break}}const c=up(e);t.setPositions(c);const h=this.userData.settings.color?$(dp,this.userData.settings.color):e.colors.length===0?e.color:void 0;if(h==null){a.vertexColors=!0,a.opacity=1,a.uniforms.opacity.value=1;const f=fp(e),u=new d.$TI(f,i?8:4,1);t.setAttribute("instanceColorStart",new d.kB5(u,4,0)),t.setAttribute("instanceColorEnd",new d.kB5(u,4,4))}else a.vertexColors=!1,a.color=_e(new d.Ilk,h),a.uniforms.opacity.value=h.a;return t.instanceCount=i?e.points.length>>>1:n?e.points.length:Math.max(e.points.length-1,0),l.userData.pickingMaterial=o,l}dispose(){for(const e of this._lines)e.geometry.dispose(),e.material.dispose(),e.userData.pickingMaterial.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateLines(t.lines)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function up(s){const e=s.type===L.LineType.LINE_LOOP;let t;const i=s.indices;if(i.length>0){t=new Float32Array((i.length+(e?1:0))*3);let n=0;for(const r of i){const{x:a,y:o,z:l}=s.points[r];t[n++]=a,t[n++]=o,t[n++]=l}}else{t=new Float32Array((s.points.length+(e?1:0))*3);let n=0;for(const{x:r,y:a,z:o}of s.points)t[n++]=r,t[n++]=a,t[n++]=o}return e&&t.length>3&&(t[t.length-3]=t[0],t[t.length-2]=t[1],t[t.length-1]=t[2]),t}function fp(s){const e=s.type===L.LineType.LINE_LOOP;let t;const i=s.indices;if(i.length>0)if(t=new Float32Array((i.length+(e?1:0))*4),s.colors.length>0){let n=0;for(const r of i){const{r:a,g:o,b:l,a:c}=s.colors[r];t[n++]=te(a),t[n++]=te(o),t[n++]=te(l),t[n++]=c}}else throw new Error("invariant: expected not to be using vertex colors");else if(t=new Float32Array((s.points.length+(e?1:0))*4),s.colors.length>0){let n=0;for(const{r,g:a,b:o,a:l}of s.colors)t[n++]=te(r),t[n++]=te(a),t[n++]=te(o),t[n++]=l}else throw new Error("invariant: expected not to be using vertex colors");return e&&t.length>4&&(t[t.length-4]=t[0],t[t.length-3]=t[1],t[t.length-2]=t[2],t[t.length-1]=t[3]),t}var pp=v(41613);function rl(s){s instanceof d.Wid&&(s.map?.dispose(),s.lightMap?.dispose(),s.aoMap?.dispose(),s.emissiveMap?.dispose(),s.bumpMap?.dispose(),s.normalMap?.dispose(),s.displacementMap?.dispose(),s.roughnessMap?.dispose(),s.metalnessMap?.dispose(),s.alphaMap?.dispose(),s.envMap?.dispose()),s.dispose()}function Ms(s){s.traverse(e=>{if(e instanceof d.Kj0)if(e.geometry.dispose(),Array.isArray(e.material))for(const t of e.material)t instanceof d.F5T&&rl(t);else e.material instanceof d.F5T&&rl(e.material)})}function al(s){const e=[];s.traverse(t=>{const i=t;i.isLight===!0&&e.push(i)});for(const t of e)t.dispose(),t.removeFromParent()}function ol(s,e){s.traverse(t=>{if(!(t instanceof d.Kj0))return;const i=t;if(Array.isArray(i.material))for(const n of i.material)ll(n);else ll(i.material);i.material=e,i.geometry.attributes.normal||i.geometry.computeVertexNormals()})}function ll(s){s.map?.dispose(),s.lightMap?.dispose(),s.aoMap?.dispose(),s.emissiveMap?.dispose(),s.bumpMap?.dispose(),s.normalMap?.dispose(),s.displacementMap?.dispose(),s.roughnessMap?.dispose(),s.metalnessMap?.dispose(),s.alphaMap?.dispose(),s.envMap?.dispose(),s.dispose()}const mp=de(),ts="MODEL_FETCH_FAILED";function gp(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}class yp extends Mt{constructor(e){super("",e),this.renderablesByDataCrc=new Map,this.renderablesByUrl=new Map,this.updateCount=0}async _createOrUpdateRenderable(e,t,i,n,r){let a;if(t){const l=t.findIndex(c=>i(c.primitive,e));l>=0&&(a=t.splice(l,1)[0])}if(a)return this._updateModel(a,e),a;const o=n(e);try{const l=await this._loadCachedModel(o,{overrideMediaType:e.media_type.length>0?e.media_type:void 0});l&&(a={model:cl(l),cachedModel:l,primitive:e},this._updateModel(a,e))}finally{r(o)}return a}_updateModels(e){this.clear();const t=++this.updateCount,i=this.renderablesByUrl;this.renderablesByUrl=new Map;const n=this.renderablesByDataCrc;this.renderablesByDataCrc=new Map,Promise.all(e.map(async r=>{let a,o,l;if(r.url.length===0){const c=(0,pp.kn)(r.data);a=n.get(c),o=this.renderablesByDataCrc.get(c),o||(o=[],this.renderablesByDataCrc.set(c,o));try{l=await this._createOrUpdateRenderable(r,a,(h,f)=>h.media_type===f.media_type&&gp(h.data,f.data),h=>URL.createObjectURL(new Blob([h.data],{type:h.media_type})),h=>URL.revokeObjectURL(h))}catch(h){this.renderer.settings.errors.add(this.userData.settingsPath,ts,`Unhandled error loading model from ${r.data.byteLength}-byte data: ${h.message}`)}}else{a=i.get(r.url),o=this.renderablesByUrl.get(r.url),o||(o=[],this.renderablesByUrl.set(r.url,o));try{l=await this._createOrUpdateRenderable(r,a,(c,h)=>c.url===h.url&&c.media_type===h.media_type,c=>c.url,c=>{})}catch(c){this.renderer.settings.errors.add(this.userData.settingsPath,ts,`Unhandled error loading model from "${r.url}": ${c.message}`)}}t===this.updateCount&&l&&(o.push(l),this.add(l.model),this.renderer.queueAnimationFrame())})).then(()=>{this.renderer.settings.errors.remove(this.userData.settingsPath,ts)}).catch(console.error).finally(()=>{for(const r of i.values())for(const a of r)a.model.removeFromParent(),this._disposeModel(a);for(const r of n.values())for(const a of r)a.model.removeFromParent(),this._disposeModel(a);this.updateOutlineVisibility(),this.renderer.queueAnimationFrame()})}dispose(){for(const e of this.renderablesByUrl.values())for(const t of e)this._disposeModel(t);this.renderablesByUrl.clear();for(const e of this.renderablesByDataCrc.values())for(const t of e)this._disposeModel(t);this.renderablesByDataCrc.clear()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateModels(t.models)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}updateOutlineVisibility(){const e=this.getSettings()?.showOutlines??!0;this.traverse(t=>{t instanceof d.ejS&&t.name===vn&&(t.visible=e)})}async _loadCachedModel(e,t){const i=await this.renderer.modelCache.load(e,{overrideMediaType:t.overrideMediaType},n=>{this.renderer.settings.errors.add(this.userData.settingsPath,ts,`Error loading model from "${e}": ${n.message}`)});if(!i){this.renderer.settings.errors.hasError(this.userData.settingsPath,ts)||this.renderer.settings.errors.add(this.userData.settingsPath,ts,`Failed to load model from "${e}"`);return}return i}_updateModel(e,t){const i=this.userData.settings.color?$(mp,this.userData.settings.color):t.override_color?t.color:void 0;if(i){e.material||(e.material=new d.Wid({metalness:0,roughness:1,dithering:!0}),ol(e.model,e.material)),_e(e.material.color,i);const n=i.a<1;e.material.opacity=i.a,e.material.transparent=n,e.material.depthWrite=!n,e.material.needsUpdate=!0}else e.material&&(e.model=cl(e.cachedModel),e.material=void 0);e.model.scale.set(t.scale.x,t.scale.y,t.scale.z),e.model.position.set(t.pose.position.x,t.pose.position.y,t.pose.position.z),e.model.quaternion.set(t.pose.orientation.x,t.pose.orientation.y,t.pose.orientation.z,t.pose.orientation.w)}_disposeModel(e){e.material?.dispose(),Ms(e.model),Ms(e.cachedModel)}}function cl(s){const e=s.clone(!0);return al(e),new d.ZAu().add(e)}const bp=new d.Ilk,vp=new d.Pa4,Tp=new d.Pa4,Sp=new d.yGw,_p=new d._fP,xp=de();class Cp extends Mt{constructor(e){super("",e),this.material=new bi({metalness:0,roughness:1,dithering:!0}),this.geometry=e.sharedGeometry.getGeometry(this.constructor.name,wp).clone(),this.maxInstances=16,this.mesh=new d.SPe(this.geometry,this.material,this.maxInstances),this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.geometry.setAttribute("instanceOpacity",this.instanceOpacity),this.mesh.count=0,this.add(this.mesh)}_ensureCapacity(e){if(e>this.maxInstances){const t=Math.trunc(e*1.5)+16;this.maxInstances=t,this.mesh.removeFromParent(),this.mesh.dispose(),this.mesh=new d.SPe(this.mesh.geometry,this.material,this.maxInstances),this.instanceOpacity=new d.lb7(new Float32Array(this.maxInstances),1),this.geometry.setAttribute("instanceOpacity",this.instanceOpacity),this.add(this.mesh)}}_updateMesh(e){let t=!1;this._ensureCapacity(e.length);const i=this.userData.settings.color?$(xp,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=i??r.color;a.a<1&&(t=!0),this.mesh.setColorAt(n,_e(bp,a)),this.instanceOpacity.setX(n,a.a),this.mesh.setMatrixAt(n,Sp.compose(vp.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),_p.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),Tp.set(r.size.x,r.size.y,r.size.z))),n++}this.material.transparent!==t&&(this.material.transparent=t,this.material.depthWrite=!t,this.material.needsUpdate=!0),this.mesh.count===0&&e.length>0&&(this.material.needsUpdate=!0),this.mesh.count=e.length,this.mesh.instanceMatrix.needsUpdate=!0,this.instanceOpacity.needsUpdate=!0,this.mesh.instanceColor&&(this.mesh.instanceColor.needsUpdate=!0)}dispose(){this.mesh.dispose(),this.geometry.dispose(),this.material.dispose()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateMesh(t.spheres)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function wp(){const s=new d.xo$(.5,16,16);return s.computeBoundingSphere(),s}const Ip=de();class Dp extends Mt{constructor(e){super("",e),this.labels=[],this.labelPool=e.labelPool}_ensureCapacity(e){const t=this.labels.length;if(e>t)for(let i=t;i<e;i++){const n=this.labelPool.acquire();this.labels.push(n),this.add(n)}}_updateTexts(e){this._ensureCapacity(e.length);const t=this.userData.settings.color?$(Ip,this.userData.settings.color):void 0;let i=0;for(const n of e){const r=t??n.color,a=this.labels[i];if(!a)throw new Error("invariant: labels array smaller than requested");a.setText(n.text),a.setColor(te(r.r),te(r.g),te(r.b)),Zi(r.r,r.g,r.b)<.5?a.setBackgroundColor(1,1,1):a.setBackgroundColor(0,0,0),a.setOpacity(r.a),a.setLineHeight(n.font_size),a.setBillboard(n.billboard),a.setSizeAttenuation(!n.scale_invariant),a.quaternion.set(n.pose.orientation.x,n.pose.orientation.y,n.pose.orientation.z,n.pose.orientation.w),a.position.set(n.pose.position.x,n.pose.position.y,n.pose.position.z),i++}if(i<this.labels.length)for(const n of this.labels.splice(i))this.labelPool.release(n)}dispose(){for(const e of this.labels)this.labelPool.release(e)}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateTexts(t.texts)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}const Mp=de(),dl=new d.Ilk,hl={r:0,g:1,b:0,a:1},Ep="INVALID_COLOR_LENGTH",Ap="INVALID_POINT";class Pp extends Mt{constructor(e){super("",e),this._triangleMeshes=[]}_ensureCapacity(e){for(;e>this._triangleMeshes.length;)this._triangleMeshes.push(Lp())}_updateTriangleMeshes(e){this._ensureCapacity(e.length),this.clear();let t=0;for(const i of e){const n=this._triangleMeshes[t];if(!n)continue;const{geometry:r,material:a}=n;let o=!1,l=!1,c=!1;r.resize(i.points.length),r.attributes.position||r.createAttribute("position",Float32Array,3),r.attributes.normal||r.createAttribute("normal",Float32Array,3);const h=r.attributes.position,f=this.userData.settings.color?$(Mp,this.userData.settings.color):i.colors.length===0?i.color:void 0;!f&&!r.attributes.color&&r.createAttribute("color",Uint8Array,4,!0);const u=r.attributes.color;for(let g=0;g<i.points.length;g++){const b=i.points[g];if(!Rp(b)){this.addError(`${this.name}-${Ap}`,`Entity: ${this.userData.entity?.id}.triangles[${t}](1st index) - Point definition at index ${g} is not finite`);continue}if(l=l||h.getX(g)!==b.x||h.getY(g)!==b.y||h.getZ(g)!==b.z,h.setXYZ(g,b.x,b.y,b.z),!f&&u&&i.colors.length>0){const T=i.colors[g]??hl;g===i.points.length-1&&T===hl&&this.addError(`${this.name}-${Ep}`,`Entity: ${this.userData.entity?.id}.triangles[${t}](1st index) - Colors array should be same size as points array, showing #00ff00 instead`);const _=te(T.r),R=te(T.g),N=te(T.b),P=T.a;c=c||u.getX(g)!==_||u.getY(g)!==R||u.getZ(g)!==N||u.getW(g)!==P,u.setXYZW(g,_,R,N,P),!o&&P<1&&(o=!0)}}if(l&&(r.computeVertexNormals(),r.computeBoundingSphere(),r.attributes.position.needsUpdate=!0),c=!a.vertexColors&&!f&&i.colors.length>0,c)a.vertexColors=!0,a.color.set("#ffffff"),a.opacity=1,r.attributes.color.needsUpdate=!0,a.needsUpdate=!0;else if(f){o=f.a<1;const g=_e(dl,f);(a.vertexColors||!a.color.equals(g)||n.material.opacity!==f.a)&&(a.vertexColors=!1,a.color.copy(dl),n.material.opacity=f.a,a.needsUpdate=!0)}a.transparent!==o&&(a.transparent=o,a.depthWrite=!o,a.needsUpdate=!0);const p=i.indices;if(p.length>0){if(!r.index||r.index.count<p.length){const g=new Uint32Array(Math.round(p.length*1.5)+16);g.set(p),r.index=new d.TlE(g,1),r.index.count=p.length}else{const g=r.index.array;let b=!1;for(let T=0;T<p.length;T++)g[T]!==p[T]&&(g[T]=p[T],b=!0);r.index.needsUpdate=b}r.setDrawRange(0,p.length)}else r.index=null;n.position.set(i.pose.position.x,i.pose.position.y,i.pose.position.z),n.quaternion.set(i.pose.orientation.x,i.pose.orientation.y,i.pose.orientation.z,i.pose.orientation.w),this.add(n),t++}}dispose(){for(const e of this._triangleMeshes)e.geometry.dispose(),e.material.dispose();this.clear(),this._triangleMeshes.length=0,this.clearErrors()}update(e,t,i,n){if(super.update(e,t,i,n),t){const r=(0,m.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this._updateTriangleMeshes(t.triangles)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Lp(){return new d.Kj0(new Ss,new d.Wid({metalness:0,roughness:1,flatShading:!0,side:d.ehD}))}function Rp(s){return Number.isFinite(s.x)&&Number.isFinite(s.y)&&Number.isFinite(s.z)}const Np={[q.CUBES]:Kf,[q.MODELS]:yp,[q.LINES]:hp,[q.CYLINDERS]:np,[q.ARROWS]:Gf,[q.SPHERES]:Cp,[q.TEXTS]:Dp,[q.TRIANGLES]:Pp};class Op{constructor(e){this.renderer=e,this.primitivesByType=new Map,this.disposed=!1}acquire(e){if(this.disposed)throw new Error(`Attempt to acquire PrimitiveType.${e} after PrimitivePool was disposed`);const t=this.primitivesByType.get(e)?.pop();return t?(t.prepareForReuse(),t):new Np[e](this.renderer)}release(e,t){if(this.disposed){t.dispose();return}const i=this.primitivesByType.get(e);i?i.push(t):this.primitivesByType.set(e,[t])}dispose(){for(const e of this.primitivesByType.values())for(const t of e)t.dispose();this.primitivesByType.clear(),this.disposed=!0}setColorScheme(e){for(const t of this.primitivesByType.values())for(const i of t)i.setColorScheme(e)}}const Ti={showOutlines:!0,visible:!1,color:void 0,selectedIdVariable:void 0};class Fp extends ie{constructor(e){super("foxglove.SceneEntities",e),this.primitivePool=new Op(this.renderer),this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n];r.userData.settings={...Ti,...a},r.updateSettings()}},this.handleSceneUpdate=t=>{const i=t.topic,n=t.message;for(const r of n.deletions??[])if(r){const a=kp(r);this._getTopicEntities(i).deleteEntities(a)}for(const r of n.entities??[])if(r){const a=Up(r);this._getTopicEntities(i).addOrUpdateEntity(a,(0,m.toNanoSec)(t.receiveTime))}},e.addSchemaSubscriptions(Ui,this.handleSceneUpdate)}settingsNodes(){const e=this.renderer.config.topics,t=[];for(const i of this.renderer.topics??[]){if(!Y(i,Ui))continue;const n=e[i.name]??{},r={label:i.name,icon:"Shapes",order:i.name.toLocaleLowerCase(),fields:{color:{label:"Color",input:"rgba",value:n.color},showOutlines:{label:"Show outlines",input:"boolean",value:n.showOutlines??Ti.showOutlines},selectedIdVariable:{label:"Selection Variable",input:"string",help:"When selecting a SceneEntity, this global variable will be set to the entity ID",value:n.selectedIdVariable,placeholder:Oi}},visible:n.visible??Ti.visible,handler:this.handleSettingsAction};t.push({path:["topics",i.name],node:r})}return t}startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i)}setColorScheme(e,t){for(const i of this.renderables.values())i.setColorScheme(e)}_getTopicEntities(e){let t=this.renderables.get(e);if(!t){const i=this.renderer.config.topics[e];t=new Uf(e,this.primitivePool,this.renderer,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:Q(),settingsPath:["topics",e],topic:e,settings:{...Ti,...i}}),this.renderables.set(e,t),this.add(t)}return t}dispose(){super.dispose(),this.primitivePool.dispose()}}function Up(s){return{timestamp:ge(s.timestamp),frame_id:s.frame_id??"",id:s.id??"",lifetime:ge(s.lifetime),frame_locked:s.frame_locked??!1,metadata:s.metadata?.map(e=>({key:e?.key??"",value:e?.value??""}))??[],arrows:s.arrows?.map(zp)??[],cubes:s.cubes?.map(Gp)??[],spheres:s.spheres?.map(Bp)??[],cylinders:s.cylinders?.map(jp)??[],lines:s.lines?.map($p)??[],triangles:s.triangles?.map(Vp)??[],texts:s.texts?.map(Hp)??[],models:s.models?.map(Wp)??[]}}function kp(s){return{timestamp:ge(s.timestamp),type:s.type??L.SceneEntityDeletionType.MATCHING_ID,id:s.id??""}}function zp(s){return{pose:oe(s?.pose),shaft_length:s?.shaft_length??.8,shaft_diameter:s?.shaft_diameter??.1,head_length:s?.head_length??.2,head_diameter:s?.head_diameter??.2,color:st(s?.color)}}function Gp(s){return{pose:oe(s?.pose),size:We(s?.size),color:st(s?.color)}}function Bp(s){return{pose:oe(s?.pose),size:We(s?.size),color:st(s?.color)}}function jp(s){return{pose:oe(s?.pose),size:We(s?.size),bottom_scale:s?.bottom_scale??1,top_scale:s?.top_scale??1,color:st(s?.color)}}function $p(s){return{type:s?.type??L.LineType.LINE_STRIP,pose:oe(s?.pose),thickness:s?.thickness??.05,scale_invariant:s?.scale_invariant??!1,points:s?.points?.map(We)??[],color:st(s?.color),colors:mn(s?.colors),indices:s?.indices?.map(e=>e??NaN)??[]}}function Vp(s){return{pose:oe(s?.pose),points:s?.points?.map(We)??[],color:st(s?.color),colors:mn(s?.colors),indices:s?.indices?.map(e=>e??NaN)??[]}}function Hp(s){return{pose:oe(s?.pose),billboard:s?.billboard??!0,font_size:s?.font_size??(s?.scale_invariant??!1?16:.25),scale_invariant:s?.scale_invariant??!1,color:st(s?.color),text:s?.text??""}}function Wp(s){return{pose:oe(s?.pose),scale:We(s?.scale),color:st(s?.color),override_color:s?.override_color??!1,url:s?.url??"",media_type:s?.media_type??"",data:Yt(s?.data)}}var Yp=v(87373);const Zp=["fixed","continuous","revolute","planar","prismatic","floating"];function Kp(s){const e=new DOMParser,t=s instanceof XMLDocument?s:e.parseFromString(s,"text/xml");for(let i=0;i<t.children.length;i++){const n=t.children[i];if(n.nodeName==="robot")return Xp(n)}throw new Error("No robot found in URDF")}function Xp(s){const e=s.getAttribute("name")??void 0;if(e==null)throw new Error("<robot> name is missing");const t=new Map,i=new Map,n=new Map;for(let r=0;r<s.children.length;r++){const a=s.children[r],o=a.getAttribute("name");if(o!=null)switch(a.nodeName){case"link":t.set(o,Jp(a));break;case"joint":i.set(o,qp(a));break;case"material":n.set(o,ul(a));break}}return{name:e,links:t,joints:i,materials:n}}function Jp(s){const e=s.getAttribute("name")??void 0;if(e==null)throw new Error(`missing attribute "name" in ${s}`);const t={name:e,visuals:[],colliders:[]};for(let i=0;i<s.children.length;i++){const n=s.children[i];switch(n.nodeName){case"inertial":t.inertial=Qp(n);break;case"visual":t.visuals.push(em(n));break;case"collision":t.colliders.push(tm(n));break}}return t}function Qp(s){let e,t,i;for(let n=0;n<s.children.length;n++){const r=s.children[n];switch(r.nodeName){case"origin":e=Si(r);break;case"mass":t=nm(r);break;case"inertia":i=sm(r);break}}if(t==null||i==null)throw new Error("<inertial> must have mass and inertia");return{origin:e??_i(),mass:t,inertia:i}}function qp(s){const e=s.getAttribute("name")??void 0,t=s.getAttribute("type")??void 0;let i,n,r,a,o,l,c,h,f;if(e==null)throw new Error(`missing attribute "name" in ${s}`);if(!Zp.includes(t??""))throw new Error(`invalid joint type "${t}" in ${s}`);for(let u=0;u<s.children.length;u++){const p=s.children[u];switch(p.nodeName){case"origin":i=Si(p);break;case"parent":n=p.getAttribute("link")??void 0;break;case"child":r=p.getAttribute("link")??void 0;break;case"axis":if(a=Es(p,"xyz"),a==null)throw new Error(`missing attribute "xyz" in ${p}`);break;case"calibration":o={rising:Ze(p,"rising"),falling:Ze(p,"falling")};break;case"dynamics":l={damping:Ze(p,"damping")??0,friction:Ze(p,"friction")??0};break;case"limit":c={lower:Ze(p,"lower")??0,upper:Ze(p,"upper")??0,effort:ze(p,"effort"),velocity:ze(p,"velocity")};break;case"mimic":{const g=p.getAttribute("joint")??void 0;if(g==null)throw new Error(`missing attribute "joint" in ${p}`);h={joint:g,multiplier:Ze(p,"multiplier")??1,offset:Ze(p,"offset")??0};break}case"safety_controller":f={softLowerLimit:Ze(p,"soft_lower_limit")??0,softUpperLimit:Ze(p,"soft_upper_limit")??0,kPosition:Ze(p,"k_position")??0,kVelocity:ze(p,"k_velocity")};break}}if(n==null||r==null)throw new Error(`missing parent or child in ${s}`);return{name:e,jointType:t,origin:i??_i(),parent:n,child:r,axis:a??{x:1,y:0,z:0},calibration:o,dynamics:l,limit:c,mimic:h,safetyController:f}}function em(s){const e=s.getAttribute("name")??void 0;let t,i,n;for(let r=0;r<s.children.length;r++){const a=s.children[r];switch(a.nodeName){case"origin":t=Si(a);break;case"geometry":i=fl(a);break;case"material":n=ul(a);break}}if(i==null)throw new Error("<visual> must have geometry");return{name:e,origin:t??_i(),geometry:i,material:n}}function tm(s){const e=s.getAttribute("name")??void 0;let t,i;for(let n=0;n<s.children.length;n++){const r=s.children[n];switch(r.nodeName){case"origin":t=Si(r);break;case"geometry":i=fl(r);break}}if(i==null)throw new Error("<collision> must have geometry");return{name:e,origin:t??_i(),geometry:i}}function ul(s){const e=s.getAttribute("name")??void 0;let t,i;for(let n=0;n<s.children.length;n++){const r=s.children[n];switch(r.nodeName){case"color":t=im(r,"rgba");break;case"texture":i=r.getAttribute("filename")??void 0;break}}return{name:e,color:t,texture:i}}function sm(s){const e=ze(s,"ixx"),t=ze(s,"ixy"),i=ze(s,"ixz"),n=ze(s,"iyy"),r=ze(s,"iyz"),a=ze(s,"izz");return{ixx:e,ixy:t,ixz:i,iyy:n,iyz:r,izz:a}}function fl(s){if(s.children.length<1)throw new Error("<geometry> must contain box, cylinder, sphere, or mesh");const e=s.children[0];switch(e.nodeName){case"box":{const t=Es(e,"size");if(t==null)throw new Error(`missing attribute "size" in ${s}`);return{geometryType:"box",size:t}}case"cylinder":{const t=ze(e,"length"),i=ze(e,"radius");return{geometryType:"cylinder",length:t,radius:i}}case"sphere":return{geometryType:"sphere",radius:ze(e,"radius")};case"mesh":{const t=e.getAttribute("filename")??void 0,i=Es(e,"scale");if(t==null)throw new Error(`missing attribute "filename" in ${s}`);return{geometryType:"mesh",filename:t,scale:i}}default:throw new Error("<geometry> must contain box, cylinder, sphere, or mesh")}}function Si(s){const e=Es(s,"xyz")??{x:0,y:0,z:0},t=Es(s,"rpy")??{x:0,y:0,z:0};return{xyz:e,rpy:t}}function Es(s,e){const t=s.getAttribute(e)?.trim().split(/\s+/);if(t?.length!==3)return;const[i,n,r]=t;return{x:parseFloat(i),y:parseFloat(n),z:parseFloat(r)}}function im(s,e){const t=s.getAttribute(e)?.trim().split(/\s+/);if(t?.length!==4)return;const[i,n,r,a]=t;return{r:parseFloat(i),g:parseFloat(n),b:parseFloat(r),a:parseFloat(a)}}function ze(s,e){const t=s.getAttribute(e);if(t==null)throw new Error(`missing attribute "${e}" in ${s}`);return parseFloat(t)}function Ze(s,e){const t=s.getAttribute(e);if(t!=null)return parseFloat(t)}function nm(s){if(s.textContent==null)throw new Error(`expected float value in "${s}"`);return parseFloat(s.textContent)}function _i(){return{xyz:{x:0,y:0,z:0},rpy:{x:0,y:0,z:0}}}async function rm(s,e){const t=new Yp.$;t.rospackCommands={find:n=>`package://${n}`},t.getFileContents=e;const i=await t.parse(s);return Kp(i)}function pl(s){const e=s.x,t=s.y,i=s.z,n=Math.cos(i*.5),r=Math.sin(i*.5),a=Math.cos(e*.5),o=Math.sin(e*.5),l=Math.cos(t*.5),c=Math.sin(t*.5),h=n*a*l+r*o*c,f=n*o*l-r*a*c,u=n*a*c+r*o*l,p=r*a*l-n*o*c;return{x:f,y:u,z:p,w:h}}function am(s,e,t){const i=Array(36).fill(0);return i[6*0+0]=Math.pow(s,2),i[6*1+1]=Math.pow(e,2),i[6*5+5]=Math.pow(t,2),i}var om=v(61969);class ml extends Ue{constructor(e,t,i,n){super(e,t,i,n);const r=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-cube`,gl),a=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-cube-edges`,()=>lm(r));this.mesh=new d.Kj0(r,Xt(t.color)),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh),this.outline=new d.ejS(a,n.outlineMaterial),this.outline.userData.picking=!1,this.mesh.add(this.outline),this.update(t,i)}dispose(){this.mesh.material.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.mesh.material.transparent&&(this.mesh.material.transparent=n,this.mesh.material.depthWrite=!n,this.mesh.material.needsUpdate=!0),this.outline.visible=this.getSettings()?.showOutlines??!0,_e(this.mesh.material.color,i.color),this.mesh.material.opacity=i.color.a,this.scale.set(i.scale.x,i.scale.y,i.scale.z)}}function gl(){const s=new d.DvJ(1,1,1);return s.computeBoundingSphere(),s}function lm(s){const e=new d.TOt(s,40);return e.computeBoundingSphere(),e}class yl extends Ue{constructor(e,t,i,n){super(e,t,i,n);const r=Xt(t.color),a=n.sharedGeometry.getGeometry(`${this.constructor.name}-cylinder-${n.maxLod}`,()=>cm(n.maxLod));this.mesh=new d.Kj0(a,r),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh);const o=n.sharedGeometry.getGeometry(`${this.constructor.name}-edges-${n.maxLod}`,()=>dm(a));this.outline=new d.ejS(o,n.outlineMaterial),this.outline.userData.picking=!1,this.mesh.add(this.outline),this.update(t,i)}dispose(){this.mesh.material.dispose()}update(e,t){super.update(e,t);const i=this.userData.marker,n=i.color.a<1;n!==this.mesh.material.transparent&&(this.mesh.material.transparent=n,this.mesh.material.depthWrite=!n,this.mesh.material.needsUpdate=!0),this.outline.visible=this.getSettings()?.showOutlines??!0,_e(this.mesh.material.color,i.color),this.mesh.material.opacity=i.color.a,this.scale.set(i.scale.x,i.scale.y,i.scale.z)}}function cm(s){const e=Fd(s),t=new d.fHI(.5,.5,1,e);return t.rotateX(Math.PI/2),t.computeBoundingSphere(),t}function dm(s){const e=new d.TOt(s,40);return e.computeBoundingSphere(),e}const As="MESH_FETCH_FAILED";class bl extends Ue{constructor(e,t,i,n){super(e,t,i,n),this.updateId=0,this.material=Xt(t.color),this.update(t,i,!0)}dispose(){this.mesh&&Ms(this.mesh),this.material.dispose()}update(e,t,i){const n=this.userData.marker;super.update(e,t);const r=this.userData.marker,a=r.color.a<1;if(a!==this.material.transparent&&(this.material.transparent=a,this.material.depthWrite=!a,this.material.needsUpdate=!0),_e(this.material.color,r.color),this.material.opacity=r.color.a,i===!0||r.mesh_resource!==n.mesh_resource){const o=++this.updateId,l={useEmbeddedMaterials:r.mesh_use_embedded_materials},c=this.renderer.settings.errors;this.mesh&&(this.remove(this.mesh),Ms(this.mesh),this.mesh=void 0),this._loadModel(r.mesh_resource,l).then(h=>{if(h){if(this.updateId!==o){Ms(h);return}this.mesh=h,this.add(h),this.updateOutlineVisibility(),this.renderer.settings.errors.remove(this.userData.settingsPath,As),this.renderer.queueAnimationFrame()}}).catch(h=>{c.add(this.userData.settingsPath,As,`Unhandled error loading mesh from "${r.mesh_resource}": ${h.message}`)})}this.updateOutlineVisibility(),this.scale.set(r.scale.x,r.scale.y,r.scale.z)}updateOutlineVisibility(){const e=this.getSettings()?.showOutlines??!0;this.traverse(t=>{t instanceof d.ejS&&t.name===vn&&(t.visible=e)})}async _loadModel(e,t){const i=await this.renderer.modelCache.load(e,{},r=>{this.renderer.settings.errors.add(this.userData.settingsPath,As,`Error loading mesh from "${e}": ${r.message}`)});if(!i){this.renderer.settings.errors.hasError(this.userData.settingsPath,As)||this.renderer.settings.errors.add(this.userData.settingsPath,As,`Failed to load mesh from "${e}"`);return}const n=i.clone(!0);return al(n),t.useEmbeddedMaterials||ol(n,this.material),n}}var hm="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Urdfs.ts";const ss=x.ZP.getLogger(hm),Ps="foxglove.Urdf",nt="/robot_description",Et="param:/robot_description",or="/robot_description",um="/robot_description (parameter)",vl="ValidUrl",Tl="FetchUrdf",fm="ParseUrdf",xi=Math.PI/180,Ge=180/Math.PI,lr={r:1,g:1,b:1,a:1},pm={x:1,y:1,z:1},Sl=["X","Y","Z"],mm=["R","P","Y"],cr={visible:!1,frameLocked:!0,instanceId:"invalid"},dr={visible:!0,frameLocked:!0,label:"URDF",instanceId:"invalid",layerId:Ps,url:""},Ci=new d.Pa4,_l=new d.Pa4,xl=new d._fP,gm=new d._fP,hr=new d.USm;var Ls;(function(s){s[s.Use=0]="Use",s[s.Ignore=1]="Ignore"})(Ls||(Ls={}));const ur=(0,om.Z)();class ym extends fe{dispose(){this.removeChildren(),this.userData.urdf=void 0,super.dispose()}removeChildren(){for(const e of this.userData.renderables.values())e.dispose();this.children.length=0,this.userData.renderables.clear()}}class bm extends ie{constructor(e){super("foxglove.Urdfs",e),this.framesByInstanceId=new Map,this.transformsByInstanceId=new Map,this.jointStates=new Map,this.handleTopicSettingsAction=t=>{if(t.action==="update"){this.handleSettingsUpdate(t);return}},this.handleLayerSettingsAction=t=>{const i=t.payload.path;if(t.action==="perform-node-action"){if(i.length===2&&t.payload.id==="delete"){const n=i[1];this.renderer.updateConfig(o=>{delete o.layers[n]});const r=this.renderables.get(n);r&&(r.dispose(),this.remove(r),this.renderables.delete(n));const a=this.transformsByInstanceId.get(n);if(a)for(const{parent:o,child:l}of a)this.renderer.removeTransform(l,o,0n);this.framesByInstanceId.delete(n),this.transformsByInstanceId.delete(n),this._refreshTransforms(),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}return}else this.handleSettingsUpdate(t)},this.handleSettingsUpdate=t=>{const i=t.payload.path;if(i.length===5&&i[2]==="joints"){const n=i[1],r=i[3],a=this.transformsByInstanceId.get(n);if(!a)return;const o=a.find(p=>p.joint.name===r);if(!o)return;const l=o.joint,c=this.renderer.transformTree.getOrCreateFrame(o.child),h=`frame:${c.id}`,f=l.jointType==="revolute"||l.jointType==="continuous",u=Ci.set(l.axis.x,l.axis.y,l.axis.z);if(f){const p=t.payload.value,g=xl.setFromAxisAngle(u,p*xi),b=hr.setFromQuaternion(g);c.offsetEulerDegrees=[b.x*Ge,b.y*Ge,b.z*Ge],this.saveSetting(["transforms",h,"rpyOffset"],c.offsetEulerDegrees)}else{const p=t.payload.value;u.multiplyScalar(p),c.offsetPosition=[u.x,u.y,u.z],this.saveSetting(["transforms",h,"xyzOffset"],c.offsetPosition)}}else if(i.length===3){this.saveSetting(i,t.payload.value);const n=i[1];i[1]===Et?this._loadUrdf(n,this.renderer.parameters?.get(or)):this._loadUrdf(n,void 0)}},this.handleRobotDescription=t=>{const i=t.message.data;typeof i=="string"&&this._loadUrdf(nt,i)},this.handleJointState=t=>{const i=t.message,n=i.name??[],r=i.position??[],a=(0,m.toNanoSec)(t.receiveTime);for(let o=0;o<n.length;o++){const l=n[o],c=r[o]??0,h=this.jointStates.get(l)?.timestamp;(h==null||a>=h)&&this.jointStates.set(l,{timestamp:a,position:c})}},this.handleParametersChange=t=>{const i=t?.get(or);typeof i=="string"&&this._loadUrdf(Et,i)},this.handleAddUrdf=t=>{ss.info(`Creating ${Ps} layer ${t}`);const i={...dr,instanceId:t};this.renderer.updateConfig(n=>{const a=1+((0,B.maxBy)(Object.values(n.layers),o=>o?.order)?.order??0);n.layers[t]={...i,order:a}}),this._loadUrdf(t,void 0),this.updateSettingsTree()},e.addTopicSubscription(nt,this.handleRobotDescription),e.addSchemaSubscriptions($r,this.handleJointState),e.on("parametersChange",this.handleParametersChange),e.addCustomLayerAction({layerId:Ps,label:E.ZP.t("threeDee:addURDF"),icon:"PrecisionManufacturing",handler:this.handleAddUrdf});for(const[t,i]of Object.entries(e.config.layers))i?.layerId===Ps&&this._loadUrdf(t,void 0)}settingsNodes(){const e=[];if(this.renderer.topicsByName?.get(nt)!=null){const n=this.renderer.config.topics[nt]??{};e.push({path:["topics",nt],node:{label:nt,icon:"PrecisionManufacturing",visible:n.visible??cr.visible,handler:this.handleTopicSettingsAction,children:pr(this.transformsByInstanceId.get(nt),this.renderer.transformTree,this.jointStates)}})}if(this.renderer.parameters?.get(or)!=null){const n=this.renderer.config.topics[Et]??{},r={};e.push({path:["topics",Et],node:{label:um,icon:"PrecisionManufacturing",fields:r,visible:n.visible??cr.visible,handler:this.handleTopicSettingsAction,children:pr(this.transformsByInstanceId.get(Et),this.renderer.transformTree,this.jointStates)}})}for(const[n,r]of Object.entries(this.renderer.config.layers))if(r?.layerId===Ps){const a=r,c={url:{label:"URL",input:"string",placeholder:ur?"package://":void 0,help:ur?"package:// URL or http(s) URL pointing to a Unified Robot Description Format (URDF) XML file":"http(s) URL pointing to a Unified Robot Description Format (URDF) XML file",value:a.url??""}};e.push({path:["layers",n],node:{label:a.label??"Grid",icon:"PrecisionManufacturing",fields:c,visible:a.visible??dr.visible,actions:[{type:"action",id:"delete",label:"Delete"}],order:r.order,handler:this.handleLayerSettingsAction,children:pr(this.transformsByInstanceId.get(n),this.renderer.transformTree,this.jointStates)}})}return e}removeAllRenderables(){this._refreshTransforms()}_refreshTransforms(){for(const[e,t]of this.framesByInstanceId)this._loadFrames(e,t);for(const[e,t]of this.transformsByInstanceId)this._loadTransforms(e,t)}startFrame(e,t,i){for(const n of this.renderables.values()){const r=n.userData.settingsPath;let a=!1;if(n.visible=n.userData.settings.visible,!n.visible){this.renderer.settings.errors.clearPath(r);continue}for(const o of n.userData.renderables.values()){const l=e,c=o.userData.frameId;if(!ps(o,this.renderer.transformTree,t,i,c,e,l)){const f=fs(t,i,c);this.renderer.settings.errors.add(r,lt,f),a=!0}}a||this.renderer.settings.errors.remove(r,lt)}}_fetchUrdf(e,t){const i=this.renderables.get(e);if(!i)throw new Error("_fetchUrdf() should only be called for existing renderables");if(!wm(t)){const n=i.userData.settingsPath;this.renderer.settings.errors.add(n,vl,`Invalid URDF URL: "${t}"`);return}if(this.renderer.settings.errors.remove(i.userData.settingsPath,vl),i.userData.url!==t){if(i.userData.fetching){if(i.userData.fetching.url===t)return;i.userData.fetching.control.abort()}ss.debug(`Fetching URDF from ${t}`),i.userData.fetching={url:t,control:new AbortController},fetch(t,{signal:i.userData.fetching.control.signal}).then(n=>n.text()).then(n=>{ss.debug(`Fetched ${n.length} byte URDF from ${t}`),this.renderer.settings.errors.remove(["layers",e],Tl),this._loadUrdf(e,n)}).catch(n=>{const r=n,a=!r.message.startsWith("Failed to fetch"),o=`Failed to load URDF from "${t}"${a?`: ${r.message}`:""}`;this.renderer.settings.errors.add(["layers",e],Tl,o)})}}_getCurrentSettings(e){const t=e===nt||e===Et,i=t?cr:dr,n=t?this.renderer.config.topics[e]:this.renderer.config.layers[e];return{...i,...n,instanceId:e}}_loadUrdf(e,t){let i=this.renderables.get(e);if(i&&t!=null&&i.userData.urdf===t){const h=this._getCurrentSettings(e);i.userData.settings=h;return}this.transformsByInstanceId.delete(e),this.framesByInstanceId.delete(e),this.updateSettingsTree();const n=e===nt||e===Et,r=this.renderer.fixedFrameId??"",a=n?["topics",e]:["layers",e],o=this._getCurrentSettings(e),l=o.url;if(i||(i=new ym(e,this.renderer,{urdf:t,url:t!=null?l:void 0,fetching:void 0,renderables:new Map,receiveTime:0n,messageTime:0n,frameId:r,pose:Q(),settingsPath:a,settings:o}),this.add(i),this.renderables.set(e,i)),i.userData.urdf=t,i.userData.url=t!=null?l:void 0,i.userData.settings=o,i.userData.fetching=void 0,!t){i.removeChildren(),l!=null&&this._fetchUrdf(e,l);return}const c=i;vm(t).then(h=>{this._loadRobot(c,h),this.renderer.queueAnimationFrame()}).catch(h=>{const f=h;ss.error(`Failed to parse URDF: ${f.message}`),this.renderer.settings.errors.add(a,fm,`Failed to parse URDF: ${f.message}`)})}_loadRobot(e,{robot:t,frames:i,transforms:n}){const r=this.renderer,a=e.userData.settings.instanceId;this._loadFrames(a,i),this._loadTransforms(a,n),this.updateSettingsTree(),e.removeChildren();const o=(l,c,h)=>{const f=e.userData.url,u=Sm(h,t,c,l,r,f);u.userData.settingsPath=e.userData.settingsPath,e.userData.renderables.set(u.name,u),e.add(u)};for(const l of t.links.values()){const c=l.name;for(let h=0;h<l.visuals.length;h++)o(c,h,l.visuals[h]);if(l.visuals.length===0&&l.colliders.length>0)for(let h=0;h<l.colliders.length;h++)o(c,h,l.colliders[h])}}_loadFrames(e,t){this.framesByInstanceId.set(e,t);for(const i of t)this.renderer.addCoordinateFrame(i)}_loadTransforms(e,t){this.transformsByInstanceId.set(e,t);const n=e===nt||e===Et?["topics",e]:["layers",e];for(const{parent:r,child:a,translation:o,rotation:l}of t)this.renderer.addTransform(r,a,0n,o,l,n)}}async function vm(s){const e=Tm();try{ss.debug(`Parsing ${s.length} byte URDF`);const t=await rm(s,e),i=Array.from(t.links.values(),r=>r.name),n=Array.from(t.joints.values(),r=>{const a=r.origin.xyz,o=pl(r.origin.rpy);return{parent:r.parent,child:r.child,translation:a,rotation:o,joint:r}});return{robot:t,frames:i,transforms:n}}catch(t){throw new Error(`Failed to parse ${s.length} byte URDF: ${t}`)}}function Tm(){return async s=>{try{return ss.debug(`fetch(${s}) requested`),await(await fetch(s)).text()}catch(e){throw new Error(`Failed to fetch "${s}": ${e}`)}}}function Sm(s,e,t,i,n,r){const a=`${i}-${t}-${s.geometry.geometryType}`,o=pl(s.origin.rpy),l={position:s.origin.xyz,orientation:o},c=_m(s,e),h=s.geometry.geometryType;switch(h){case"box":{const f=s.geometry.size,u=fr(i,A.CUBE,l,f,c);return new ml(a,u,void 0,n)}case"cylinder":{const f=s.geometry,u={x:f.radius*2,y:f.radius*2,z:f.length},p=fr(i,A.CUBE,l,u,c);return new yl(a,p,void 0,n)}case"sphere":{const f=s.geometry,u={x:f.radius*2,y:f.radius*2,z:f.radius*2},p=fr(i,A.CUBE,l,u,c);return new gi(a,p,void 0,n)}case"mesh":{const f=s.material?Ls.Ignore:Ls.Use,u=xm(i,l,f,s.geometry,r,c);return new bl(a,u,void 0,n)}default:throw new Error(`Unrecognized visual geometryType: ${h}`)}}function _m(s,e){return s.material?s.material.color?s.material.color:s.material.name?e.materials.get(s.material.name)?.color??lr:lr:lr}function fr(s,e,t,i,n){return{header:{frame_id:s,stamp:{sec:0,nsec:0}},ns:"",id:0,type:e,action:me.ADD,pose:t,scale:i,color:n,lifetime:{sec:0,nsec:0},frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function xm(s,e,t,i,n,r){const a=i.scale??pm;return{header:{frame_id:s,stamp:{sec:0,nsec:0}},ns:"",id:0,type:A.MESH_RESOURCE,action:me.ADD,pose:e,scale:a,color:r,lifetime:{sec:0,nsec:0},frame_locked:!0,points:[],colors:[],text:"",mesh_resource:new URL(i.filename,n).toString(),mesh_use_embedded_materials:t===Ls.Use}}const Cm=["https:","http:","file:","data:"];function wm(s){try{const e=new URL(s);return ur&&e.protocol==="package:"||Cm.includes(e.protocol)}catch{return!1}}function pr(s,e,t){if(!s)return{};const i={};for(const{joint:r}of s){const a=r.child,o=e.getOrCreateFrame(a),{x:l,y:c,z:h}=r.origin.xyz,{x:f,y:u,z:p}=r.origin.rpy,{x:g,y:b,z:T}=r.axis,_={};switch(_.jointType={label:"Type",input:"string",readonly:!0,value:r.jointType},r.jointType){case"fixed":break;case"continuous":case"revolute":{const R=r.limit?r.limit.lower*Ge:-180,N=r.limit?r.limit.upper*Ge:180;let P;const O=t.get(r.name)?.position;if(o.offsetEulerDegrees){const U=Im(o.offsetEulerDegrees);P=Mm(U,r.axis)*Ge}_.manual={label:"Manual angle",input:"number",precision:it,step:1,min:R,max:N,value:P},O!=null&&(_.jointState={label:"JointState angle",input:"number",precision:it,min:R,max:N,readonly:!0,value:O*Ge});break}case"prismatic":{const R=r.limit?.lower,N=r.limit?.upper,P=o.offsetPosition?Dm(o.offsetPosition,r.axis):void 0,O=t.get(r.name)?.position;_.manual={label:"Manual position",input:"number",precision:K,step:.01,min:R,max:N,value:P},O!=null&&(_.jointState={label:"JointState position",input:"number",precision:K,min:R,max:N,readonly:!0,value:O});break}case"floating":case"planar":break}if(_.position={label:"Position",input:"vec3",labels:Sl,precision:K,readonly:!0,value:[l,c,h]},_.rotation={label:"Rotation",input:"vec3",labels:mm,precision:it,readonly:!0,value:[f*Ge,u*Ge,p*Ge]},_.parent={label:"Parent",input:"string",readonly:!0,value:r.parent},_.child={label:"Child",input:"string",readonly:!0,value:r.child},r.jointType!=="fixed"&&(_.axis={label:"Axis",input:"vec3",labels:Sl,precision:K,readonly:!0,value:[g,b,T]}),r.calibration){const{rising:R,falling:N}=r.calibration;_.calibration={label:"Calibration",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,value:[R,N]}}if(r.dynamics){const{damping:R,friction:N}=r.dynamics;_.damping={label:"Damping",input:"number",precision:K,readonly:!0,value:R},_.friction={label:"Friction",input:"number",precision:K,readonly:!0,value:N}}if(r.limit){const{effort:R,velocity:N}=r.limit;if(r.jointType!=="continuous"&&r.jointType!=="fixed"){const{upper:P,lower:O}=r.limit,U=r.jointType==="revolute",V=U?P*Ge:P,j=U?O*Ge:O;_.limit={label:"Limit",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,precision:U?it:K,value:[V,j]}}_.effort={label:"Limit effort",input:"number",precision:K,readonly:!0,value:R},_.velocity={label:"Limit velocity",input:"number",precision:K,readonly:!0,value:N}}if(r.mimic){const{joint:R,multiplier:N,offset:P}=r.mimic;_.mimicJoint={label:"Mimic joint",input:"string",readonly:!0,value:R},_.mimicMultiplier={label:"Mimic multiplier",input:"number",precision:K,readonly:!0,value:N},_.mimicOffset={label:"Mimic offset",input:"number",precision:K,readonly:!0,value:P}}if(r.safetyController){const{softUpperLimit:R,softLowerLimit:N,kPosition:P,kVelocity:O}=r.safetyController;_.softLimit={label:"Soft limit",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,value:[R,N]},_.kPosition={label:"k_position",input:"number",precision:K,readonly:!0,value:P},_.kVelocity={label:"k_velocity",input:"number",precision:K,readonly:!0,value:O}}i[r.name]={label:r.name,fields:_,defaultExpansionState:"collapsed"}}return{joints:{label:"Joints",defaultExpansionState:"collapsed",children:i}}}function Im(s){return hr.set(s[0]*xi,s[1]*xi,s[2]*xi),xl.setFromEuler(hr)}function Dm(s,e){const t=Ci.set(s[0],s[1],s[2]),i=_l.set(e.x,e.y,e.z);t.projectOnVector(i);const n=t.length();return(t.dot(i)<0?-1:1)*n}function Mm(s,e){const t=Ci.set(s.x,s.y,s.z),i=_l.set(e.x,e.y,e.z),n=t.projectOnVector(i),r=gm.set(n.x,n.y,n.z,s.w);r.normalize();const a=2*Math.acos(r.w);return(Ci.set(r.x,r.y,r.z).dot(i)<0?-1:1)*a}var Me=v(3890);const mr={...ci,stixelsEnabled:!1};function Em(s){switch(s){case Me.PointFieldDataType.UINT8:return L.NumericType.UINT8;case Me.PointFieldDataType.INT8:return L.NumericType.INT8;case Me.PointFieldDataType.UINT16:return L.NumericType.UINT16;case Me.PointFieldDataType.INT16:return L.NumericType.INT16;case Me.PointFieldDataType.UINT32:return L.NumericType.UINT32;case Me.PointFieldDataType.INT32:return L.NumericType.INT32;case Me.PointFieldDataType.FLOAT32:return L.NumericType.FLOAT32;case Me.PointFieldDataType.FLOAT64:return L.NumericType.FLOAT64;default:return L.NumericType.UNKNOWN}}class Am{constructor(){this._transformers=new Map}decode(e){if(e.packets.length===0)return;const t=e.packets[0],i=Me.RawPacket.InferModel(t.data);if(i==null)return;const n=(0,m.toSec)(e.header.stamp),r=Me.RawPacket.MAX_POINTS_PER_PACKET*e.packets.length,a=new Me.PointCloud({stamp:n,maxPoints:r}),o=this.getTransformer(i);for(const l of e.packets)o.unpack(new Me.RawPacket(l.data),n,(0,m.toSec)(l.stamp),a);if(a.trim(),!(a.width===0||a.height===0))return{timestamp:e.header.stamp,frame_id:e.header.frame_id,pose:Q(),point_stride:a.point_step,fields:a.fields.map(l=>({name:l.name,offset:l.offset,type:Em(l.datatype)})),data:a.data}}getTransformer(e){let t=this._transformers.get(e);return t!=null||(t=new Me.Transformer(new Me.Calibration(e)),this._transformers.set(e,t)),t}}class Pm extends ie{constructor(e){super("foxglove.VelodyneScans",e),this._pointCloudFieldsByTopic=new Map,this._velodyneCloudConverter=new Am,this.handleSettingsAction=t=>{const i=t.payload.path;if(t.action!=="update"||i.length!==3)return;this.saveSetting(i,t.payload.value);const n=i[1],r=this.renderables.get(n);if(r){const a=this.renderer.config.topics[n],o={...mr,...a};r.updatePointCloud(r.userData.pointCloud,r.userData.originalMessage,o,r.userData.receiveTime)}},this.handleVelodyneScan=t=>{const{topic:i}=t,n=(0,m.toNanoSec)(t.receiveTime),r=this._velodyneCloudConverter.decode(t.message);if(!r)return;let a=this.renderables.get(i);if(!a){const l=this.renderer.config.topics[i],c={...mr,...l};c.colorField==null&&(fo(c,r,{supportsPackedRgbModes:!1}),this.renderer.updateConfig(b=>{const T={...l};T.colorField=c.colorField,T.colorMode=c.colorMode,T.colorMap=c.colorMap,b.topics[i]=T}));const h=Gn(c),f=mo(c),u=go(c),p=Qn(c),g=(0,m.toNanoSec)(r.timestamp);a=new wo(i,this.renderer,{receiveTime:n,messageTime:g,frameId:this.renderer.normalizeFrameId(r.frame_id),pose:Q(),settingsPath:["topics",i],settings:c,topic:i,pointCloud:r,originalMessage:t.message,material:h,pickingMaterial:f,instancePickingMaterial:u,stixelMaterial:p}),this.add(a),this.renderables.set(i,a)}let o=this._pointCloudFieldsByTopic.get(t.topic);(!o||o.length!==r.fields.length)&&(o=r.fields.map(l=>l.name),this._pointCloudFieldsByTopic.set(t.topic,o),this.updateSettingsTree()),a.updatePointCloud(r,t.message,a.userData.settings,n)},e.addSchemaSubscriptions(nn,this.handleVelodyneScan)}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,i=[];for(const n of this.renderer.topics??[]){if(!Y(n,nn))continue;const r=e[n.name]??{},a=this._pointCloudFieldsByTopic.get(n.name)??uo,o=kn(n,a,r);o.fields.stixelsEnabled={label:"Stixel view",input:"boolean",value:r.stixelsEnabled??mr.stixelsEnabled},o.handler=t,o.icon="Points",i.push({path:["topics",n.name],node:o})}return i}startFrame(e,t,i){for(const n of this.renderables.values())n.startFrame(e,t,i)}}const Lm=4,gr=new d.yGw;class Cl extends d.SPe{constructor(e,t,i=Lm){super(e,t,0),this._capacity=i,this._resize()}set(e,t,i,n){const r=e.length;this._setCount(r);const a=this.instanceColor.array;for(let o=0;o<r;o++){const l=e[o],c=i[o]??n;gr.makeTranslation(l.x,l.y,l.z),gr.scale(t),this.setMatrixAt(o,gr),a[o*3+0]=c.r*255|0,a[o*3+1]=c.g*255|0,a[o*3+2]=c.b*255|0}this.instanceMatrix.needsUpdate=!0,this.instanceColor&&(this.instanceColor.needsUpdate=!0)}_setCount(e){for(;e>=this._capacity;)this._expand();this.count=e,this.instanceMatrix.count=e,this.instanceColor.count=e}_expand(){this._capacity=this._capacity+Math.trunc(this._capacity/2)+16,this._resize()}_resize(){const e=this.instanceMatrix.array,t=this.instanceColor?.array,i=new Float32Array(this._capacity*16),n=new Uint8ClampedArray(this._capacity*3);e.length>0&&i.set(e),t&&t.length>0&&n.set(t),this.instanceMatrix=new d.lb7(i,16),this.instanceColor=new d.lb7(n,3,!0),this.instanceMatrix.setUsage(d.dj0),this.instanceColor.setUsage(d.dj0)}}class Rm extends Ue{constructor(e,t,i,n){super(e,t,i,n);const r=_a(t),a=n.sharedGeometry.getGeometry("RenderableCube",gl);this.mesh=new Cl(a,r,t.points.length),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh),this.update(t,i)}dispose(){this.mesh.material.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=he(n);r!==he(i)&&(this.mesh.material.transparent=r,this.mesh.material.depthWrite=!r,this.mesh.material.needsUpdate=!0),this.mesh.set(n.points,n.scale,n.colors,n.color)}}class Nm extends Ue{constructor(e,t,i,n){super(e,t,i,n),this.geometry=new Ss,this.geometry.createAttribute("position",Float32Array,3),this.geometry.createAttribute("color",Uint8Array,4,!0),this.points=new d.woe(this.geometry,jd(t)),this.add(this.points),this.update(t,i)}dispose(){this.points.material.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=he(n);r!==he(i)&&(this.points.material.transparent=r,this.points.material.depthWrite=!r,this.points.material.needsUpdate=!0),this.points.material.size=n.scale.x;const a=n.points.length;this.geometry.resize(a),this._setPositions(n,a),this._setColors(n,a)}_setPositions(e,t){const i=this.geometry.getAttribute("position"),n=i.array;for(let r=0;r<t;r++){const a=e.points[r];n[r*3+0]=a.x,n[r*3+1]=a.y,n[r*3+2]=a.z}i.needsUpdate=!0}_setColors(e,t){const i=this.geometry.getAttribute("color"),n=i.array;this._markerColorsToLinear(e,t,(r,a)=>{n[4*a+0]=r[0]*255|0,n[4*a+1]=r[1]*255|0,n[4*a+2]=r[2]*255|0,n[4*a+3]=r[3]*255|0}),i.needsUpdate=!0}}class Om extends Ue{constructor(e,t,i,n){super(e,t,i,n);const r=n.sharedGeometry.getGeometry(`RenderableSphere-${n.maxLod}`,()=>Uo(n.maxLod)),a=_a(t);this.mesh=new Cl(r,a,t.points.length),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh),this.update(t,i)}dispose(){this.mesh.material.dispose()}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=he(n);r!==he(i)&&(this.mesh.material.transparent=r,this.mesh.material.depthWrite=!r,this.mesh.material.needsUpdate=!0),this.mesh.set(n.points,n.scale,n.colors,n.color)}}class Fm extends Ue{constructor(e,t,i,n){super(e,t,i,n),this.label=n.labelPool.acquire(),this.label.setBillboard(!0),this.add(this.label),this.update(t,i)}dispose(){this.renderer.labelPool.release(this.label)}update(e,t){super.update(e,t);const i=this.userData.marker;this.label.setText(i.text),this.label.setColor(te(i.color.r),te(i.color.g),te(i.color.b)),Zi(i.color.r,i.color.g,i.color.b)<.5?this.label.setBackgroundColor(1,1,1):this.label.setBackgroundColor(0,0,0),this.label.setOpacity(i.color.a),this.label.setLineHeight(i.scale.z),this.label.userData.pose=i.pose}}const Um="NOT_DIVISIBLE",km="EMPTY",zm="COLORS_MISMATCH",Gm="INVALID_POINT",Bm=new Float32Array,ut={r:0,g:0,b:0,a:0};class jm extends Ue{constructor(e,t,i,n){super(e,t,i,n),this.vertices=new Float32Array(t.points.length*3),this.colors=new Float32Array(t.colors.length*4),this.mesh=new d.Kj0(new d.u9r,Bd(t)),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh),this.update(t,i)}dispose(){this.mesh.material.dispose(),this.mesh.geometry.dispose(),this.vertices=new Float32Array,this.colors=new Float32Array}update(e,t){const i=this.userData.marker;super.update(e,t);const n=this.userData.marker;let r=n.points.length;if(r===0){this.renderer.settings.errors.addToTopic(this.userData.topic,km,"TRIANGLE_LIST: points is empty"),this.mesh.geometry.setAttribute("position",new d.TlE(Bm,3));return}if(r%3!==0){const f=`${n.ns.length>0?n.ns+":":""}${n.id}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Um,`TRIANGLE_LIST: points.length ${r} is not divisible by 3 for marker ${f}`),r=Math.floor(r/3)*3}if(n.colors.length!==0&&n.colors.length!==r){const f=`${n.ns.length>0?n.ns+":":""}${n.id}`;this.renderer.settings.errors.addToTopic(this.userData.topic,zm,`TRIANGLE_LIST: colors.length ${n.colors.length} != points.length ${r} for marker ${f}`)}const a=he(n);a!==he(i)&&(this.mesh.material.transparent=a,this.mesh.material.depthWrite=!a,this.mesh.material.needsUpdate=!0);let o=!1;const l=r*3;l!==this.vertices.length&&(this.vertices=new Float32Array(l),o=!0),r*4!==this.colors.length&&(this.colors=new Float32Array(r*4),o=!0);const{vertices:c,colors:h}=this;for(let f=0;f<r;f++){const u=n.points[f];if(!$m(u)){this.renderer.settings.errors.addToTopic(this.userData.topic,Gm,`TRIANGLE_LIST: point at index ${f} is not finite`);continue}o=o||c[f*3]!==u.x||c[f*3+1]!==u.y||c[f*3+2]!==u.z,c[f*3]=u.x,c[f*3+1]=u.y,c[f*3+2]=u.z,$t(ut,n.colors[f]??n.color),o=o||h[f*4]!==ut.r||h[f*4+1]!==ut.g||h[f*4+2]!==ut.b||h[f*4+3]!==ut.a,h[f*4]=ut.r,h[f*4+1]=ut.g,h[f*4+2]=ut.b,h[f*4+3]=ut.a}if(o){const f=this.mesh.geometry;f.setAttribute("position",new d.TlE(c,3)),f.setAttribute("color",new d.TlE(h,4)),f.attributes.position.needsUpdate=!0,f.attributes.color.needsUpdate=!0,f.computeVertexNormals(),f.computeBoundingSphere()}}}function $m(s){return Number.isFinite(s.x)&&Number.isFinite(s.y)&&Number.isFinite(s.z)}const Vm={[A.ARROW]:mi,[A.CUBE]:ml,[A.SPHERE]:gi,[A.CYLINDER]:yl,[A.LINE_STRIP]:qn,[A.LINE_LIST]:In,[A.CUBE_LIST]:Rm,[A.SPHERE_LIST]:Om,[A.POINTS]:Nm,[A.TEXT_VIEW_FACING]:Fm,[A.MESH_RESOURCE]:bl,[A.TRIANGLE_LIST]:jm};class Hm{constructor(e){this.renderer=e,this.renderablesByType=new Map}acquire(e,t,i,n){const r=this.renderablesByType.get(e);if(r){const o=r.pop();if(o)return o.userData.settingsPath=["topics",t],o.userData.settings={visible:!0,frameLocked:i.frame_locked},o.userData.topic=t,o.name=Ye(t,i.ns,i.id),o.update(i,n),o}return new Vm[e](t,i,n,this.renderer)}release(e){const t=e.userData.marker.type,i=this.renderablesByType.get(t);i?i.push(e):this.renderablesByType.set(t,[e])}dispose(){for(const e of this.renderablesByType.values())for(const t of e)t.dispose();this.renderablesByType.clear()}}var Wm="../../packages/studio-base/src/panels/ThreeDeeRender/Renderer.ts";const Le=x.ZP.getLogger(Wm),yr=!1,Ym=10,wl=new d.Ilk(ha.light.background?.default),Il=new d.Ilk(ha.dark.background?.default),br=0,vr=1,Zm=new d.Pa4(1,0,0),Km=new d.Pa4(0,0,1),Xm=Math.PI/2,Jm=["base_link","odom","map","earth"],is=["general","followTf"],Dl="NO_FRAME_SELECTED",Tr="FRAME_NOT_FOUND",Qm="TF_OVERFLOW",Ml="CYCLE_DETECTED",El="foxglove.Renderer",qm=new d.Ilk,eg=new d.Pa4,Al=new d.FM8,Pl=new d.$V,tg=new d.USm,At=Q();Object.defineProperty(yn.iT.prototype,"vertexShaderKey",{get(){return"LabelMaterial-VertexShader"},enumerable:!0,configurable:!0}),Object.defineProperty(yn.iT.prototype,"fragmentShaderKey",{get(){return this.picking?"LabelMaterial-FragmentShader-picking":"LabelMaterial-FragmentShader"},enumerable:!0,configurable:!0});class sg extends d.nls{constructor(...e){super(...e),this.defines??(this.defines={}),this.defines.USE_INSTANCING=!0}}class ig extends Us.Z{constructor(e,t,i){if(super(),this.maxLod=Ce.High,this.variables=new Map,this.sceneExtensions=new Map,this.schemaHandlers=new Map,this.topicHandlers=new Map,this.customLayerActions=new Map,this.outlineMaterial=new d.nls({dithering:!0}),this.instancedOutlineMaterial=new sg({dithering:!0}),this.ros=!1,this.colorScheme="light",this.transformTree=new un,this.coordinateFrameList=[],this.currentTime=0n,this.labelPool=new yn.$A({fontFamily:le.R.MONOSPACE}),this.markerPool=new Hm(this),this.sharedGeometry=new Nd,this._prevResolution=new d.FM8,this._pickingEnabled=!1,this._isUpdatingCameraState=!1,this._onDevicePixelRatioChange=()=>{Le.debug(`devicePixelRatio changed to ${window.devicePixelRatio}`),this.resizeHandler(this.input.canvasSize),this._watchDevicePixelRatio()},this._allFramesCursor={index:-1,cursorTimeReached:void 0},this.animationFrame=()=>{this._animationFrame=void 0,this.frameHandler(this.currentTime)},this.frameHandler=l=>{this.currentTime=l,this._updateFrames(l),this._updateResolution(),this.gl.clear(),this.emit("startFrame",l,this);const c=this.activeCamera();c.layers.set(br),this.selectionBackdrop.visible=this.selectedRenderable!=null;const h=this.renderFrameId??J.FALLBACK_FRAME_ID,f=this.fixedFrameId??J.FALLBACK_FRAME_ID,u=this.transformTree.frame(h),p=this.transformTree.frame(f);this.followMode!=="follow-pose"&&this.unfollowPoseSnapshot&&u&&p&&(u.applyLocal(At,this.unfollowPoseSnapshot,p,l),this.followMode==="follow-position"?this.cameraGroup.position.set(0,0,0):this.cameraGroup.position.set(At.position.x,At.position.y,At.position.z),this.cameraGroup.quaternion.set(At.orientation.x,At.orientation.y,At.orientation.z,At.orientation.w));for(const g of this.sceneExtensions.values())g.startFrame(l,h,f);this.gl.render(this.scene,c),this.selectedRenderable&&(this.gl.clearDepth(),c.layers.set(vr),this.selectionBackdrop.visible=!1,this.gl.render(this.scene,c)),this.emit("endFrame",l,this),this.gl.info.reset()},this.resizeHandler=l=>{this.gl.setPixelRatio(window.devicePixelRatio),this.gl.setSize(l.width,l.height);const c=this.gl.getDrawingBufferSize(Al);this.aspect=c.width/c.height,this._updateCameras(this.config.cameraState),Le.debug(`Resized renderer to ${c.width}x${c.height}`),this.animationFrame()},this.clickHandler=l=>{if(!this._pickingEnabled){this.setSelectedRenderable(void 0);return}if(this.measurementTool.state!=="idle"||this.publishClickTool.state!=="idle")return;this.setSelectedRenderable(void 0);const c=this.activeCamera(),h=[];let f;for(;(f=this._pickSingleObject(l))&&h.length<Ym;)h.push(f),f.renderable.visible=!1,this.gl.render(this.scene,c);for(const u of h)u.renderable.visible=!0;yr||this.animationFrame(),Le.debug(`Clicked ${h.length} renderable(s)`),this.emit("renderablesClicked",h,l,this)},this.handleFrameTransform=({message:l})=>{const c=ra(l);this.addFrameTransform(c)},this.handleFrameTransforms=({message:l})=>{const c=Nc(l);for(const h of c.transforms)this.addFrameTransform(h)},this.handleTFMessage=({message:l})=>{const c=Rc(l);for(const h of c.transforms)this.addTransformMessage(h)},this.handleTransformStamped=({message:l})=>{const c=na(l);this.addTransformMessage(c)},this.handleTopicsAction=l=>{const c=l.payload.path;if(l.action!=="perform-node-action"||c.length!==1||c[0]!=="topics")return;Le.debug(`handleTopicsAction(${l.payload.id})`);const h=f=>{for(const u of this.sceneExtensions.values())for(const p of u.settingsNodes())p.path[0]==="topics"&&u.handleSettingsAction({action:"update",payload:{path:[...p.path,"visible"],input:"boolean",value:f}})};l.payload.id==="show-all"?h(!0):l.payload.id==="hide-all"&&h(!1)},this.handleCustomLayersAction=l=>{const c=l.payload.path;if(l.action!=="perform-node-action"||c.length!==1||c[0]!=="layers")return;Le.debug(`handleCustomLayersAction(${l.payload.id})`);const h=l.payload.id,f=h.slice(0,-37),u=h.slice(-36),p=this.customLayerActions.get(f);if(!p)throw new Error(`No custom layer action found for "${f}"`);const{label:g,icon:b}=p.action;this.addCustomLayerAction({layerId:f,label:g,icon:b,handler:p.handler}),p.handler(u),this.updateCustomLayersCount()},this._lastTransformFrameCount=0,d.Tme.DEFAULT_UP=new d.Pa4(0,0,1),this.interfaceMode=i,this.canvas=e,this.config=t,this.settings=new Pd(ag(this.interfaceMode)),this.settings.on("update",()=>this.emit("settingsTreeChange",this)),this.settings.setNodesForKey(El,[]),this.updateCustomLayersCount(),this.gl=new d.CP7({canvas:e,alpha:!0,antialias:!0}),!this.gl.capabilities.isWebGL2)throw new Error("WebGL2 is not supported");this.gl.outputEncoding=d.knz,this.gl.toneMapping=d.uL9,this.gl.autoClear=!1,this.gl.info.autoReset=!1,this.gl.shadowMap.enabled=!1,this.gl.shadowMap.type=d.dwk,this.gl.sortObjects=!0,this.gl.setPixelRatio(window.devicePixelRatio);let n=e.width,r=e.height;e.parentElement&&(n=e.parentElement.clientWidth,r=e.parentElement.clientHeight,this.gl.setSize(n,r)),this.modelCache=new bd({ignoreColladaUpAxis:t.scene.ignoreColladaUpAxis??!1,meshUpAxis:t.scene.meshUpAxis??bn,edgeMaterial:this.outlineMaterial}),this.scene=new d.xsS,this.dirLight=new d.Ox3,this.dirLight.position.set(1,1,1),this.dirLight.castShadow=!0,this.dirLight.layers.enableAll(),this.dirLight.shadow.mapSize.width=2048,this.dirLight.shadow.mapSize.height=2048,this.dirLight.shadow.camera.near=.5,this.dirLight.shadow.camera.far=500,this.dirLight.shadow.bias=-1e-5,this.hemiLight=new d.vmT(16777215,16777215,.5),this.hemiLight.layers.enableAll(),this.scene.add(this.dirLight),this.scene.add(this.hemiLight),this.perspectiveCamera=new d.cPb,this.orthographicCamera=new d.iKG,this.cameraGroup=new d.ZAu,this.cameraGroup.add(this.perspectiveCamera),this.cameraGroup.add(this.orthographicCamera),this.scene.add(this.cameraGroup),this.controls=new sc.z(this.perspectiveCamera,this.canvas),this.controls.screenSpacePanning=!1,this.controls.mouseButtons.LEFT=d.RsA.PAN,this.controls.mouseButtons.RIGHT=d.RsA.ROTATE,this.controls.touches.ONE=d.QmN.PAN,this.controls.touches.TWO=d.QmN.DOLLY_ROTATE,this.controls.addEventListener("change",()=>{this._isUpdatingCameraState||this.emit("cameraMove",this)}),e.tabIndex=1e3,this.controls.keys={LEFT:"KeyA",RIGHT:"KeyD",UP:"KeyW",BOTTOM:"KeyS"},this.controls.listenToKeyEvents(e),this.input=new sd(e,()=>this.activeCamera()),this.input.on("resize",l=>this.resizeHandler(l)),this.input.on("click",l=>this.clickHandler(l)),this.picker=new xd(this.gl,this.scene,{debug:yr}),this.selectionBackdrop=new Id(this),this.selectionBackdrop.visible=!1,this.scene.add(this.selectionBackdrop),this.followFrameId=t.followTf,this.followMode=t.followMode;const a=Od(this.gl.capabilities),o=this.gl.getDrawingBufferSize(Al);switch(this.aspect=o.width/o.height,Le.debug(`Initialized ${o.width}x${o.height} renderer (${a}x MSAA)`),this.measurementTool=new fu(this),this.publishClickTool=new Lf(this),this.cameraStateSettings=new Gd(this),this.addSchemaSubscriptions(Pr,{handler:this.handleFrameTransform,shouldSubscribe:()=>!0,preload:t.scene.transforms?.enablePreloading??!0}),this.addSchemaSubscriptions(Lr,{handler:this.handleFrameTransforms,shouldSubscribe:()=>!0,preload:t.scene.transforms?.enablePreloading??!0}),this.addSchemaSubscriptions(qi,{handler:this.handleTFMessage,shouldSubscribe:()=>!0,preload:t.scene.transforms?.enablePreloading??!0}),this.addSchemaSubscriptions(jr,{handler:this.handleTransformStamped,shouldSubscribe:()=>!0,preload:t.scene.transforms?.enablePreloading??!0}),i){case"image":this.addSceneExtension(new Ch(this));break;case"3d":this.addSceneExtension(this.cameraStateSettings),this.addSceneExtension(new Rf(this)),this.addSceneExtension(new gh(this));break}this.addSceneExtension(new th(this)),this.addSceneExtension(new Xd(this)),this.addSceneExtension(new lh(this)),this.addSceneExtension(new xh(this)),this.addSceneExtension(new Eh(this)),this.addSceneExtension(new hu(this)),this.addSceneExtension(new Fp(this)),this.addSceneExtension(new $c(this)),this.addSceneExtension(new eu(this)),this.addSceneExtension(new wu(this)),this.addSceneExtension(new zu(this)),this.addSceneExtension(new Ku(this)),this.addSceneExtension(new hf(this)),this.addSceneExtension(new If(this)),this.addSceneExtension(new bm(this)),this.addSceneExtension(new Pm(this)),this.addSceneExtension(this.measurementTool),this.addSceneExtension(this.publishClickTool),this._watchDevicePixelRatio(),this._updateCameras(t.cameraState),this.animationFrame()}_watchDevicePixelRatio(){this._devicePixelRatioMediaQuery=window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._devicePixelRatioMediaQuery.addEventListener("change",this._onDevicePixelRatioChange,{once:!0})}dispose(){Le.warn("Disposing renderer"),this._devicePixelRatioMediaQuery?.removeEventListener("change",this._onDevicePixelRatioChange),this.removeAllListeners(),this.settings.removeAllListeners(),this.input.removeAllListeners(),this.controls.dispose();for(const e of this.sceneExtensions.values())e.dispose();this.sceneExtensions.clear(),this.sharedGeometry.dispose(),this.modelCache.dispose(),this.labelPool.dispose(),this.markerPool.dispose(),this.picker.dispose(),this.input.dispose(),this.gl.dispose()}cameraSyncError(){return this._cameraSyncError}setCameraSyncError(e){this._cameraSyncError=e,this.cameraStateSettings.updateSettingsTree()}getPixelRatio(){return this.gl.getPixelRatio()}setCurrentTime(e){this.currentTime=e}handleSeek(e){const t=this.currentTime<e;this.clear({clearTransforms:t,resetAllFramesCursor:t})}clear({clearTransforms:e,resetAllFramesCursor:t}={clearTransforms:!1,resetAllFramesCursor:!1}){e===!0&&this.transformTree.clear(),t===!0&&this._resetAllFramesCursor(),this.settings.errors.clear();for(const i of this.sceneExtensions.values())i.removeAllRenderables()}_resetAllFramesCursor(){this._allFramesCursor={index:-1,cursorTimeReached:void 0}}handleAllFramesMessages(e){const t=(0,m.fromNanoSec)(this.currentTime),i=this._allFramesCursor;let n=i.index,r=i.cursorTimeReached;if(!e||e.length===0)return n>-1&&this._resetAllFramesCursor(),!1;n=Math.min(n,e.length-1);let a,o=!1;for(;n<e.length-1;){if(n++,a=e[n],(0,m.isLessThan)(t,a.receiveTime)){r=t,n--;break}o||(o=!0),this.addMessageEvent(a),n===e.length-1&&(r=a.receiveTime)}return o?(this._allFramesCursor={index:n,cursorTimeReached:r},!0):!1}addSceneExtension(e){if(this.sceneExtensions.has(e.extensionId))throw new Error(`Attempted to add duplicate extensionId "${e.extensionId}"`);this.sceneExtensions.set(e.extensionId,e),this.scene.add(e)}updateConfig(e){this.config=(0,os.Uy)(this.config,e),this.emit("configChange",this)}addSchemaSubscriptions(e,t){const i=t instanceof Function?{handler:t}:t;for(const n of e){let r=this.schemaHandlers.get(n);r||(r=[],this.schemaHandlers.set(n,r)),r.includes(i)||r.push(i)}this.emit("schemaHandlersChanged",this)}addTopicSubscription(e,t){const i=t instanceof Function?{handler:t}:t;let n=this.topicHandlers.get(e);n||(n=[],this.topicHandlers.set(e,n)),n.includes(i)||n.push(i),this.emit("topicHandlersChanged",this)}addCustomLayerAction(e){const t=e.handler,i=(0,ic.Z)(),n={type:"action",id:`${e.layerId}-${i}`,label:e.label,icon:e.icon};this.customLayerActions.set(e.layerId,{action:n,handler:t});const r={path:["topics"],node:{enableVisibilityFilter:!0,label:E.ZP.t("threeDee:topics"),defaultExpansionState:"expanded",actions:[{id:"show-all",type:"action",label:E.ZP.t("threeDee:showAll")},{id:"hide-all",type:"action",label:E.ZP.t("threeDee:hideAll")}],children:this.settings.tree().topics?.children,handler:this.handleTopicsAction}},a=Object.keys(this.config.layers).length,o={path:["layers"],node:{label:`${E.ZP.t("threeDee:customLayers")}${a>0?` (${a})`:""}`,children:this.settings.tree().layers?.children,actions:Array.from(this.customLayerActions.values()).map(l=>l.action),handler:this.handleCustomLayersAction}};this.settings.setNodesForKey(El,[r,o])}defaultFrameId(){const e=this.transformTree.frames();if(e.size===0)return;if(this.followFrameId!=null)return this.transformTree.hasFrame(this.followFrameId)?this.followFrameId:void 0;for(const r of Jm){const a=this.transformTree.frame(r);if(a)return a.id}const t=new Map;for(const r of e.values()){const o=r.root().id;t.set(o,(t.get(o)??0)+1)}return Array.from(t.entries()).sort((r,a)=>a[1]-r[1])[0]?.[0]}setPickingEnabled(e){this._pickingEnabled=e,e||this.setSelectedRenderable(void 0)}setColorScheme(e,t){this.colorScheme=e;const i=t?Yi(qm,t):void 0;for(const n of this.sceneExtensions.values())n.setColorScheme(e,i);e==="dark"?(this.gl.setClearColor(i??Il),this.outlineMaterial.color.set(Wi),this.outlineMaterial.needsUpdate=!0,this.instancedOutlineMaterial.color.set(Wi),this.instancedOutlineMaterial.needsUpdate=!0,this.selectionBackdrop.setColor(Il,.8)):(this.gl.setClearColor(i??wl),this.outlineMaterial.color.set(Hi),this.outlineMaterial.needsUpdate=!0,this.instancedOutlineMaterial.color.set(Hi),this.instancedOutlineMaterial.needsUpdate=!0,this.selectionBackdrop.setColor(wl,.8))}setTopics(e){const t=this.topics!==e;if(this.topics=e,t){this.topicsByName=e?new Map(e.map(i=>[i.name,i])):void 0;for(const i of this.sceneExtensions.values())this.settings.setNodesForKey(i.extensionId,i.settingsNodes())}}setParameters(e){const t=this.parameters!==e;this.parameters=e,t&&this.emit("parametersChange",e,this)}setVariables(e){const t=this.variables!==e;this.variables=e,t&&this.emit("variablesChange",e,this)}updateCustomLayersCount(){const e=Object.keys(this.config.layers).length,t=`Custom Layers${e>0?` (${e})`:""}`;this.settings.setLabel(["layers"],t)}_updateCameras(e){const t=eg;t.fromArray(e.targetOffset);const i=d.M8C.degToRad(e.phi),n=-d.M8C.degToRad(e.thetaOffset);if(Pl.set(e.distance,i,n),this.perspectiveCamera.position.setFromSpherical(Pl).applyAxisAngle(Zm,Xm),this.perspectiveCamera.position.add(t),this.perspectiveCamera.quaternion.setFromEuler(tg.set(i,0,n,"ZYX")),this.perspectiveCamera.fov=e.fovy,this.perspectiveCamera.near=e.near,this.perspectiveCamera.far=e.far,this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.updateProjectionMatrix(),this.controls.target.copy(t),e.perspective)this.controls.minPolarAngle=0,this.controls.maxPolarAngle=Math.PI;else{const r=d.M8C.degToRad(this.config.cameraState.phi);this.controls.minPolarAngle=this.controls.maxPolarAngle=r,this.orthographicCamera.position.set(t.x,t.y,e.far/2),this.orthographicCamera.quaternion.setFromAxisAngle(Km,n),this.orthographicCamera.left=-e.distance/2*this.aspect,this.orthographicCamera.right=e.distance/2*this.aspect,this.orthographicCamera.top=e.distance/2,this.orthographicCamera.bottom=-e.distance/2,this.orthographicCamera.near=e.near,this.orthographicCamera.far=e.far,this.orthographicCamera.updateProjectionMatrix()}}setCameraState(e){this._isUpdatingCameraState=!0,this._updateCameras(e),this.followMode==="follow-pose"&&this.controls.update(),this._isUpdatingCameraState=!1}getCameraState(){return{perspective:this.config.cameraState.perspective,distance:this.controls.getDistance(),phi:d.M8C.radToDeg(this.controls.getPolarAngle()),thetaOffset:d.M8C.radToDeg(-this.controls.getAzimuthalAngle()),targetOffset:[this.controls.target.x,this.controls.target.y,this.controls.target.z],target:this.config.cameraState.target,targetOrientation:this.config.cameraState.targetOrientation,fovy:this.config.cameraState.fovy,near:this.config.cameraState.near,far:this.config.cameraState.far}}setSelectedRenderable(e){if(this.selectedRenderable===e)return;const t=this.selectedRenderable;t&&(rg(t.renderable),Le.debug(`Deselected ${t.renderable.id} (${t.renderable.name})`)),this.selectedRenderable=e,e&&(ng(e.renderable),Le.debug(`Selected ${e.renderable.id} (${e.renderable.name}) (instance=${e.instanceIndex})`)),this.emit("selectedRenderable",e,this),yr||this.animationFrame()}activeCamera(){return this.config.cameraState.perspective?this.perspectiveCamera:this.orthographicCamera}addMessageEvent(e){const{message:t}=e,i=t,n=t,r=t,a=t;if(i.header){const o=i.header.frame_id??"";this.addCoordinateFrame(o)}else if(Array.isArray(n.markers)){for(const o of n.markers)if(o){const l=o.header?.frame_id??"";this.addCoordinateFrame(l)}}else if(Array.isArray(r.entities)){for(const o of r.entities)if(o){const l=o.frame_id??"";this.addCoordinateFrame(l)}}else typeof a.frame_id=="string"&&this.addCoordinateFrame(a.frame_id);Ll(e,this.topicHandlers.get(e.topic)),Ll(e,this.schemaHandlers.get(e.schemaName))}normalizeFrameId(e){return!this.ros||!e.startsWith("/")?e:e.slice(1)}addCoordinateFrame(e){const t=this.normalizeFrameId(e);this.transformTree.hasFrame(t)||(this.transformTree.getOrCreateFrame(t),this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this))}addFrameTransform(e){const t=e.parent_frame_id,i=e.child_frame_id,n=(0,m.toNanoSec)(e.timestamp),r=e.translation,a=e.rotation;this.addTransform(t,i,n,r,a)}addTransformMessage(e){const t=this.normalizeFrameId(e.header.frame_id),i=this.normalizeFrameId(e.child_frame_id),n=(0,m.toNanoSec)(e.header.stamp),r=e.transform.translation,a=e.transform.rotation;this.addTransform(t,i,n,r,a)}addTransform(e,t,i,n,r,a){const o=n,l=r,c=new He([o.x,o.y,o.z],[l.x,l.y,l.z,l.w]),h=this.transformTree.addTransform(t,e,i,c);h===Ut.UPDATED&&(this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this)),h===Ut.CYCLE_DETECTED&&(this.settings.errors.add(["transforms",`frame:${t}`],Ml,`Transform tree cycle detected: Received transform with parent "${e}" and child "${t}", but "${t}" is already an ancestor of "${e}". Transform message dropped.`),a&&this.settings.errors.add(a,Ml,`Attempted to add cyclical transform: Frame "${e}" cannot be the parent of frame "${t}". Transform message dropped.`));const f=this.transformTree.getOrCreateFrame(t);f.transformsSize()===f.maxCapacity&&this.settings.errors.add(["transforms",`frame:${t}`],Qm,`[Warning] Transform history is at capacity (${f.maxCapacity}), old TFs will be dropped`)}removeTransform(e,t,i){this.transformTree.removeTransform(e,t,i),this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this)}queueAnimationFrame(){this._animationFrame==null&&(this._animationFrame=requestAnimationFrame(this.animationFrame))}_pickSingleObject(e){const t=this.picker.pick(e.x,e.y,this.activeCamera());if(t===-1)return;const i=this.scene.getObjectById(t);let n,r=i;for(;r;)r.pickable===!0&&(n=r),r=r.parent??void 0;if(!n){Le.warn(`No Renderable found for objectId ${t} (name="${i?.name}" uuid=${i?.uuid})`);return}let a;return n.pickableInstances&&(a=this.picker.pickInstance(e.x,e.y,this.activeCamera(),n),a=a===-1?void 0:a),{renderable:n,instanceIndex:a}}_updateFrames(e){if(this.followFrameId!=null&&this.renderFrameId!==this.followFrameId&&this.transformTree.hasFrame(this.followFrameId))this.renderFrameId=this.followFrameId;else if(this.renderFrameId==null||this.transformTree.frames().size!==this._lastTransformFrameCount||!this.transformTree.hasFrame(this.renderFrameId))if(this.renderFrameId=this.defaultFrameId(),this._lastTransformFrameCount=this.transformTree.frames().size,this.renderFrameId==null){this.followFrameId!=null?this.settings.errors.add(is,Tr,E.ZP.t("threeDee:frameNotFound",{followFrameId:this.followFrameId})):this.settings.errors.add(is,Dl,E.ZP.t("threeDee:noCoordinateFramesFound")),this.fixedFrameId=void 0;return}else Le.debug(`Setting render frame to ${this.renderFrameId}`),this.settings.errors.remove(is,Dl);const t=this.transformTree.frame(this.renderFrameId);if(t)this.settings.errors.remove(is,Tr);else{this.renderFrameId=void 0,this.fixedFrameId=void 0,this.settings.errors.add(is,Tr,E.ZP.t("threeDee:frameNotFound",{followFrameId:this.renderFrameId}));return}const i=t.root(),n=i.id;this.fixedFrameId!==n&&(this.fixedFrameId==null?Le.debug(`Setting fixed frame to ${n}`):Le.debug(`Changing fixed frame from "${this.fixedFrameId}" to "${n}"`),this.unfollowPoseSnapshot=void 0,this.fixedFrameId=n),this.followMode!=="follow-pose"&&!this.unfollowPoseSnapshot&&(this.unfollowPoseSnapshot=Q(),i.applyLocal(this.unfollowPoseSnapshot,this.unfollowPoseSnapshot,t,e)),this.settings.errors.clearPath(is)}updateFollowMode(e){if(this.followMode===e)return;if(!this.renderFrameId||!this.fixedFrameId){this.followMode=e;return}const t=this.transformTree.frame(this.renderFrameId),i=this.transformTree.frame(this.fixedFrameId);if(!t||!i){this.followMode=e;return}this.unfollowPoseSnapshot=Q(),i.applyLocal(this.unfollowPoseSnapshot,this.unfollowPoseSnapshot,t,this.currentTime),this.cameraGroup.position.set(0,0,0),this.cameraGroup.quaternion.set(0,0,0,1),this.followMode=e}_updateResolution(){const e=this.input.canvasSize;this._prevResolution.equals(e)||(this._prevResolution.copy(e),this.scene.traverse(t=>{if(t.material){const n=t.material;n.resolution&&n.resolution.copy(e),n.uniforms?.resolution&&(n.uniforms.resolution.value=e)}}))}}function Ll(s,e){if(e)for(const t of e)t.handler(s)}function ng(s){s.layers.set(vr),s.traverse(e=>{e.layers.set(vr)})}function rg(s){s.layers.set(br),s.traverse(e=>{e.layers.set(br)})}function ag(s){const e=[];return e.push(s==="image"?"imageMode":"general","scene"),s==="3d"&&e.push("cameraState"),e.push("transforms","topics","layers"),s==="3d"&&e.push("publish"),Object.fromEntries(e.map(t=>[t,{}]))}let Be,Sr,_r,xr,Cr,wr=0,Ir=0,Dr=0,Mr=0;function og(s){wr=Math.max(wr,s.gl.info.render.calls),Ir=Math.max(Ir,s.gl.info.render.triangles),Dr=Math.max(Dr,s.gl.info.memory.textures),Mr=Math.max(Mr,s.gl.info.memory.geometries),Sr?.update(s.gl.info.render.calls,wr),_r?.update(s.gl.info.render.triangles,Ir),xr?.update(s.gl.info.memory.textures,Dr),Cr?.update(s.gl.info.memory.geometries,Mr),Be?.update()}function lg(){const[s,e]=(0,S.useState)(null);return ne("endFrame",(t,i)=>og(i)),(0,S.useEffect)(()=>{if(s)return Be=new cg,Be.dom.style.position="relative",Be.dom.style.zIndex="auto",Sr=new ns("draws","red","black"),_r=new ns("tris","cyan","black"),xr=new ns("textures","yellow","black"),Cr=new ns("geometries","green","black"),Be.addPanel(Sr),Be.addPanel(_r),Be.addPanel(xr),Be.addPanel(Cr),s.appendChild(Be.dom),Be.showPanel(0),()=>{if(Be)try{s.removeChild(Be.dom)}catch{}}},[s]),(0,y.jsx)("div",{ref:e})}class cg{constructor(){this.mode=0,this.begin=()=>{this.beginTime=performance.now()},this.end=()=>{const e=performance.now();if(this.msPanel.update(e-this.beginTime,1e3/30),e>=this.prevTime+1e3){this.prevTime=e;const t=performance.memory;this.memPanel.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},this.update=()=>{this.beginTime=this.end()},this.container=document.createElement("div"),this.container.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",this.container.addEventListener("click",e=>{e.preventDefault(),this.showPanel(++this.mode%this.container.children.length)},!1),this.dom=this.container,this.beginTime=performance.now(),this.prevTime=this.beginTime,this.msPanel=this.addPanel(new ns("MS","#9480ed","#1e1a2f")),this.memPanel=this.addPanel(new ns("MB","#f08","#201")),this.showPanel(0)}addPanel(e){return this.container.appendChild(e.dom),e}showPanel(e){for(let t=0;t<this.container.children.length;t++){const i=this.container.children[t];i.style.display=t===e?"block":"none"}this.mode=e}}class ns{constructor(e,t,i){this.min=1/0,this.max=0,this.name=e,this.fg=t,this.bg=i;const n=Math.round(window.devicePixelRatio),r=80*n,a=48*n,o=3*n,l=2*n,c=3*n,h=15*n,f=74*n,u=30*n,p=document.createElement("canvas");p.width=r,p.height=a,p.style.cssText="width:80px;height:48px";const g=p.getContext("2d");g.font=`bold ${9*n}px Helvetica,Arial,sans-serif`,g.textBaseline="top",g.fillStyle=i,g.fillRect(0,0,r,a),g.fillStyle=t,g.fillText(e,o,l),g.fillRect(c,h,f,u),g.fillStyle=i,g.globalAlpha=.9,g.fillRect(c,h,f,u),this.dom=p,this.context=g}update(e,t){const i=Math.round(window.devicePixelRatio),n=80*i,r=3*i,a=2*i,o=3*i,l=15*i,c=74*i,h=30*i;this.min=Math.min(this.min,e),this.max=Math.max(this.max,e),this.context.fillStyle=this.bg,this.context.globalAlpha=1,this.context.fillRect(0,0,n,l),this.context.fillStyle=this.fg,this.context.fillText(`${Math.round(e)} ${this.name} (${Math.round(this.min)}-${Math.round(this.max)})`,r,a),this.context.drawImage(this.dom,o+i,l,c-i,h,o,l,c-i,h),this.context.fillRect(o+c-i,l,i,h),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(o+c-i,l,i,Math.round((1-e/t)*h))}}var Rl=v(13900);const dg=new Map(["geometry_msgs/Point","geometry_msgs/PointStamped","geometry_msgs/Pose","geometry_msgs/PoseStamped","geometry_msgs/PoseWithCovariance","geometry_msgs/PoseWithCovarianceStamped","geometry_msgs/Quaternion","std_msgs/Header"].map(s=>[s,Rl.ros1[s]])),hg=new Map(["geometry_msgs/Point","geometry_msgs/PointStamped","geometry_msgs/Pose","geometry_msgs/PoseStamped","geometry_msgs/PoseWithCovariance","geometry_msgs/PoseWithCovarianceStamped","geometry_msgs/Quaternion","std_msgs/Header"].map(s=>[s,Rl.ros2galactic[s]]));function ug(s,e){return{header:{stamp:(0,m.fromDate)(new Date),frame_id:e},point:{x:s.x,y:s.y,z:0}}}function fg(s,e){return{header:{stamp:(0,m.fromDate)(new Date),frame_id:e},pose:s}}function pg(s,e,t,i,n){return{header:{stamp:(0,m.fromDate)(new Date),frame_id:e},pose:{covariance:am(t,i,n),pose:s}}}var mg="../../packages/studio-base/src/panels/ThreeDeeRender/ThreeDeeRender.tsx";const Rs=x.ZP.getLogger(mg),gg=!1,yg={width:"100%",height:"100%",display:"flex",position:"relative"},wi={pose:(0,y.jsx)(k,{fontSize:"inherit"}),point:(0,y.jsx)(G,{fontSize:"inherit"}),pose_estimate:(0,y.jsx)(X,{fontSize:"inherit"})},bg=(0,z.ZL)()(s=>({iconButton:{position:"relative",fontSize:"1rem !important",pointerEvents:"auto",aspectRatio:"1","& svg:not(.MuiSvgIcon-root)":{fontSize:"1rem !important"}},rulerIcon:{transform:"rotate(45deg)"},threeDeeButton:{fontFamily:le.R.MONOSPACE,fontFeatureSettings:s.typography.caption.fontFeatureSettings,fontSize:s.typography.caption.fontSize,fontWeight:s.typography.fontWeightBold,lineHeight:"1em"}}));function vg(s){const{classes:e}=bg(),[t,i]=(0,S.useState)({clientX:0,clientY:0}),[n,r]=(0,S.useState)([]),[a,o]=(0,S.useState)(void 0),[l,c]=(0,S.useState)(void 0),h=re();(0,S.useEffect)(()=>{h&&h.setPickingEnabled(l!=null)},[l,h]),ne("renderablesClicked",(j,se)=>{const Pt=s.canvas.getBoundingClientRect();i({clientX:Pt.left+se.x,clientY:Pt.top+se.y}),r(j),o(j.length===1?j[0]:void 0)});const f=s.enableStats?(0,y.jsx)("div",{id:"stats",style:{position:"absolute",top:"10px",left:"10px"},children:(0,y.jsx)(lg,{})}):void 0,u=gg?(0,y.jsx)("div",{id:"debug",style:{position:"absolute",top:"70px",left:"10px"},children:(0,y.jsx)(gt,{})}):void 0,p=(0,S.useMemo)(()=>n.map(j=>({object:{pose:j.renderable.pose,scale:j.renderable.scale,color:void 0,interactionData:{topic:j.renderable.name,highlighted:void 0,renderable:j.renderable}},instanceIndex:j.instanceIndex})),[n]),g=(0,S.useMemo)(()=>a?{object:{pose:a.renderable.pose,interactionData:{topic:a.renderable.topic,highlighted:!0,originalMessage:a.renderable.details(),instanceDetails:a.instanceIndex!=null?a.renderable.instanceDetails(a.instanceIndex):void 0}},instanceIndex:a.instanceIndex}:void 0,[a]);(0,S.useEffect)(()=>{h?.setSelectedRenderable(a)},[h,a]);const b=(0,S.useRef)(null),[T,_]=(0,S.useState)(!1),R=wi[s.publishClickType],N=(0,S.useCallback)(()=>{_(!0)},[]),P=(0,F.Z)(N),O=(0,at.Z)(),V=s.interfaceMode==="3d"&&s.canPublish&&h?.fixedFrameId!=null&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)(ot.Z,{...P,color:s.publishActive?"info":"inherit",title:s.publishActive?"Click to cancel":"Click to publish",ref:b,onClick:s.onClickPublish,"data-testid":"publish-button",style:{fontSize:"1rem",pointerEvents:"auto"},children:[R,(0,y.jsx)("div",{style:{borderBottom:"6px solid currentColor",borderRight:"6px solid transparent",bottom:0,left:0,height:0,width:0,margin:O.spacing(.25),position:"absolute"}})]}),(0,y.jsxs)(Ne.Z,{id:"publish-menu",anchorEl:b.current,anchorOrigin:{vertical:"top",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"right"},open:T,onClose:()=>_(!1),children:[(0,y.jsxs)(qe.Z,{selected:s.publishClickType==="pose_estimate",onClick:()=>{s.onChangePublishClickType("pose_estimate"),_(!1)},children:[(0,y.jsx)(et.Z,{children:wi.pose_estimate}),(0,y.jsx)($e.Z,{children:"Publish pose estimate"})]}),(0,y.jsxs)(qe.Z,{selected:s.publishClickType==="pose",onClick:()=>{s.onChangePublishClickType("pose"),_(!1)},children:[(0,y.jsx)(et.Z,{children:wi.pose}),(0,y.jsx)($e.Z,{children:"Publish pose"})]}),(0,y.jsxs)(qe.Z,{selected:s.publishClickType==="point",onClick:()=>{s.onChangePublishClickType("point"),_(!1)},children:[(0,y.jsx)(et.Z,{children:wi.point}),(0,y.jsx)($e.Z,{children:"Publish point"})]})]})]});return(0,y.jsxs)(S.Fragment,{children:[(0,y.jsxs)("div",{style:{position:"absolute",top:"10px",right:"10px",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:10,pointerEvents:"none"},children:[(0,y.jsx)(Jl,{addPanel:s.addPanel,selectedObject:g,interactionsTabType:l,setInteractionsTabType:c,timezone:s.timezone}),s.interfaceMode==="3d"&&(0,y.jsxs)(Ee.Z,{square:!1,elevation:4,style:{display:"flex",flexDirection:"column"},children:[(0,y.jsx)(ot.Z,{className:e.iconButton,color:s.perspective?"info":"inherit",title:s.perspective?"Switch to 2D camera":"Switch to 3D camera",onClick:s.onTogglePerspective,children:(0,y.jsx)("span",{className:e.threeDeeButton,children:"3D"})}),(0,y.jsx)(ot.Z,{"data-testid":"measure-button",className:e.iconButton,color:s.measureActive?"info":"inherit",title:s.measureActive?"Cancel measuring":"Measure distance",onClick:s.onClickMeasure,children:(0,y.jsx)(je.ZHY,{className:e.rulerIcon})}),V]})]}),p.length>1&&!g&&(0,y.jsx)(tc,{onClose:()=>r([]),clickedPosition:t,clickedObjects:p,selectObject:j=>{if(j){const se=j.object.interactionData.renderable,Pt=j.instanceIndex;r([]),o({renderable:se,instanceIndex:Pt})}}}),f,u]})}function Nl(s,e,t,i){const[n,r]=(0,S.useState)(()=>s?.[e]??i());return(0,S.useEffect)(()=>{if(!s)return;const a=()=>r(s[e]);return a(),s.addListener(t,a),()=>{s.removeListener(t,a)}},[s,t,e]),n}function Tg(s){const{context:e,interfaceMode:t}=s,{initialState:i,saveState:n}=e,[r,a]=(0,S.useState)(()=>{const C=i,ee=(0,B.merge)((0,B.cloneDeep)(Kt.d),C?.cameraState),Z=(0,B.merge)((0,B.cloneDeep)(yi),C?.publish),ce=C?.transforms??{},rt={imageTopic:C?.cameraTopic,...C?.imageMode};return{cameraState:ee,followMode:C?.followMode??"follow-pose",followTf:C?.followTf,scene:C?.scene??{},transforms:ce,topics:C?.topics??{},layers:C?.layers??{},publish:Z,imageMode:rt}}),o=(0,w.Z)(r),{cameraState:l}=r,c=r.scene.backgroundColor,[h,f]=(0,S.useState)(null),[u,p]=(0,S.useState)(void 0),g=(0,S.useRef)(void 0);(0,S.useEffect)(()=>{const C=h?new ig(h,o.current,t):void 0;return p(C),g.current=C,()=>{g.current?.dispose(),g.current=void 0}},[h,o,r.scene.transforms?.enablePreloading,t]);const[b,T]=(0,S.useState)(),[_,R]=(0,S.useState)(),[N,P]=(0,S.useState)(),[O,U]=(0,S.useState)(),[V,j]=(0,S.useState)(),[se,Pt]=(0,S.useState)(),[Lt,Cg]=(0,S.useState)(),[Ul,kl]=(0,S.useState)(!1),[zt,wg]=(0,S.useState)(),[zl,Ig]=(0,S.useState)(void 0),ft=(0,S.useRef)({needsRender:!1}),[Gl,Dg]=(0,S.useState)(),Er=Nl(u,"schemaHandlers","schemaHandlersChanged",()=>new Map),Bl=Nl(u,"topicHandlers","topicHandlersChanged",()=>new Map),Ii=u?.followFrameId??u?.renderFrameId;(0,S.useEffect)(()=>{const C=()=>{if(u){const ee=u.getCameraState();u.setCameraState(ee),a(Z=>({...Z,cameraState:ee})),r.scene.syncCamera===!0&&e.setSharedPanelState({cameraState:ee,followMode:u.followMode,followTf:Ii})}};return u?.addListener("cameraMove",C),()=>void u?.removeListener("cameraMove",C)},[r.scene.syncCamera,e,Ii,u]);const Di=(0,S.useCallback)(C=>Te.unstable_batchedUpdates(()=>{if(u){const ee=u.getCameraState();u.settings.handleAction(C);const Z=u.getCameraState();Z!==ee&&r.scene.syncCamera===!0&&e.setSharedPanelState({cameraState:Z,followMode:u.followMode,followTf:u.followFrameId})}}),[r.scene.syncCamera,e,u]),[jl,Mg]=(0,S.useState)(void 0),Eg=(0,S.useCallback)(C=>Mg(C.settings.tree()),[]);ne("settingsTreeChange",Eg,u);const Ag=(0,S.useCallback)(C=>a(C.config),[]);ne("configChange",Ag,u);const Pg=(0,S.useCallback)(C=>{const ee=C?.renderable.idFromMessage(),Z=C?.renderable.selectedIdVariable();Z&&e.setVariable(Z,ee),e.setVariable(Oi,ee)},[e]);ne("selectedRenderable",Pg,u),(0,S.useEffect)(()=>{e.updatePanelSettingsEditor({actionHandler:Di,enableFilter:!0,nodes:jl??{}})},[Di,e,jl]),(0,S.useEffect)(()=>{u&&(u.config=r,ft.current.needsRender=!0)},[r,u]),(0,S.useEffect)(()=>{u&&(u.setTopics(N),ft.current.needsRender=!0)},[N,u]),(0,S.useEffect)(()=>{u&&(u.ros=e.dataSourceProfile==="ros1"||e.dataSourceProfile==="ros2")},[e.dataSourceProfile,u]);const $l=(0,I.y1)(C=>n(C),1e3,{leading:!1,trailing:!0,maxWait:1e3});(0,S.useEffect)(()=>$l(r),[r,$l]),(0,S.useLayoutEffect)(()=>{e.onRender=(C,ee)=>{Te.unstable_batchedUpdates(()=>{if(C.currentTime&&Cg(C.currentTime),C.didSeek===!0&&kl(!0),Dg(()=>ee),T(C.colorScheme),C.appSettings){const Z=C.appSettings.get(M.o.TIMEZONE);R(typeof Z=="string"?Z:void 0)}P(C.topics),wg(C.sharedPanelState),U(C.parameters),j(C.variables),Ol(C.currentFrame),Pt(C.currentFrame),Ol(C.allFrames),Ig(C.allFrames)})},e.watch("allFrames"),e.watch("colorScheme"),e.watch("currentFrame"),e.watch("currentTime"),e.watch("didSeek"),e.watch("parameters"),e.watch("sharedPanelState"),e.watch("variables"),e.watch("topics"),e.watch("appSettings"),e.subscribeAppSettings([M.o.TIMEZONE])},[e,u]);const[Mi,Vl]=(0,S.useState)(void 0);(0,S.useEffect)(()=>{if(!N){Vl(void 0);return}const C=[],ee=(Z,ce,pt)=>{(ce.shouldSubscribe??(kg=>r.topics[kg]?.visible===!0))(Z)&&C.push({topic:Z,preload:ce.preload,convertTo:pt})};for(const Z of N){for(const ce of Bl.get(Z.name)??[])ee(Z.name,ce);for(const ce of Er.get(Z.schemaName)??[])ee(Z.name,ce);for(const ce of Z.convertibleTo??[])for(const pt of Er.get(ce)??[])ee(Z.name,pt,ce)}C.sort((Z,ce)=>Z.topic.localeCompare(ce.topic)),Vl(Z=>(0,B.isEqual)(Z,C)?Z:C)},[N,r.topics,Er,Bl]),(0,S.useEffect)(()=>{Mi&&(Rs.debug(`Subscribing to [${Mi.map(C=>JSON.stringify(C)).join(", ")}]`),e.subscribe(Mi))},[e,Mi]),(0,S.useEffect)(()=>{u&&u.setParameters(O)},[O,u]),(0,S.useEffect)(()=>{u&&V&&u.setVariables(V)},[V,u]),(0,S.useEffect)(()=>{const C=Lt?(0,m.toNanoSec)(Lt):void 0;if(!u||C==null)return;const ee=u.currentTime;u.setCurrentTime(C),Ul&&(u.handleSeek(ee),kl(!1))},[Lt,u,Ul]),(0,S.useEffect)(()=>{b&&u&&(u.setColorScheme(b,c),ft.current.needsRender=!0)},[c,b,u]),(0,S.useEffect)(()=>{if(!u||!Lt)return;u.handleAllFramesMessages(zl)&&(ft.current.needsRender=!0)},[u,Lt,zl]),(0,S.useEffect)(()=>{if(!(!u||!se)){for(const C of se)u.addMessageEvent(C);ft.current.needsRender=!0}},[se,u]),(0,S.useEffect)(()=>{(0,B.isEqual)(l,u?.getCameraState())||(u?.setCameraState(l),ft.current.needsRender=!0)},[l,u]),(0,S.useEffect)(()=>{if(!(!u||zt==null||r.scene.syncCamera!==!0))if(zt.followMode!==u.followMode)u.setCameraSyncError(`Follow mode must be ${zt.followMode} to sync camera.`);else if(zt.followTf!==Ii)u.setCameraSyncError(`Display frame must be ${zt.followTf} to sync camera.`);else{const C=zt.cameraState;u.setCameraState(C),ft.current.needsRender=!0,a(ee=>({...ee,cameraState:C})),u.setCameraSyncError(void 0)}},[r.scene.syncCamera,Ii,u,zt]),(0,S.useEffect)(()=>{u&&ft.current.needsRender&&(u.animationFrame(),ft.current.needsRender=!1)}),(0,S.useEffect)(()=>{Gl?.()},[Gl]);const Lg=(0,S.useCallback)(C=>e.layout.addPanel(C),[e.layout]),[Ei,Hl]=(0,S.useState)(!1);(0,S.useEffect)(()=>{const C=()=>Hl(!0),ee=()=>Hl(!1);return u?.measurementTool.addEventListener("foxglove.measure-start",C),u?.measurementTool.addEventListener("foxglove.measure-end",ee),()=>{u?.measurementTool.removeEventListener("foxglove.measure-start",C),u?.measurementTool.removeEventListener("foxglove.measure-end",ee)}},[u?.measurementTool]);const Rg=(0,S.useCallback)(()=>{Ei?u?.measurementTool.stopMeasuring():(u?.measurementTool.startMeasuring(),u?.publishClickTool.stop())},[Ei,u]),[Ai,Wl]=(0,S.useState)(!1);(0,S.useEffect)(()=>{u?.publishClickTool.publishClickType!==r.publish.type&&(u?.publishClickTool.setPublishClickType(r.publish.type),u?.publishClickTool.stop())},[r.publish.type,u]);const Ke=(0,S.useMemo)(()=>({goal:r.publish.poseTopic,point:r.publish.pointTopic,pose:r.publish.poseEstimateTopic}),[r.publish.poseTopic,r.publish.pointTopic,r.publish.poseEstimateTopic]);(0,S.useEffect)(()=>{const C=e.dataSourceProfile==="ros2"?hg:dg;return e.advertise?.(Ke.goal,"geometry_msgs/PoseStamped",{datatypes:C}),e.advertise?.(Ke.point,"geometry_msgs/PointStamped",{datatypes:C}),e.advertise?.(Ke.pose,"geometry_msgs/PoseWithCovarianceStamped",{datatypes:C}),()=>{e.unadvertise?.(Ke.goal),e.unadvertise?.(Ke.point),e.unadvertise?.(Ke.pose)}},[Ke,e,e.dataSourceProfile]);const Pi=(0,w.Z)(r.publish);(0,S.useEffect)(()=>{const C=()=>Wl(!0),ee=ce=>{const pt=u?.renderFrameId;if(pt==null){Rs.warn("Unable to publish, renderFrameId is not set");return}if(!e.publish){Rs.error("Data source does not support publishing");return}if(e.dataSourceProfile!=="ros1"&&e.dataSourceProfile!=="ros2"){Rs.warn("Publishing is only supported in ros1 and ros2");return}try{switch(ce.publishClickType){case"point":{const rt=ug(ce.point,pt);e.publish(Ke.point,rt);break}case"pose":{const rt=fg(ce.pose,pt);e.publish(Ke.goal,rt);break}case"pose_estimate":{const rt=pg(ce.pose,pt,Pi.current.poseEstimateXDeviation,Pi.current.poseEstimateYDeviation,Pi.current.poseEstimateThetaDeviation);e.publish(Ke.pose,rt);break}}}catch(rt){Rs.info(rt)}},Z=()=>Wl(!1);return u?.publishClickTool.addEventListener("foxglove.publish-start",C),u?.publishClickTool.addEventListener("foxglove.publish-submit",ee),u?.publishClickTool.addEventListener("foxglove.publish-end",Z),()=>{u?.publishClickTool.removeEventListener("foxglove.publish-start",C),u?.publishClickTool.removeEventListener("foxglove.publish-submit",ee),u?.publishClickTool.removeEventListener("foxglove.publish-end",Z)}},[e,Pi,Ke,u?.renderFrameId,u?.publishClickTool]);const Ng=(0,S.useCallback)(()=>{Ai?u?.publishClickTool.stop():(u?.publishClickTool.start(),u?.measurementTool.stopMeasuring())},[Ai,u]),Ar=(0,S.useCallback)(()=>{const C=u?.getCameraState().perspective??!1;Di({action:"update",payload:{input:"boolean",path:["cameraState","perspective"],value:!C}})},[Di,u]),Og=(0,S.useCallback)(C=>{C.key==="3"&&(Ar(),C.stopPropagation(),C.preventDefault())},[Ar]),Fg=e.dataSourceProfile==="ros1"||e.dataSourceProfile==="ros2",Ug=e.publish!=null&&Fg;return(0,y.jsx)(H.Z,{isDark:b==="dark",children:(0,y.jsxs)("div",{style:yg,onKeyDown:Og,children:[(0,y.jsx)("canvas",{ref:f,style:{position:"absolute",top:0,left:0,...(Ei||Ai)&&{cursor:"crosshair"}}}),(0,y.jsx)(Se.Provider,{value:u,children:(0,y.jsx)(vg,{interfaceMode:t,canvas:h,addPanel:Lg,enableStats:r.scene.enableStats??!1,perspective:r.cameraState.perspective,onTogglePerspective:Ar,measureActive:Ei,onClickMeasure:Rg,canPublish:Ug,publishActive:Ai,onClickPublish:Ng,publishClickType:u?.publishClickTool.publishClickType??"point",onChangePublishClickType:C=>{u?.publishClickTool.setPublishClickType(C),u?.publishClickTool.start()},timezone:_})})]})})}function Ol(s){if(s)for(const e of s){const t=e.message;"toJSON"in t&&(e.message=t.toJSON())}}function Sg(s,e,t){return Te.render((0,y.jsx)(S.StrictMode,{children:(0,y.jsx)(Je.o,{onError:s,children:(0,y.jsx)(Tg,{context:t,interfaceMode:e})})}),t.panelElement),()=>{Te.unmountComponentAtNode(t.panelElement)}}function Fl(s,e){const t=(0,mt.iY)(),i=(0,S.useMemo)(()=>Sg.bind(void 0,t,s),[t,s]);return(0,y.jsx)(Qe._,{config:e.config,saveConfig:e.saveConfig,initPanel:i})}const _g=(0,Re.Z)(Object.assign(Fl.bind(void 0,"3d"),{panelType:"3D",defaultConfig:{}})),xg=(0,Re.Z)(Object.assign(Fl.bind(void 0,"image"),{panelType:"Image",defaultConfig:{}}))},84803:(Ns,Xe,v)=>{v.d(Xe,{D:()=>qe});var y=v(52322),S=v(1547),Te=v(667),mt=v(60351),Je=v(85091),Re=v(96995);const Qe=new Re._fP,je=new Re.USm;function at(Ee,B,F,w){return Qe.set(Ee,B,F,w),je.setFromQuaternion(Qe,"XYZ"),[Re.M8C.radToDeg(je.x),Re.M8C.radToDeg(je.y),Re.M8C.radToDeg(je.z)]}const ot=20*365*24*60*60,Ne=["string","number","bigint","boolean"];function qe(Ee,B,F,w,z,I){if(typeof B!="object"||B==null)return(0,y.jsxs)("span",{children:[F," ",w]});const x=Object.keys(B);if(x.length===2){const{sec:M,nsec:D}=B;if(typeof M=="number"&&typeof D=="number")return M<ot?(0,Je.LU)({sec:M,nsec:D}):(0,y.jsx)("span",{children:(0,Je.WU)({sec:M,nsec:D},I)})}if(x.length===2){const{x:M,y:D}=B;if(typeof M=="number"&&typeof D=="number"){const k=Math.sqrt(M*M+D*D);return(0,y.jsxs)("span",{children:["norm = ",k.toFixed(2)," ",et(M,D)]})}}else if(x.length===3){const{x:M,y:D,z:k}=B;if(typeof M=="number"&&typeof D=="number"&&typeof k=="number"){const G=Math.sqrt(M*M+D*D+k*k);return(0,y.jsxs)("span",{children:["norm = ",G.toFixed(2)," ",k===0?et(M,D):void 0]})}}else if(x.length===4){const{x:M,y:D,z:k,w:G}=B;if(typeof M=="number"&&typeof D=="number"&&typeof k=="number"&&typeof G=="number"){const[Se,re,ne]=at(M,D,k,G);return(0,y.jsxs)("span",{children:["rpy = [",$e(Se),", ",$e(re),", ",$e(ne),"]"]})}const{r:X,g:H,b:le,a:we}=B;if(typeof X=="number"&&typeof H=="number"&&typeof le=="number"&&typeof we=="number")return(0,y.jsx)("span",{children:(0,S.Z)({r:X*255,g:H*255,b:le*255,a:we}).toHex8String()})}const m=(0,Te.DZ)(x,M=>{const D=B[M];if((0,mt.Q)(M)&&(D==null||Ne.includes(typeof D)))return`${M}: ${D}`}).join(", ");return(0,y.jsxs)("span",{children:[F," ",m.length>0?m:w]})}function et(Ee,B){if(!(Ee===0&&B===0))return(0,y.jsx)("span",{style:{transform:`rotate(${Math.atan2(-B,Ee)}rad)`,display:"inline-block"},children:"\u2192"})}function $e(Ee,B=2){return Number(Ee.toFixed(B))}}}]);

//# sourceMappingURL=5534.8c571a65b3f3c5eefbb1.js.map