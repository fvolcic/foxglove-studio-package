{"version":3,"file":"3218.80a12662c3d6d1ab7bd4.js","mappings":"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","sources":["webpack:///../../packages/studio-web/src/services/IdbLayoutStorage.ts","webpack:///../../packages/studio-web/src/services/LocalStorageAppConfiguration.ts","webpack:///../../packages/studio-web/src/Root.tsx"],"sourcesContent":["// This Source Code Form is subject to the terms of the Mozilla Public\n// License, v2.0. If a copy of the MPL was not distributed with this\n// file, You can obtain one at http://mozilla.org/MPL/2.0/\n\nimport * as IDB from \"idb/with-async-ittr\";\n\nimport Log from \"@foxglove/log\";\nimport { Layout, LayoutID, ILayoutStorage, migrateLayout } from \"@foxglove/studio-base\";\n\nconst log = Log.getLogger(__filename);\n\nconst DATABASE_NAME = \"foxglove-layouts\";\nconst OBJECT_STORE_NAME = \"layouts\";\n\ninterface LayoutsDB extends IDB.DBSchema {\n  layouts: {\n    key: [namespace: string, id: LayoutID];\n    value: {\n      namespace: string;\n      layout: Layout;\n    };\n    indexes: {\n      namespace: string;\n    };\n  };\n}\n\n/**\n * Stores layouts in IndexedDB. All layouts are stored in one object store, with the primary key\n * being the tuple of [namespace, id].\n */\nexport class IdbLayoutStorage implements ILayoutStorage {\n  private _db = IDB.openDB<LayoutsDB>(DATABASE_NAME, 1, {\n    upgrade(db) {\n      const store = db.createObjectStore(OBJECT_STORE_NAME, {\n        keyPath: [\"namespace\", \"layout.id\"],\n      });\n      store.createIndex(\"namespace\", \"namespace\");\n    },\n  });\n\n  public async list(namespace: string): Promise<readonly Layout[]> {\n    const results: Layout[] = [];\n    const records = await (\n      await this._db\n    ).getAllFromIndex(OBJECT_STORE_NAME, \"namespace\", namespace);\n    for (const record of records) {\n      try {\n        results.push(migrateLayout(record.layout));\n      } catch (err) {\n        log.error(err);\n      }\n    }\n    return results;\n  }\n\n  public async get(namespace: string, id: LayoutID): Promise<Layout | undefined> {\n    const record = await (await this._db).get(OBJECT_STORE_NAME, [namespace, id]);\n    return record == undefined ? undefined : migrateLayout(record.layout);\n  }\n\n  public async put(namespace: string, layout: Layout): Promise<Layout> {\n    await (await this._db).put(OBJECT_STORE_NAME, { namespace, layout });\n    return layout;\n  }\n\n  public async delete(namespace: string, id: LayoutID): Promise<void> {\n    await (await this._db).delete(OBJECT_STORE_NAME, [namespace, id]);\n  }\n\n  public async importLayouts({\n    fromNamespace,\n    toNamespace,\n  }: {\n    fromNamespace: string;\n    toNamespace: string;\n  }): Promise<void> {\n    const tx = (await this._db).transaction(\"layouts\", \"readwrite\");\n    const store = tx.objectStore(\"layouts\");\n\n    try {\n      for await (const cursor of store.index(\"namespace\").iterate(fromNamespace)) {\n        await store.put({ namespace: toNamespace, layout: cursor.value.layout });\n        await cursor.delete();\n      }\n      await tx.done;\n    } catch (error) {\n      log.error(error);\n    }\n  }\n\n  public async migrateUnnamespacedLayouts(namespace: string): Promise<void> {\n    await this._migrateFromLocalStorage();\n\n    // At the time IdbLayoutStorage was created, all layouts were already namespaced, so there are\n    // no un-namespaced layouts to migrate.\n    void namespace;\n  }\n\n  /**\n   * Prior implementation (LocalStorageLayoutStorage) stored layouts in localStorage under a key\n   * prefix. This approach was abandoned due to small capacity constraints on localStorage.\n   * https://github.com/foxglove/studio/issues/3100\n   */\n  private async _migrateFromLocalStorage() {\n    const legacyLocalStorageKeyPrefix = \"studio.layouts\";\n    const keysToMigrate: string[] = [];\n    for (let i = 0; i < localStorage.length; i++) {\n      const key = localStorage.key(i);\n      if (key?.startsWith(`${legacyLocalStorageKeyPrefix}.`) === true) {\n        keysToMigrate.push(key);\n      }\n    }\n\n    for (const key of keysToMigrate) {\n      const layoutJson = localStorage.getItem(key);\n      if (layoutJson == undefined) {\n        continue;\n      }\n      try {\n        const layout = migrateLayout(JSON.parse(layoutJson));\n        const [_prefix1, _prefix2, namespace, id] = key.split(\".\");\n        if (namespace == undefined || id == undefined || id !== layout.id) {\n          log.error(`Failed to migrate ${key} from localStorage`);\n          continue;\n        }\n        // use a separate transaction per item so we can be sure it is safe to delete from localStorage\n        await (await this._db).put(\"layouts\", { namespace, layout });\n        localStorage.removeItem(key);\n      } catch (err) {\n        log.error(err);\n      }\n    }\n  }\n}\n","// This Source Code Form is subject to the terms of the Mozilla Public\n// License, v2.0. If a copy of the MPL was not distributed with this\n// file, You can obtain one at http://mozilla.org/MPL/2.0/\n\nimport { IAppConfiguration, ChangeHandler, AppConfigurationValue } from \"@foxglove/studio-base\";\n\nexport default class LocalStorageAppConfiguration implements IAppConfiguration {\n  private static KEY_PREFIX = \"studio.app-configuration.\";\n\n  /** Default values for app configuration items which have never been set by a user */\n  private defaults?: { [key: string]: AppConfigurationValue };\n\n  private changeListeners = new Map<string, Set<ChangeHandler>>();\n\n  public constructor({ defaults }: { defaults?: { [key: string]: AppConfigurationValue } }) {\n    this.defaults = defaults;\n  }\n\n  public get(key: string): AppConfigurationValue {\n    const value = localStorage.getItem(LocalStorageAppConfiguration.KEY_PREFIX + key);\n    try {\n      return value == undefined ? this.defaults?.[key] : JSON.parse(value);\n    } catch {\n      return undefined;\n    }\n  }\n  public async set(key: string, value: AppConfigurationValue): Promise<void> {\n    if (value == undefined) {\n      localStorage.removeItem(LocalStorageAppConfiguration.KEY_PREFIX + key);\n    } else {\n      localStorage.setItem(\n        LocalStorageAppConfiguration.KEY_PREFIX + key,\n        JSON.stringify(value) ?? \"\",\n      );\n    }\n    const listeners = this.changeListeners.get(key);\n    if (listeners) {\n      // Copy the list of listeners to protect against mutation during iteration\n      [...listeners].forEach((listener) => listener(value));\n    }\n  }\n\n  public addChangeListener(key: string, cb: ChangeHandler): void {\n    let listeners = this.changeListeners.get(key);\n    if (!listeners) {\n      listeners = new Set();\n      this.changeListeners.set(key, listeners);\n    }\n    listeners.add(cb);\n  }\n\n  public removeChangeListener(key: string, cb: ChangeHandler): void {\n    const listeners = this.changeListeners.get(key);\n    if (listeners) {\n      listeners.delete(cb);\n    }\n  }\n}\n","// This Source Code Form is subject to the terms of the Mozilla Public\n// License, v2.0. If a copy of the MPL was not distributed with this\n// file, You can obtain one at http://mozilla.org/MPL/2.0/\n\nimport { useMemo, useState } from \"react\";\n\nimport {\n  IDataSourceFactory,\n  Ros1LocalBagDataSourceFactory,\n  Ros2LocalBagDataSourceFactory,\n  RosbridgeDataSourceFactory,\n  RemoteDataSourceFactory,\n  FoxgloveWebSocketDataSourceFactory,\n  UlogLocalDataSourceFactory,\n  McapLocalDataSourceFactory,\n  SampleNuscenesDataSourceFactory,\n  IdbExtensionLoader,\n  App,\n  AppSetting,\n} from \"@foxglove/studio-base\";\n\nimport { IdbLayoutStorage } from \"./services/IdbLayoutStorage\";\nimport LocalStorageAppConfiguration from \"./services/LocalStorageAppConfiguration\";\n\nconst isDevelopment = process.env.NODE_ENV === \"development\";\n\nexport function Root(props: {\n  extraProviders: JSX.Element[] | undefined;\n  dataSources: IDataSourceFactory[] | undefined;\n}): JSX.Element {\n  const appConfiguration = useMemo(\n    () =>\n      new LocalStorageAppConfiguration({\n        defaults: {\n          [AppSetting.SHOW_DEBUG_PANELS]: isDevelopment,\n        },\n      }),\n    [],\n  );\n  const layoutStorage = useMemo(() => new IdbLayoutStorage(), []);\n  const [extensionLoaders] = useState(() => [\n    new IdbExtensionLoader(\"org\"),\n    new IdbExtensionLoader(\"local\"),\n  ]);\n\n  const dataSources = useMemo(() => {\n    const sources = [\n      new Ros1LocalBagDataSourceFactory(),\n      new Ros2LocalBagDataSourceFactory(),\n      new FoxgloveWebSocketDataSourceFactory(),\n      new RosbridgeDataSourceFactory(),\n      new UlogLocalDataSourceFactory(),\n      new SampleNuscenesDataSourceFactory(),\n      new McapLocalDataSourceFactory(),\n      new RemoteDataSourceFactory(),\n    ];\n\n    return props.dataSources ?? sources;\n  }, [props.dataSources]);\n\n  return (\n    <>\n      <App\n        enableLaunchPreferenceScreen\n        deepLinks={[window.location.href]}\n        dataSources={dataSources}\n        appConfiguration={appConfiguration}\n        layoutStorage={layoutStorage}\n        extensionLoaders={extensionLoaders}\n        enableGlobalCss\n        extraProviders={props.extraProviders}\n      />\n    </>\n  );\n}\n"],"names":["log","DATABASE_NAME","OBJECT_STORE_NAME","IdbLayoutStorage","db","namespace","results","records","record","err","id","layout","fromNamespace","toNamespace","tx","store","cursor","error","legacyLocalStorageKeyPrefix","keysToMigrate","i","key","layoutJson","_prefix1","_prefix2","LocalStorageAppConfiguration","defaults","value","listeners","listener","cb","isDevelopment","Root","props","appConfiguration","layoutStorage","extensionLoaders","dataSources","sources"],"sourceRoot":""}